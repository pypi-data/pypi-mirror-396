
default:
  image: python:3.9
  cache:                      # Pip's cache doesn't store the python packages
    paths:                    # https://pip.pypa.io/en/stable/topics/caching/
      - .cache/pip
  before_script:
    - python --version         # Print out python version for debugging
    - python3 -m venv .venv
    - source .venv/bin/activate

stages:
  - build
  - test
  - publish

variables:  # Change pip's cache directory to be inside the project directory because GitLab can only cache local items.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

build:
  stage: build
  script:
    - pip install -U pip
    - pip install '.[dist]'
    - python -m build --sdist
    - python -m build --wheel
  artifacts:
    paths:
      - dist

test:
  stage: test
  script:
    - pip install pytest
    - pip install dist/*.whl
    - pytest

.release-base:
  stage: publish
  id_tokens:
    PYPI_ID_TOKEN:
      aud: '$PYPI_OIDC_AUD'
  script:
    - >-
      resp="$(curl -X POST "${PYPI_OIDC_URL}" -d "{\"token\":\"${PYPI_ID_TOKEN}\"}")"
    # Parse the response and extract the token
    - >-
      publish_token="$(python -c "import json; print(json.loads('${resp}')['token'])")"
    # Upload the files from "dist/"
    - pip install twine
    - >-
      python3 -m twine upload --non-interactive --repository "${PYPI_OIDC_AUD}" --username "__token__" --password "${publish_token}" dist/*
    # Print the link to PyPI so we can quickly go there to verify the result:
    - version="$(cat VERSION)"
    - echo -e "\033[34;1mPackage on PyPI:\033[0m ${CI_ENVIRONMENT_URL}${version}/"

release-test:
  extends: '.release-base'
  rules:
    # Only run if it's a pipeline for the default branch or a tag:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_TAG'
  environment:
    name: 'release-test'
    url: 'https://test.pypi.org/project/ouisparql/'
  variables:
    PYPI_OIDC_AUD: 'testpypi'
    PYPI_OIDC_URL: 'https://test.pypi.org/_/oidc/mint-token'

release:
  extends: '.release-base'
  rules:
    # Only run in tag pipelines:
    - if: '$CI_COMMIT_TAG'
  environment:
    name: 'release'
    url: 'https://pypi.org/project/ouisparql/'
  variables:
    PYPI_OIDC_AUD: 'pypi'
    PYPI_OIDC_URL: 'https://pypi.org/_/oidc/mint-token'

docs:
  stage: publish
  script:
    - pip install --upgrade pip
    - pip install '.[doc]'
    - sphinx-apidoc -f -o docs/source/pydoc ouisparql
    - sphinx-build -b html docs/source docs/build
  artifacts:
    paths:
      - ./docs/build/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  pages:
    publish: ./docs/build/
