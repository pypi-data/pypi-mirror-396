"use strict";(self.webpackChunkjupyter_deepagents=self.webpackChunkjupyter_deepagents||[]).push([[777],{777:(e,t,a)=>{a.r(t),a.d(t,{default:()=>y});var n=a(986),s=a(694),r=a(249),o=a(345),l=a.n(o),i=a(297),c=a(860);async function d(e="",t={}){const a=c.ServerConnection.makeSettings(),n=i.URLExt.join(a.baseUrl,"jupyter-deepagents",e);let s;try{s=await c.ServerConnection.makeRequest(n,t,a)}catch(e){throw new c.ServerConnection.NetworkError(e)}let r=await s.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new c.ServerConnection.ResponseError(s,r.message||r);return r}var m=a(630),p=a.n(m);const g=({shell:e,browserFactory:t})=>{const[a,n]=(0,o.useState)([]),[s,r]=(0,o.useState)(""),[i,c]=(0,o.useState)(!1),[m,g]=(0,o.useState)("unknown"),[u,h]=(0,o.useState)(()=>crypto.randomUUID()),[v,y]=(0,o.useState)(!1),f=(0,o.useRef)(null),E=(0,o.useRef)(null);(0,o.useEffect)(()=>{var e;null===(e=f.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[a]),(0,o.useEffect)(()=>{w()},[]);const w=async()=>{try{(await d("health",{method:"GET"})).agent_loaded?(g("healthy"),b("Agent is ready and connected")):(g("error"),b("Agent not loaded. Please ensure my_agent.py is configured correctly."))}catch(e){console.error("Error checking agent health:",e),g("error"),b("Failed to connect to agent service")}},b=e=>{const t={id:Date.now().toString(),role:"system",content:e,timestamp:new Date};n(e=>[...e,t])},N=()=>{const e=document.cookie.match("\\b_xsrf=([^;]*)\\b");return e?e[1]:""},S=async()=>{var a,o;if(!s.trim()||i)return;const l={id:Date.now().toString(),role:"user",content:s,timestamp:new Date};n(e=>[...e,l]);const d=s;r(""),c(!0);let m="",p="";if(t){const e=t.tracker.currentWidget;e&&(m=e.model.path)}if(e&&e.currentWidget){const t=e.currentWidget,n=t.title.label;(null===(a=t.context)||void 0===a?void 0:a.path)?p=t.context.path:"Launcher"===n?p="JupyterLab Launcher":n.startsWith("Terminal")?p=`Terminal: ${n}`:n&&(p=n)}console.log("Sending message with thread_id:",u),console.log("Current directory:",m),console.log("Focused widget:",p);const g=(Date.now()+1).toString();let h=[],v="",f=[];try{const e=N(),t=await fetch("/jupyter-deepagents/chat",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":e},body:JSON.stringify({message:d,stream:!0,thread_id:u,current_directory:m,focused_widget:p})});if(!t.body)throw new Error("No response body");const a=t.body.getReader(),s=new TextDecoder;for(;;){const{done:e,value:t}=await a.read();if(e)break;const r=s.decode(t).split("\n");for(const e of r)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Received SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{f.push({...e})}),t.chunk&&(h.push(t.chunk),v=t.chunk,console.log("Updated content:",v,"Intermediates:",h.length)),n(e=>e.find(e=>e.id===g)?e.map(e=>e.id===g?{...e,content:v,intermediates:[...h],toolCalls:f.length>0?[...f]:void 0}:e):[...e,{id:g,role:"assistant",content:v,timestamp:new Date,intermediates:[...h],toolCalls:f.length>0?[...f]:void 0}])):"interrupt"===t.status?(y(!0),n(e=>e.find(e=>e.id===g)?e.map(e=>e.id===g?{...e,interrupt:t.interrupt}:e):[...e,{id:g,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?(console.log("Stream complete. Final content:",v),n(e=>!e.find(e=>e.id===g)&&(v||f.length>0)?[...e,{id:g,role:"assistant",content:v,timestamp:new Date,intermediates:h.length>0?[...h]:void 0,toolCalls:f.length>0?[...f]:void 0}]:e)):"error"===t.status&&(console.error("Stream error:",t.error),n(e=>[...e,{id:g,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing SSE data:",e)}}}catch(e){console.error("Error sending message:",e);const t={id:g,role:"assistant",content:`Error: ${e instanceof Error?e.message:"Failed to send message"}`,timestamp:new Date,error:!0};n(e=>e.find(e=>e.id===g)?e.map(e=>e.id===g?t:e):[...e,t])}finally{c(!1),null===(o=E.current)||void 0===o||o.focus()}},k=async e=>{var t;y(!1),c(!0);try{const t=N(),a=await fetch("/jupyter-deepagents/resume",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":t},body:JSON.stringify({decisions:e,thread_id:u})});if(!a.body)throw new Error("No response body");const s=a.body.getReader(),r=new TextDecoder,o=(Date.now()+1).toString();let l=[],i="",c=[];for(;;){const{done:e,value:t}=await s.read();if(e)break;const a=r.decode(t).split("\n");for(const e of a)if(e.startsWith("data: "))try{const t=JSON.parse(e.slice(6));console.log("Resume SSE data:",t),"streaming"===t.status?(t.tool_calls&&t.tool_calls.forEach(e=>{c.push({...e})}),t.chunk&&(l.push(t.chunk),i=t.chunk),n(e=>e.find(e=>e.id===o)?e.map(e=>e.id===o?{...e,content:i,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0}:e):[...e,{id:o,role:"assistant",content:i,timestamp:new Date,intermediates:[...l],toolCalls:c.length>0?[...c]:void 0}])):"interrupt"===t.status?(y(!0),n(e=>e.find(e=>e.id===o)?e.map(e=>e.id===o?{...e,interrupt:t.interrupt}:e):[...e,{id:o,role:"assistant",content:"",timestamp:new Date,interrupt:t.interrupt}])):"complete"===t.status?console.log("Resume complete"):"error"===t.status&&(console.error("Resume error:",t.error),n(e=>[...e,{id:o,role:"assistant",content:t.error||"An error occurred",timestamp:new Date,error:!0}]))}catch(e){console.error("Error parsing resume SSE data:",e)}}}catch(e){console.error("Error resuming from interrupt:",e),b(`Error: ${e instanceof Error?e.message:"Failed to resume"}`)}finally{c(!1),null===(t=E.current)||void 0===t||t.focus()}};return l().createElement("div",{className:"deepagents-chat-container"},l().createElement("div",{className:"deepagents-chat-header"},l().createElement("h2",{className:"deepagents-chat-title"},"Deep Agents"),l().createElement("div",{className:"deepagents-chat-controls"},l().createElement("span",{className:`deepagents-status-indicator deepagents-status-${m}`,title:"healthy"===m?"Agent connected":"Agent not available"}),l().createElement("button",{className:"deepagents-icon-button",onClick:async()=>{c(!0);try{await d("reload",{method:"POST"}),b("Agent reloaded successfully"),await w()}catch(e){console.error("Error reloading agent:",e),b("Failed to reload agent")}finally{c(!1)}},disabled:i,title:"Reload agent"},"â†»"),l().createElement("button",{className:"deepagents-icon-button",onClick:()=>{n([]),h(crypto.randomUUID())},title:"Clear chat"},"ðŸ—‘"))),l().createElement("div",{className:"deepagents-chat-messages"},0===a.length?l().createElement("div",{className:"deepagents-chat-empty"},l().createElement("p",null,"Start a conversation with your agent")):a.map(e=>{var t,a,n,s,r,o,c;return l().createElement("div",{key:e.id,className:`deepagents-message deepagents-message-${e.role} ${e.error?"deepagents-message-error":""}`},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"user"===e.role?"You":"assistant"===e.role?"Agent":"System"),l().createElement("span",{className:"deepagents-message-time"},e.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),l().createElement("div",{className:"deepagents-message-content"},e.intermediates&&e.intermediates.length>1&&l().createElement("div",{className:"deepagents-message-intermediates"},e.intermediates.slice(0,-1).map((e,t)=>l().createElement("div",{key:t,className:"deepagents-intermediate-message"},e))),e.toolCalls&&e.toolCalls.length>0&&l().createElement("div",{className:"deepagents-tool-calls"},e.toolCalls.map((e,t)=>l().createElement("details",{key:t,className:"deepagents-tool-call"},l().createElement("summary",{className:"deepagents-tool-call-summary"},e.name),l().createElement("div",{className:"deepagents-tool-call-args"},((e,t=150)=>{const a={};for(const[n,s]of Object.entries(e)){const e=JSON.stringify(s);e.length>t?a[n]=e.substring(0,t)+"...":a[n]=s}return JSON.stringify(a)})(e.args))))),e.interrupt&&l().createElement("div",{className:"deepagents-interrupt"},l().createElement("div",{className:"deepagents-interrupt-header"},"Human approval required"),l().createElement("div",{className:"deepagents-interrupt-description"},"Tool: ",l().createElement("strong",null,null===(t=e.interrupt.action_requests[0])||void 0===t?void 0:t.tool)),l().createElement("div",{className:"deepagents-action-decisions"},(null===(n=null===(a=e.interrupt)||void 0===a?void 0:a.review_configs[0])||void 0===n?void 0:n.allowed_decisions.includes("approve"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-approve-btn",onClick:()=>{k([{type:"approve"}])},disabled:!v||i},"Approve"),(null===(r=null===(s=e.interrupt)||void 0===s?void 0:s.review_configs[0])||void 0===r?void 0:r.allowed_decisions.includes("reject"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-reject-btn",onClick:()=>{k([{type:"reject"}])},disabled:!v||i},"Reject"),(null===(c=null===(o=e.interrupt)||void 0===o?void 0:o.review_configs[0])||void 0===c?void 0:c.allowed_decisions.includes("edit"))&&l().createElement("button",{className:"deepagents-decision-btn deepagents-edit-btn",onClick:()=>{const t=prompt("Edit arguments (JSON):",JSON.stringify(e.interrupt.action_requests[0].args,null,2));if(t)try{const e=JSON.parse(t);k([{type:"edit",args:e}])}catch(e){alert("Invalid JSON")}},disabled:!v||i},"Edit"))),"assistant"===e.role?l().createElement(p(),null,e.content):e.content))}),i&&l().createElement("div",{className:"deepagents-message deepagents-message-assistant"},l().createElement("div",{className:"deepagents-message-header"},l().createElement("span",{className:"deepagents-message-role"},"Agent")),l().createElement("div",{className:"deepagents-message-content deepagents-typing-indicator"},l().createElement("span",null),l().createElement("span",null),l().createElement("span",null))),l().createElement("div",{ref:f})),l().createElement("div",{className:"deepagents-chat-input-container"},l().createElement("input",{ref:E,type:"text",className:"deepagents-chat-input",placeholder:"Type your message...",value:s,onChange:e=>r(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),S())},disabled:i}),l().createElement("button",{className:"deepagents-send-button",onClick:S,disabled:!s.trim()||i,title:"Send message"},"â†‘")))};class u extends n.ReactWidget{constructor(e=null,t=null){super(),this.addClass("deepagents-chat-widget"),this.shell=e,this.browserFactory=t}render(){return l().createElement(g,{shell:this.shell,browserFactory:this.browserFactory})}}const h=new s.LabIcon({name:"deepagents:chat",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>'});var v;!function(e){e.openChat="deepagents:open-chat"}(v||(v={}));const y={id:"jupyter-deepagents:plugin",description:"A JupyterLab extension for DeepAgents chat interface",autoStart:!0,optional:[n.ICommandPalette,r.IFileBrowserFactory],activate:(e,t,a)=>{console.log("JupyterLab extension jupyter-deepagents is activated!");const n=new u(e.shell,a);n.id="deepagents-chat",n.title.label="Deep Agents",n.title.icon=h,n.title.closable=!0,e.shell.add(n,"right",{rank:500}),e.commands.addCommand(v.openChat,{label:"Deep Agents",caption:"Open DeepAgents chat interface",icon:h,execute:()=>{n.isAttached||e.shell.add(n,"right",{rank:500}),e.shell.activateById(n.id)}}),t&&t.addItem({command:v.openChat,category:"Deep Agents"}),console.log("DeepAgents chat interface ready")}}}}]);