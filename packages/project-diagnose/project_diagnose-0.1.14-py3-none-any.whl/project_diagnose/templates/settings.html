<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Diagnose</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>

<body>

<header>
    <a href="/" class="button back-btn">‚Üê –ù–∞–∑–∞–¥</a>
    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

    <label class="theme-switch">
        <input type="checkbox" id="themeToggle">
        <span class="switch-track">
            <span class="icon sun">‚òÄ</span>
            <span class="icon moon">üåô</span>
        </span>
    </label>
</header>


<section class="panel">
    <h2>–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h2>
    <div id="fileTree" class="file-tree"></div>
    <p style="font-size:12px; opacity:0.7;">
        –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Ñ–∞–π–ª—É –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—É—Ç—å –≤ include_files.
    </p>
</section>

<section class="panel">
    <h2>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è config.diagnose</h2>

    <div class="settings-grid">
        <div class="settings-card">
            <h3>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è</h3>
            <div class="list" id="include_ext_list"></div>
            <button class="small-btn" data-add="include_ext">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏</h3>
            <div class="list" id="exclude_dirs_list"></div>
            <button class="small-btn" data-add="exclude_dirs">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card">
            <h3>–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="exclude_files_list"></div>
            <button class="small-btn" data-add="exclude_files">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card">
            <h3>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã</h3>
            <div class="list" id="include_files_list"></div>
            <button class="small-btn" data-add="include_files">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>

        <div class="settings-card">
            <h3>–û—Å–æ–±—ã–µ JSON-—Ñ–∞–π–ª—ã</h3>
            <div class="list" id="special_json_list"></div>
            <button class="small-btn" data-add="special_json">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <button id="saveBtn" style="margin-top:15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <pre id="statusBlock"></pre>

</section>

<!-- –ü—Ä–æ–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Flask -->
<script>
    window.FILE_TREE = {{ tree | tojson }};
    window.CURRENT_CONFIG = {{ config | tojson }};
</script>

<script>
/* ---------- –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ ---------- */

function buildTree(parent, node, basePath = "") {
    for (const key in node) {
        if (key === "_files") {
            node["_files"].forEach(file => {
                const full = basePath ? `${basePath}/${file}` : file;

                const item = document.createElement("div");
                item.className = "file-item indent-file";
                item.dataset.path = full;
                item.textContent = "üìÑ " + file;

                parent.appendChild(item);
            });
            continue;
        }

        const folderPath = basePath ? `${basePath}/${key}` : key;

        const folder = document.createElement("div");
        folder.className = "file-item folder";
        folder.dataset.path = folderPath;
        folder.textContent = "üìÅ " + key;

        const children = document.createElement("div");
        children.className = "folder-children";
        children.style.display = "none";

        folder.addEventListener("click", () => {
            children.style.display = children.style.display === "none" ? "block" : "none";
        });

        parent.appendChild(folder);
        parent.appendChild(children);

        buildTree(children, node[key], folderPath);
    }
}

const treeContainer = document.getElementById("fileTree");
buildTree(treeContainer, window.FILE_TREE);

/* –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—É—Ç—å */

treeContainer.addEventListener("dblclick", e => {
    const item = e.target.closest(".file-item");
    if (!item) return;

    document
        .getElementById("include_files_list")
        .appendChild(createRow("include_files", item.dataset.path));
});
</script>

<script>
/* ---------- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∫–∏ ---------- */

function createRow(fieldName, value = "") {
    const row = document.createElement("div");
    row.className = "item-row";

    const input = document.createElement("input");
    input.value = value;

    const delBtn = document.createElement("button");
    delBtn.className = "small-btn";
    delBtn.textContent = "‚úï";
    delBtn.onclick = () => row.remove();

    row.appendChild(input);
    row.appendChild(delBtn);
    return row;
}

function initList(field) {
    const container = document.getElementById(field + "_list");
    container.innerHTML = "";
    (window.CURRENT_CONFIG[field] || []).forEach(v =>
        container.appendChild(createRow(field, v))
    );
}

["include_ext","exclude_dirs","exclude_files","include_files","special_json"].forEach(initList);

document.querySelectorAll("[data-add]").forEach(btn => {
    btn.addEventListener("click", () => {
        const field = btn.dataset.add;
        document.getElementById(field + "_list")
            .appendChild(createRow(field, ""));
    });
});
</script>

<script>
/* ---------- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ---------- */

document.getElementById("saveBtn").addEventListener("click", () => {
    const fields = ["include_ext","exclude_dirs","exclude_files","include_files","special_json"];
    const cfg = {};

    fields.forEach(field => {
        cfg[field] = Array.from(document.querySelectorAll(`#${field}_list input`))
            .map(i => i.value.trim())
            .filter(v => v);
    });

    fetch("/save_settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ config: cfg }),
    })
    .then(r => r.json())
    .then(data => {
        const status = document.getElementById("statusBlock");
        status.textContent =
            data.status === "ok"
                ? "‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."
                : "–û—à–∏–±–∫–∞:\n" + data.message;
    });
});
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
