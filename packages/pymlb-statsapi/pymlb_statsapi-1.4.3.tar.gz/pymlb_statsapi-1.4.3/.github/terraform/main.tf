terraform {
  required_version = ">= 1.5.0"

  # Backend configuration is generated by setup.sh
  # Creates backend.tf with your S3 settings
  # Run: ./setup.sh to configure

  required_providers {
    github = {
      source  = "integrations/github"
      version = "~> 6.0"
    }
  }
}

provider "github" {
  owner = var.github_owner
  # Token should be set via GITHUB_TOKEN environment variable
}

# Repository - fully managed by Terraform
resource "github_repository" "repo" {
  name        = var.github_repository
  description = "A clean, Pythonic wrapper for MLB Stats API with automatic schema-driven parameter validation"

  homepage_url = "https://pymlb-statsapi.readthedocs.io/"

  visibility = "public"

  has_issues      = true
  has_discussions = true
  has_projects    = true
  has_wiki        = true

  # Enable vulnerability alerts and automated security fixes
  vulnerability_alerts   = true
  delete_branch_on_merge = true

  # Allow squash merging (recommended for feature branches)
  allow_squash_merge = true
  allow_merge_commit = true
  allow_rebase_merge = true

  # Topics/tags for discoverability
  topics = [
    "mlb",
    "baseball",
    "stats",
    "api",
    "python",
    "sports",
    "statsapi",
    "python3",
    "schema-driven",
    "mlb-stats",
    "baseball-data",
    "sports-data",
  ]

  # Auto-initialize with README
  auto_init = true

  lifecycle {
    prevent_destroy = true
  }
}

# Set default branch to main
resource "github_branch_default" "default" {
  repository = github_repository.repo.name
  branch     = "main"
}

# Branch protection for main (production)
resource "github_branch_protection" "main" {
  repository_id = github_repository.repo.node_id
  pattern       = "main"

  enforce_admins                  = false # Allow admins to bypass in emergencies
  require_signed_commits          = false
  required_linear_history         = false
  require_conversation_resolution = true

  # Require pull request reviews
  required_pull_request_reviews {
    dismiss_stale_reviews           = true
    require_code_owner_reviews      = true  # Require CODEOWNERS approval
    required_approving_review_count = 1
    restrict_dismissals             = false
  }

  # Require status checks to pass
  required_status_checks {
    strict = true # Require branches to be up to date before merging
    contexts = [
      "test (ubuntu-latest, 3.10)",
      "test (ubuntu-latest, 3.11)",
      "test (ubuntu-latest, 3.12)",
      "test (ubuntu-latest, 3.13)",
      "test (macos-latest, 3.10)",
      "test (macos-latest, 3.11)",
      "test (macos-latest, 3.12)",
      "test (macos-latest, 3.13)",
      "build",
      "docs",
    ]
  }

  # Note: restrict_pushes is only available for organization repositories
  # For user repositories, protection is enforced through PR requirements

  allows_force_pushes = false
  allows_deletions    = false
}

# Issue labels for better organization
resource "github_issue_label" "bug" {
  repository  = github_repository.repo.name
  name        = "bug"
  color       = "d73a4a"
  description = "Something isn't working"
}

resource "github_issue_label" "enhancement" {
  repository  = github_repository.repo.name
  name        = "enhancement"
  color       = "a2eeef"
  description = "New feature or request"
}

resource "github_issue_label" "documentation" {
  repository  = github_repository.repo.name
  name        = "documentation"
  color       = "0075ca"
  description = "Improvements or additions to documentation"
}

resource "github_issue_label" "good_first_issue" {
  repository  = github_repository.repo.name
  name        = "good first issue"
  color       = "7057ff"
  description = "Good for newcomers"
}

resource "github_issue_label" "help_wanted" {
  repository  = github_repository.repo.name
  name        = "help wanted"
  color       = "008672"
  description = "Extra attention is needed"
}

resource "github_issue_label" "question" {
  repository  = github_repository.repo.name
  name        = "question"
  color       = "d876e3"
  description = "Further information is requested"
}

resource "github_issue_label" "wontfix" {
  repository  = github_repository.repo.name
  name        = "wontfix"
  color       = "ffffff"
  description = "This will not be worked on"
}

resource "github_issue_label" "duplicate" {
  repository  = github_repository.repo.name
  name        = "duplicate"
  color       = "cfd3d7"
  description = "This issue or pull request already exists"
}

resource "github_issue_label" "tests" {
  repository  = github_repository.repo.name
  name        = "tests"
  color       = "fbca04"
  description = "Related to testing"
}

resource "github_issue_label" "ci_cd" {
  repository  = github_repository.repo.name
  name        = "ci/cd"
  color       = "c5def5"
  description = "Related to continuous integration or deployment"
}

# GitHub Environments for deployment workflows
resource "github_repository_environment" "pypi" {
  repository  = github_repository.repo.name
  environment = "pypi"

  # Allow custom branch policies - this permits tags to deploy
  # Tags trigger production PyPI releases
  deployment_branch_policy {
    protected_branches     = false
    custom_branch_policies = true
  }
}

resource "github_repository_environment" "testpypi" {
  repository  = github_repository.repo.name
  environment = "testpypi"

  # No approval needed for test releases
  deployment_branch_policy {
    protected_branches     = false
    custom_branch_policies = true
  }
}

# CODEOWNERS file for automatic review requests
# Dynamically generated from collaborators.yaml
resource "github_repository_file" "codeowners" {
  repository          = github_repository.repo.name
  branch              = "main"
  file                = ".github/CODEOWNERS"
  commit_message      = "chore: manage CODEOWNERS via Terraform"
  commit_author       = "Nikolaus Schuetz"
  commit_email        = "nikolauspschuetz@gmail.com"
  overwrite_on_create = true

  content = local.codeowners_content

  depends_on = [github_repository_collaborator.collaborators]
}

# Outputs for documentation
output "repository" {
  value = {
    name           = github_repository.repo.name
    full_name      = github_repository.repo.full_name
    html_url       = github_repository.repo.html_url
    default_branch = github_branch_default.default.branch
    branches = {
      main = "protected, requires PR approval, all CI checks must pass"
    }
    codeowners_managed = "via Terraform"
    managed_by         = "Terraform with S3 backend"
  }
}
