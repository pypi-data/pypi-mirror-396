name: Release & Publish

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹ï¼ˆåˆ›å»º releaseï¼‰

jobs:
  release-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Install dependencies
        run: |
          uv sync --dev
          uv add --dev twine

      - name: Run code quality checks
        run: |
          uv run pre-commit run --all-files

      - name: Build package
        run: |
          uv build

      - name: Check package
        run: |
          uv run twine check dist/*

      - name: Generate release notes
        id: release_notes
        run: |
          if [ -f "CHANGELOG.md" ]; then
            # ä» CHANGELOG.md æå–æœ€æ–°ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
            # æŸ¥æ‰¾ä¸å½“å‰æ ‡ç­¾åŒ¹é…çš„ç‰ˆæœ¬å·éƒ¨åˆ†
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## TashanRAG v$VERSION" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            # æå–ä»ç‰ˆæœ¬æ ‡è®°åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡è®°ä¹‹é—´çš„å†…å®¹
            awk -v ver="$VERSION" '
              /^## / {
                if (found) exit;
                if ($0 ~ "v" ver) {
                  found=1;
                  next;
                }
              }
              found { print }
            ' CHANGELOG.md >> $GITHUB_OUTPUT 2>/dev/null || echo "æŸ¥çœ‹ CHANGELOG.md è·å–è¯¦ç»†æ›´æ–°ä¿¡æ¯" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### å®‰è£…æ–¹å¼" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo '```bash' >> $GITHUB_OUTPUT
            echo "pip install tashanrag==$VERSION" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## TashanRAG ${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "å‘å¸ƒç‰ˆæœ¬ ${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### å®‰è£…æ–¹å¼" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo '```bash' >> $GITHUB_OUTPUT
            echo "pip install tashanrag==${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            dist/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv run twine upload dist/*

      - name: Release Confirmation
        run: |
          echo "âœ… Release ${{ github.ref_name }} published successfully!"
          echo "ğŸ“¦ Package available on PyPI: https://pypi.org/project/ts-rag/"
          echo "ğŸš€ GitHub Release created: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
