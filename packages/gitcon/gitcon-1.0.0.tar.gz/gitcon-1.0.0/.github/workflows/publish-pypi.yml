name: Publish to PyPI (stable only)

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/gitcon/

    steps:
      - name: Checkout workflow_run commit and tags
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Fetch tags
        run: |
          set -euo pipefail
          git fetch --tags --force

      - name: Ensure this commit is tagged stable
        run: |
          set -euo pipefail
          if ! git rev-parse -q --verify stable >/dev/null; then
            echo "stable tag not found -> skipping."
            exit 1
          fi

          stable_commit="$(git rev-parse stable^{commit})"
          head_commit="$(git rev-parse HEAD)"

          if [[ "$stable_commit" != "$head_commit" ]]; then
            echo "Not a stable commit -> skipping."
            exit 1
          fi

      - name: Ensure a release tag vX.Y.Z exists on this commit (no prerelease)
        id: version
        shell: bash
        run: |
          set -euo pipefail

          tag="$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)"
          if [[ -z "$tag" ]]; then
            echo "No stable version tag (vX.Y.Z) on this commit -> refusing to publish."
            exit 1
          fi

          version="${tag#v}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

          echo "Using version: $version"

      - name: Set version in pyproject.toml to match tag
        shell: bash
        run: |
          set -euo pipefail
          version="${{ steps.version.outputs.version }}"

          # Replace the first occurrence of: version = "..."
          # (works even if you currently have 0.0.0)
          sed -i -E '0,/^version = ".*"/s//version = "'"$version"'"/' pyproject.toml

          echo "pyproject.toml version now:"
          grep -nE '^version = ' pyproject.toml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build distributions
        run: |
          python -m pip install --upgrade build
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
