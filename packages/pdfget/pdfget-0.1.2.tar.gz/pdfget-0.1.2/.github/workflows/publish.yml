name: Release & Publish

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾

permissions:
  contents: write  # å…è®¸åˆ›å»ºrelease

jobs:
  release-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.1

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install uv
      uses: astral-sh/setup-uv@v7.1.4

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run tests
      run: |
        uv run pytest tests/ -v --cov=src --cov-report=xml

    - name: Run code quality checks
      run: |
        uv run ruff check .
        uv run ruff format --check .
        uv run mypy src/

    - name: Build package
      run: |
        uv build

    - name: Check package
      run: |
        uv run twine check dist/*

    - name: Generate release notes
      id: release_notes
      run: |
        # ä»CHANGELOG.mdæå–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        python << 'EOF'
        import re

        with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
            content = f.read()

        # æŸ¥æ‰¾æœ€æ–°çš„ç‰ˆæœ¬ä¿¡æ¯
        version_match = re.search(r'^## \[([0-9.]+)\] - ([0-9-]+)', content, re.MULTILINE)
        if version_match:
            version = version_match.group(1)
            date = version_match.group(2)

            # æå–è¯¥ç‰ˆæœ¬çš„ä¸»è¦å†…å®¹
            version_start = version_match.start()
            next_version_match = re.search(r'\n## \[', content[version_start + 1:])
            if next_version_match:
                version_content = content[version_start:version_start + next_version_match.start()]
            else:
                version_content = content[version_start:]

            # æå–ä¸»è¦åŠŸèƒ½ç‚¹
            features = []
            lines = version_content.split('\n')
            for line in lines:
                if 'æ–°å¢åŠŸèƒ½' in line:
                    continue
                if line.startswith('- **') and ('ï¼š' in line or ':' in line):
                    features.append(line.strip())

            # è®¾ç½®è¾“å‡º
            print(f"::set-output name=version::{version}")
            print(f"::set-output name=date::{date}")
            print(f"::set-output name=features::{'\\n'.join(features[:8])}")  # é™åˆ¶æ˜¾ç¤ºæ•°é‡
        else:
            print("::set-output name=version::unknown")
            print("::set-output name=features::No release notes found")
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2.5.0
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ steps.release_notes.outputs.version }}
        body: |
          ğŸ‰ PDFGet ${{ steps.release_notes.outputs.version }} å‘å¸ƒï¼

          ## ğŸ“¦ å®‰è£…æ–¹æ³•
          ```bash
          pip install pdfget==${{ steps.release_notes.outputs.version }}
          # æˆ–ä½¿ç”¨uv
          uv add pdfget==${{ steps.release_notes.outputs.version }}
          ```

          ## ğŸš€ ä¸»è¦ç‰¹æ€§
          ${{ steps.release_notes.outputs.features }}

          ## ğŸ“– ä½¿ç”¨ç¤ºä¾‹
          ```bash
          # æœç´¢å¹¶ä¸‹è½½æ–‡çŒ®
          pdfget -s "machine learning" -l 20 -d -t 5

          # é«˜çº§æ£€ç´¢
          pdfget -s "cancer AND immunotherapy NOT review" -l 30

          # æ‰¹é‡ä¸‹è½½
          pdfget -i dois.csv -d -t 3
          ```

          ## ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

          ---

          ğŸ¤– è‡ªåŠ¨å‘å¸ƒäº ${{ steps.release_notes.outputs.date }}
        draft: false
        prerelease: false

    - name: Publish to PyPI
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        uv publish --token $PYPI_API_TOKEN

    - name: Release Confirmation
      if: success()
      run: |
        echo "âœ… Release ${{ steps.release_notes.outputs.version }} published successfully!"
        echo "ğŸ“¦ PyPI: https://pypi.org/project/pdfget/${{ steps.release_notes.outputs.version }}/"
        echo "ğŸ”— GitHub: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
