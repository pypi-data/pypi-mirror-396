# LocalStack-Ext project configuration
[build-system]
requires = ['setuptools>=64', 'wheel', 'plux>=1.12', "setuptools_scm>=8.1"]
build-backend = "setuptools.build_meta"

[project]
name = "localstack-ext"
authors = [
    { name = "LocalStack Team", email = "info@localstack.cloud" }
]
description = "Extensions for LocalStack"
requires-python = ">=3.9"
dependencies = [
    "click>=7.1",
    "cryptography",
    "packaging",
    "plux>=1.10.0",
    "localstack-core>=4.12.1.dev,<4.13",
    "pyotp>=2.9.0",
    "PyJWT[crypto]>=1.7.0",
    "requests>=2.20.0",
    "rich>=12.3.0",
    "python-dateutil>=2.8",
    "tabulate",
    "pyyaml>=5.1",
    # currently needed to load pro entrypoints, for the tree view
    "windows-curses;platform_system=='Windows'",
]
dynamic = ["version"]
license = "LicenseRef-All-Rights-Reserved"
classifiers = [
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.13",
    "Topic :: Internet",
    "Topic :: Software Development :: Testing",
    "Topic :: System :: Emulators",
]

[tool.setuptools_scm]
version_file = "localstack/pro/core/version.py"
search_parent_directories = "true"
# pypi (and our platform) does not support local versions:
# https://setuptools-scm.readthedocs.io/en/latest/usage/#default-versioning-scheme
local_scheme = "no-local-version"

[project.urls]
Homepage = "https://localstack.cloud"
Documentation = "https://docs.localstack.cloud"
Issues = "https://github.com/localstack/localstack/issues"

[project.optional-dependencies]
runtime = [
    "airspeed-ext>=0.6.9",
    "alembic>=1.16.0",
    "avro>=1.11.0",
    "botocore",
    "boto3",
    "aws-encryption-sdk>=3.1.0",
    "aws-json-term-matcher>=0.1.5",
    "aws-sam-translator>=1.105.0",
    "cachetools>=5.5.2",
    "cedarpy>=4.1.0",
    "distro",
    "docker>=7.1.0",
    "python-dxf>=12.1.1",
    "dulwich>=0.19.16",
    "fastavro>=1.12.0",
    "graphql-core>=3.0.3",
    "hypercorn>=0.14.4",
    "janus>=0.5.0",
    "javascript",
    "jinja2>=3.1.6",
    "jsonpatch>=1.32",
    "jsonpath-ng>=1.7.0",
    "jsonschema>=4.25.1",
    "confluent-kafka",
    "kubernetes>=21.7.0",
    "libvirt-python",
    "localstack-core[runtime]>=4.12.1.dev,<4.13",
    "localstack-py-avro-schema==3.9.9",
    "opentelemetry-api",
    "opentelemetry-sdk",
    "opentelemetry-propagator-aws-xray",
    "orjson",
    "paho-mqtt>=1.5",
    "parquet[snappy]>=1.3.1",
    "parse>=1.19.0",
    "pg8000>=1.10",
    "postgres>=2.2.2",
    "postgresql-proxy>=0.2.0",
    "trino>=0.328.0",
    "psutil>=7.1.0",
    "psycopg2-binary>=2.9.10",
    "pycdlib>=1.14.0",
    "pydantic>=2.11.9",
    "pyftpdlib>=1.5.6",
    # hive_pure_sasl extra is necessary for python3.11
    "pyhive[hive_pure_sasl]>=0.7.0",
    "pyiceberg>=0.9.0",
    # TODO remove pin once the pydantic pyiceberg incompatibility is resolved https://github.com/apache/iceberg-python/issues/2590
    "pydantic<2.12",
    # TODO remove this transitive dependency of pyhive[hive_pure_sasl] once extra detection works with latest setuptools
    "pyopenssl>=25.3.0",
    "pyparsing>=3.2.5",
    "pymysql",
    "mysql-replication",
    "readerwriterlock>=1.0.7",
    "redis>=5.0,<6.0",
    "rolo",
    "rsa>=4.0",
    "semver>=3.0.4",
    "setuptools",
    "sql-metadata>=2.6.0",
    "sqlglot[rs]",
    "srp-ext>=1.0.7.1",
    "sqlalchemy>=2.0.0",
    "testing.common.database>=1.1.0",
    "typing-extensions>=4.15.0",
    "urllib3>=2.5.0",
    "pycognito>=2024.5.1",
    # TODO: Upgrade websockets to v14, see https://websockets.readthedocs.io/en/stable/project/changelog.html#id4
    "websockets>=8.1,<14",
    "websocket-client>=1.8.0",
    "werkzeug>=3.1.3",
    "Whoosh>=2.7.4",
    "xmltodict>=1.0.2"
]

test = [
    # test always needs the runtime to be able to run the tests
    "localstack-ext[runtime]",
    # ASF codegen generates docs with pypandoc
    "pypandoc",
    # TODO fix issues with pytest-httpserver==1.1.2, remove upper boundary
    "pytest-httpserver>=1.0.1",
    "aiohttp",
    "async-timeout",
    "awsiotsdk",
    "awswrangler>=3.5.2",
    "aws_xray_sdk>=2.4.2",
    "coverage[toml]>=5.0.0",
    "deepdiff>=5.5.0",
    "deptry>=0.13.0",
    "dnslib>=0.9.10",
    "dnspython>=1.16.0",
    "gremlinpython<3.8.0",
    "jws>=0.1.3",
    "kafka-python",
    "localstack-core[test]>=4.12.1.dev,<4.13",
    "msal",
    "msal-extensions",
    "msrest",
    "neo4j",
    "nest-asyncio>=1.4.1",
    "paramiko",
    "portalocker",
    "pre-commit>=3.5.0",
    # pyarrow: writing parquet test files
    "pyarrow",
    "PyAthena[Pandas]",
    "pymongo",
    "pymssql>=2.2.8",
    "pytest-instafail>=0.4.2",
    "pytest-mock>=3.14.0",
    "uefivars>=1.2",
    "ruff>=0.1.0",
    "redshift_connector",
    "stomp.py>=8.0.1",
    "mysql-connector-python",
    "python-terraform",
    "aws-cdk-lib>=2.88.0",
    "aws_cdk.aws_neptune_alpha",
    "aws_cdk.aws_redshift_alpha",
    "awsiotsdk",
    "aws-cdk.aws-cognito-identitypool-alpha",
    "playwright",
    "pytest-playwright"
]

package = [
    "localstack-obfuscator>=0.3.0"
]

typehint = [
    # typehint extends the test dev experience, so it needs the test dependencies
    "localstack-ext[test]",
    "boto3-stubs[acm,amplify,apigateway,apigatewayv2,appconfig,appsync,athena,autoscaling,bedrock,bedrock-runtime,backup,batch,ce,cloudcontrol,cloudformation,cloudfront,cloudtrail,cloudwatch,codecommit,cognito-identity,cognito-idp,dms,docdb,dynamodb,dynamodbstreams,ec2,ecr,ecs,efs,eks,elasticache,elasticbeanstalk,elbv2,emr,emr-serverless,es,events,firehose,fis,glacier,glue,iam,iot,iot-data,iotanalytics,iotwireless,kafka,kinesis,kinesisanalytics,kinesisanalyticsv2,kms,lakeformation,lambda,logs,mediaconvert,mediastore,mq,mwaa,neptune,opensearch,organizations,pi,rds,rds-data,redshift,redshift-data,resource-groups,resourcegroupstaggingapi,route53,route53resolver,s3,s3control,s3tables,sagemaker,sagemaker-runtime,secretsmanager,serverlessrepo,servicediscovery,ses,sesv2,sns,sqs,ssm,sso-admin,stepfunctions,sts,timestream-query,timestream-write,transcribe,xray]"
]

[tool.setuptools]
include-package-data = false

[tool.setuptools.dynamic]
readme = { file = ["README.md"], content-type = "text/markdown" }

[tool.setuptools.packages.find]
where = ["."]
include = ["*"]
exclude = ["tests*"]

[tool.setuptools.package-data]
"*" = [
    "*.md",
]
"localstack" = [
    "**/*.py.enc",
    "**/services/**/*.json",
    "**/services/lambda_/**/localstack_wrapper.sh",
    "**/services/lambda_/**/endpoint_injection/java/SdkV2DisableCertificateValidation.jar",
    "**/services/**/*.yml",
    "**/services/docdb/mongodb-resources/*",
    "**/openapi.yaml",
    "**/replicator/**.json",
    "**/appinspector/database/alembic.ini"
]

[tool.ruff]
# Extend the ruff config in the root dir
extend = "../ruff.toml"
# Generate code compatible with version defined in .python-version
target-version = "py313"
line-length = 100
src = ["tests", "localstack"]
exclude = [
    ".venv*",
    "venv*",
    "dist",
    "build",
    "target",
    "*.egg-info",
    ".filesystem",
    ".git",
    "**/version.py",
]

[tool.ruff.per-file-target-version]
# Only allow minimum version for code used in the CLI
"localstack/pro/core/cli/**" = "py310"
"localstack/pro/core/bootstrap/**" = "py310"

[tool.ruff.lint]
extend-safe-fixes = [
    "UP006", # unsafe-fix for py39
    "UP035", # unsafe-fix for py39
]

[tool.ruff.lint.pyupgrade]
# Avoid PEP 604 rewrites (e.g. Union[str, int] -> str | int), even with the `from __future__ import annotations`
# import. It only affects py39 and can be removed after we drop it.
keep-runtime-typing = true

[tool.coverage.run]
relative_files = true
source = [
    "localstack/pro/core",
]
omit = [
    "*/aws/api/*"
]

[tool.coverage.paths]
source = [
    "localstack",
    "../.venv/**/site-packages"
]

[tool.coverage.report]
exclude_lines = [
    "if __name__ == .__main__.:",
    "raise NotImplemented.",
    "return NotImplemented",
    "def __repr__",
]

[tool.pytest.ini_options]
markers = [
    "aws_parity: test can be run standalone against AWS and has been validated before",
]
log_cli = false
log_level = "DEBUG"
log_cli_format = "%(asctime)s.%(msecs)03d %(levelname)5s --- [%(threadName)12s] %(name)-26s : %(message)s"
log_cli_date_format = "%Y-%m-%dT%H:%M:%S"

[tool.pip-tools]
# adding localstack-ext itself here because it is referenced in the pyproject.toml for stacking the extras
# adding localstack-core because we do not want to pin it in the requirements files
# pip, setuptools, and distribute are pip-tools defaults which need to be set again here
unsafe-package = ["localstack-ext", "localstack-core", "pip", "setuptools", "distribute"] # packages that should not be pinned

[tool.plux]
# Alembic requires Python scripts that cannot be imported outside their own loading mechanism, which reports an error
# when creating entrypoints.
# We are excluding the whole appinspector.database.alembic package
exclude = ["*.appinspector.database.alembic*"]

[tool.deptry]
known_first_party = [
    "localstack",
    "PySiddhi", # managed by localstack package manager
    "pyarrow", # managed by localstack package manager
    "cookiecutter", # manually throwing warning that cookiecutter is needed in extensions CLI
    "oras", # lazily installed if used and not yet installed
]
extend_exclude = [
    "localstack/pro/core/testing/**", # utilities for testing
]
pep621_dev_dependency_groups = ["typehint", "test", "package"]

[tool.deptry.package_module_name_map]
"localstack-ext" = ["localstack.pro.core"]

[tool.deptry.per_rule_ignores]
DEP002 = [
    "windows-curses", # needed on Windows platforms
]
DEP003 = [
    "moto", # directly depending on moto/moto-ext here will cause issues with dependency resolution
]
