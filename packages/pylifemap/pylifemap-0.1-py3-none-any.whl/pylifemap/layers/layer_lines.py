from typing import Literal

import pandas as pd
import polars as pl

from pylifemap.layers.base import LayersBase
from pylifemap.utils import MAX_HOVER_DATA_LEN, is_hex_color


class LayerLines(LayersBase):
    def layer_lines(
        self,
        data: pl.DataFrame | pd.DataFrame | None = None,
        *,
        taxid_col: str = "taxid",
        width: int | float | str = 3,
        width_range: tuple | list = (1, 30),
        color: str | None = None,
        scheme: str | None = None,
        linetype: Literal["solid", "dotted", "smalldash", "dashed"] = "solid",
        opacity: float = 0.8,
        popup: bool = True,
        popup_col: str | None = None,
        hover: bool | None = None,
        label: str | None = None,
        lazy: bool = False,
        lazy_zoom: int = 15,
        lazy_mode: Literal["self", "parent"] = "self",
    ) -> LayersBase:
        """
        Add a lines layer.

        This layer can be applied to data generated by [](`~pylifemap.aggregate_num`)
        or [](`~pylifemap.aggregate_count`).

        Parameters
        ----------
        data : pl.DataFrame | pd.DataFrame | None, optional
            Layer data. If not provided, use the base widget data.
        taxid_col : str, optional
            If `data` is provided, name of the `data` column with taxonomy ids, by default `"taxid"`
        width : int | float | str, optional
            If numeric, the fixed width of the lines. If a string, the name of a numerical DataFrame column
            to compute line width from.
        width_range : tuple | list, optional
            Min and max values for line widths, only used if width is a data column, by default (1, 30)
        color : str | None, optional
            Either the name of a numerical DataFrame column to determine line color, or a fixed CSS color for
            lines.
        scheme : str | None, optional
            Color scheme for lines color. It is the name of
            an [Observable Plot color scale](https://observablehq.com/plot/features/scales#color-scales).
        linetype: Literal['solid', 'dotted', 'smalldash', dashed'], optional
            Type of lines. Defaults to 'solid'.
        opacity : float
            Line opacity as a floating number between 0 and 1, by default 0.8
        popup : bool
            If True, display informations in a popup when a point is clicked,
            by default True
        popup_col : str | None
            Name of a data column containing custom popup content. By default None.
        hover : bool | None, optional
            If True, highlight points on mouse hovering. By default True if less than 10_000 data points,
            False otherwise.
        label : str | None, optional
            Legend title for this layer if `color` is defined. If `None`, the value
            of `color` is used.
        lazy : bool
            If True, points are displayed depending on the widget view. If False, all points are displayed.
            Can be useful when displaying a great number of items. Defaults to False.
        lazy_zoom : int
            If lazy true, only points with a zoom level less than (zoom + lazy_zoom) level will be
            displayed. Defaults to 15.
        lazy_mode : Literal["self", "parent"], optional
            If lazy is True, choose the zoom level to apply to each taxa. If "self", keep the taxa zoom
            level. If "parent", get the nearest ancestor zoom level. Defaults to "self".

        Returns
        -------
        Lifemap
            A Lifemap visualization object.

        Examples
        --------
        >>> import polars as pl
        >>> from pylifemap import Lifemap, aggregate_num
        >>> d = pl.DataFrame(
        ...     {
        ...         "taxid": [
        ...             9685,
        ...             9615,
        ...             9994,
        ...             2467430,
        ...             2514524,
        ...             2038938,
        ...             1021470,
        ...             1415565,
        ...             1928562,
        ...             1397240,
        ...             230741,
        ...         ],
        ...         "value": [7.4, 2.5, 8.3, 1.0, 1.4, 5.6, 4.6, 3.4, 2.3, 2.8, 3.1],
        ...     }
        ... )
        >>> d = aggregate_num(d, column="value", fn="mean")
        >>> Lifemap(d).layer_lines(width="value", color="value").show()


        See also
        --------
        [](`~pylifemap.aggregate_num`) : aggregation of a numeric variable.

        [](`~pylifemap.aggregate_count`) : aggregation of the number of observations.
        """
        options, df = self._process_options(locals())

        lazy_mode_values = ["self", "parent"]
        if options["lazy_mode"] not in lazy_mode_values:
            msg = f"lazy_mode must be one of {lazy_mode_values}"
            raise ValueError(msg)

        if options["hover"] is None:
            options["hover"] = len(df) < MAX_HOVER_DATA_LEN

        layer = {"layer": "lines", "options": options}
        self._layers.append(layer)

        data_columns = [
            options[k]
            for k in ("width", "color")
            if isinstance(options[k], str) and not is_hex_color(options[k])
        ]
        if popup_col is not None:
            data_columns.append(options["popup_col"])
        d = df.lines_data(data_columns, lazy_mode=lazy_mode)
        self._layers_data[options["id"]] = d

        # Compute color range
        key = options["color"]
        if key in data_columns:
            min_value = d.get_column(key).min()
            max_value = d.get_column(key).max()
            if key in self._color_ranges:
                self._color_ranges[key]["min"] = min(self._color_ranges[key]["min"], min_value)  # type: ignore
                self._color_ranges[key]["max"] = max(self._color_ranges[key]["max"], max_value)  # type: ignore
            else:
                self._color_ranges[key] = {"min": min_value, "max": max_value}

        return self
