name: Release Crate

on:
    push:
        tags:
            - "*"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    publish:
        name: Publish to crates.io
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Rust and dependencies
              run: |
                  # Install Rust
                  curl https://sh.rustup.rs -sSf | sh -s -- -y
                  source $HOME/.cargo/env

                  # Add Windows target
                  rustup target add x86_64-pc-windows-gnu

                  # Install required packages
                  sudo apt-get update
                  sudo apt-get install -y --no-install-recommends \
                      mingw-w64 \
                      pkg-config \
                      build-essential \
                      git \
                      ca-certificates \
                      curl \
                      jq
                  sudo rm -rf /var/lib/apt/lists/*

            - name: Build crate
              run: cargo build --release --verbose

            - name: Run tests
              run: cargo test --release --verbose

            - name: Publish to crates.io
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish --verbose
