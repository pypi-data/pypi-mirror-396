name: Run Cargo Tests

on:
  workflow_dispatch:
  push:
    paths:
      - "src/**"
  pull_request:
    paths:
      - "src/**"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust and dependencies
        run: |
          # Install Rust
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source $HOME/.cargo/env

          # Add Windows target
          rustup target add x86_64-pc-windows-gnu

          # Install required packages
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            mingw-w64 \
            pkg-config \
            build-essential \
            git \
            ca-certificates \
            curl \
            jq
          sudo rm -rf /var/lib/apt/lists/*

      - name: Run tests Python feature
        run: cargo test --all --verbose

      - name: Run tests Windows mode
        run: cargo test --all --no-default-features --verbose
