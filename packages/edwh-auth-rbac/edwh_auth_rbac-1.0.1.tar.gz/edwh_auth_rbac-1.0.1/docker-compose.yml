version: "3.5"
networks:
  broker:
    name: broker
    external: true
  backend:
    name: ${PROJECT}_backend

services:
  migrate:
    restart: "no"
    image: remcoboerma/omgeving-migrate-edwh-auth-rbac:latest
    build:
      context: .
      dockerfile: migrate/Dockerfile
    depends_on:
      pg-0:
        condition: service_healthy
    extra_hosts:
      host.docker.internal: host-gateway
    environment:
      PYTHONIOENCODING: "UTF-8"
      PYTHONPATH: /pythonpath
      MIGRATIONS_FILE: "/pythonpath/src/edwh_auth_rbac/migrations.py"
      MIGRATE_URI: ${INSIDE_DOCKER_PG_DUMP_URI}
      FLAG_LOCATION: /tmp/flags
      CREATE_FLAG_LOCATION: 1
    volumes:
      - type: bind
        source: ./src
        target: /pythonpath/src
        read_only: true
      - type: bind
        source: ./migrate/data
        target: /data
    networks:
      - backend
    command: migrate
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "2"
    # no health check, should just create flag file

  pg-0: # Standalone PostgreSQL instance
    image: postgres:18
    restart: unless-stopped
    shm_size: '100MB'
    ports:
      - "${PGPOOL_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - POSTGRESQL_PGAUDIT_LOG=write,ddl
    networks:
      backend:
        aliases:
          - postgres
          - pgpool
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "2"
    healthcheck:
      test: pg_isready --dbname=$POSTGRES_DATABASE --username=$POSTGRES_USERNAME -h pg-0
      interval: 1m30s
      timeout: 60s
      retries: 5
      start_period: 80s
      start_interval: 10s

volumes:
  postgres_data:
    driver: local
