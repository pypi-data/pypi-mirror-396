image: python:3.11-slim

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  GIT_DEPTH: 0  # Fetch full git history including tags for hatch-vcs

cache:
  paths:
    - .cache/pip
    - .venv

stages:
  - lint
  - test
  - build
  - deploy

before_script:
  - apt-get update -qq && apt-get install -y -qq git  # Required for hatch-vcs
  - pip install uv
  - git fetch --tags  # Ensure tags are available for hatch-vcs
  - uv sync

lint:
  stage: lint
  script:
    - uv run ruff check .
    - uv run ruff format --check .
    - uv run mypy src/micropython_branch_manager

test:
  stage: test
  script:
    - uv run pytest tests/ -v --cov=micropython_branch_manager --cov-report=xml --cov-report=term
  coverage: '/TOTAL\s+\d+\s+\d+\s+(\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

build:
  stage: build
  script:
    - uv build
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz

deploy:
  stage: deploy
  dependencies:
    - build
  only:
    - tags
  script:
    - uv publish --username "$PYPI_USER" --password "$PYPI_PASS"
