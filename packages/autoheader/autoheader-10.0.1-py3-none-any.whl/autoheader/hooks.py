from pathlib import Path
import stat
import os
from . import ui

def install_native_hook(root: Path):
    """
    Installs a native git pre-commit hook that runs 'autoheader --check'.
    """
    git_dir = root / ".git"
    if not git_dir.exists():
        ui.console.print("[red].git directory not found. Is this a git repository?[/red]")
        return

    hooks_dir = git_dir / "hooks"
    if not hooks_dir.exists():
        hooks_dir.mkdir(parents=True, exist_ok=True)

    hook_path = hooks_dir / "pre-commit"
    if hook_path.exists():
        ui.console.print(f"[yellow]Hook already exists at {hook_path}. Skipping.[/yellow]")
        return

    hook_content = (
        "#!/bin/sh\n"
        "# Auto-generated by autoheader\n"
        "autoheader --check\n"
    )

    try:
        hook_path.write_text(hook_content, encoding="utf-8")
        # Make executable
        st = os.stat(hook_path)
        os.chmod(hook_path, st.st_mode | stat.S_IEXEC)

        ui.console.print(f"[green]âœ… Native git hook installed at {hook_path}[/green]")
    except Exception as e:
        ui.console.print(f"[red]Failed to install hook: {e}[/red]")
