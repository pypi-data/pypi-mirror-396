{
  "$id": "https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/schemas/core/cep.relationship.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CEP Relationship Record",
  "description": "Defines a verifiable legal or functional relationship between two or more attested entities. Supports bilateral contracts, n-ary memberships, fiscal sponsorships, and hierarchical compositions. CEP Relationships are designed to interoperate with existing open civic standards (Popolo Membership/Post, Open Civic Data organizations and jurisdictions, Open Contracting Data Standard awards/contracts, Schema.org Grant/MonetaryGrant, HSDS funding relationships) via recordTypeUri, roleUri, and sourceReferences.",
  "type": "object",
  "allOf": [
    {
      "$ref": "https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/schemas/core/cep.record-envelope.schema.json"
    },
    {
      "type": "object",
      "properties": {
        "recordKind": {
          "const": "relationship",
          "description": "Record kind discriminator for CEP Relationship records."
        },
        "recordSchemaUri": {
          "type": "string",
          "format": "uri",
          "const": "https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/schemas/core/cep.relationship.schema.json",
          "description": "URI of this relationship schema. Implementations MAY use this to route validation and builders."
        },
        "schemaVersion": {
          "type": "string",
          "const": "1.0.0",
          "description": "Version of this relationship schema. Implementations MUST reject records with unrecognized versions."
        },
        "recordTypeUri": {
          "type": "string",
          "format": "uri",
          "description": "URI referencing the relationship type in the CEP Relationship Type Vocabulary (for example, 'https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/vocabulary/relationship-type.json#prime-contract', '#grant-award', '#board-membership'). Relationship type terms are mapped to external vocabularies such as Popolo (Membership), Open Contracting Data Standard (Award, Contract), Schema.org (MonetaryGrant, subOrganization), HSDS, and FIBO through the vocabulary.mappings mechanism."
        },

        "bilateralParties": {
          "type": ["object", "null"],
          "description": "For two-party relationships with clear directionality (grantor–grantee, buyer–supplier, employer–employee). Use this OR multilateralMembers, not both.",
          "properties": {
            "partyA": {
              "type": "object",
              "description": "The initiating, granting, or contracting party (for example, the agency awarding a contract, the grantor, the employer). Semantically aligns with Popolo organization/person plus role, OCDS buyer, or Schema.org GovernmentOrganization.",
              "properties": {
                "entityId": {
                  "type": "string",
                  "description": "Verifiable ID of the Party A entity (CEP Entity verifiableId). This entity SHOULD carry external identifiers (for example, UEI, LEI, OCD IDs) in its identifiers block."
                },
                "roleUri": {
                  "type": "string",
                  "format": "uri",
                  "description": "URI specifying Party A's role in this relationship. Implementations SHOULD use a termUri from the CEP Party Role Vocabulary (for example, 'https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/vocabulary/party-role.json#grantor', '#buyer', '#employer', '#regulator')."
                }
              },
              "required": ["entityId", "roleUri"],
              "additionalProperties": false
            },
            "partyB": {
              "type": "object",
              "description": "The receiving, performing, or beneficiary party (for example, the contractor receiving an award, the grantee, the employee). Semantically aligns with Popolo Membership member, OCDS supplier, or Schema.org Organization/Person.",
              "properties": {
                "entityId": {
                  "type": "string",
                  "description": "Verifiable ID of the Party B entity (CEP Entity verifiableId)."
                },
                "roleUri": {
                  "type": "string",
                  "format": "uri",
                  "description": "URI specifying Party B's role in this relationship. Implementations SHOULD use a termUri from the CEP Party Role Vocabulary (for example, 'https://raw.githubusercontent.com/civic-interconnect/civic-interconnect/main/vocabulary/party-role.json#grantee', '#supplier', '#employee', '#regulated-entity')."
                }
              },
              "required": ["entityId", "roleUri"],
              "additionalProperties": false
            }
          },
          "required": ["partyA", "partyB"],
          "additionalProperties": false
        },

        "multilateralMembers": {
          "type": ["array", "null"],
          "description": "For n-ary relationships (consortia, boards, joint ventures, multi-party MOUs). Members are canonically sorted by entityId for hash stability. Semantically aligns with Popolo Membership graphs and Open Referral HSDS service-provider networks.",
          "items": {
            "type": "object",
            "properties": {
              "entityId": {
                "type": "string",
                "description": "Verifiable ID of the member entity (CEP Entity verifiableId)."
              },
              "roleUri": {
                "type": "string",
                "format": "uri",
                "description": "URI specifying this member's role in the relationship (for example, '#board-member', '#consortium-member', '#joint-venture-partner', '#fiscal-sponsor'). Implementations SHOULD use a termUri from the CEP Party Role Vocabulary."
              },
              "participationShare": {
                "type": ["number", "null"],
                "minimum": 0,
                "maximum": 1,
                "description": "Fractional participation (0.0-1.0) for ownership or cost-sharing arrangements (for example, equity shares in a joint venture or cost allocation in an interlocal agreement). When applicable, the sum across members SHOULD equal 1.0."
              }
            },
            "required": ["entityId", "roleUri"],
            "additionalProperties": false
          },
          "minItems": 2
        },

        "parentRelationshipId": {
          "type": ["string", "null"],
          "description": "Verifiable ID of the parent relationship. Used for subcontracts, task orders, amendments, subgrants, or derived agreements. Enables compositional provenance tracing of contractual trees and assistance hierarchies, and aligns with W3C PROV 'wasDerivedFrom' at the relationship level."
        },

        "effectiveTimestamp": {
          "type": "string",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\.[0-9]{6}Z$",
          "description": "ISO 8601 UTC timestamp with microsecond precision when this relationship became legally effective (for example, award date, contract signature date, board term start). Implementations MUST canonicalize to six fractional digits (pad or round) and UTC 'Z' for hash parity."
        },

        "expirationTimestamp": {
          "type": ["string", "null"],
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\.[0-9]{6}Z$",
          "description": "ISO 8601 UTC timestamp when this relationship legally expires or is scheduled to end (for example, contract end date, grant period end, board term end). Null for indefinite relationships."
        },

        "financialTerms": {
          "type": ["object", "null"],
          "description": "Financial parameters of the relationship, if applicable. Semantically aligned with Open Contracting Data Standard (OCDS) award/contract values and Schema.org MonetaryAmount/MonetaryGrant.",
          "properties": {
            "totalValue": {
              "type": ["number", "null"],
              "minimum": 0,
              "description": "Total monetary value of the relationship (for example, contract ceiling, grant award amount, loan principal)."
            },
            "obligatedValue": {
              "type": ["number", "null"],
              "minimum": 0,
              "description": "Currently obligated or committed amount under this relationship. For grants, this may reflect obligated funds within a larger authorization."
            },
            "currencyCode": {
              "type": "string",
              "pattern": "^[A-Z]{3}$",
              "default": "USD",
              "description": "ISO 4217 currency code for the amounts in this relationship."
            }
          },
          "additionalProperties": false
        },

        "termsAttributes": {
          "type": "object",
          "description": "Domain-specific terms as key-value pairs (for example, CFDA/Assistance Listing numbers, program codes, contract types, payment schedules, educational program descriptors). Keys are canonically sorted for hash stability. Implementations SHOULD document keys used in specific domains.",
          "additionalProperties": {
            "type": "string",
            "maxLength": 1024
          }
        },

        "jurisdictionIso": {
          "type": "string",
          "pattern": "^[A-Z]{2}(-[A-Z0-9]{1,3})?$",
          "description": "Primary jurisdiction governing this relationship (ISO 3166-1/2), such as the country and optionally subnational region whose law governs the contract, grant, or agreement (for example, 'US', 'US-MN'). For finer-grained political geography, corresponding Open Civic Data division and jurisdiction IDs SHOULD be attached to the participating entities via their identifiers.additionalSchemes."
        },

        "sourceReferences": {
          "type": "array",
          "description": "References to authoritative source records from which this relationship was derived. This is the primary way to link CEP Relationships to Open Civic Data (bills, votes, events), Popolo records, Open Contracting releases, campaign finance systems, state procurement portals, and other registries.",
          "items": {
            "type": "object",
            "properties": {
              "sourceSystemUri": {
                "type": "string",
                "format": "uri",
                "description": "URI identifying the source system or specification (for example, 'https://sources.civic-interconnect.org/usaspending', 'https://standard.open-contracting.org', 'https://opencivicdata.org/spec/bill', 'https://opencivicdata.org/spec/vote', 'https://github.com/openreferral/specification')."
              },
              "sourceRecordId": {
                "type": "string",
                "maxLength": 256,
                "description": "Original record identifier in the source system (for example, a USASpending award ID, OCD bill or vote ID, OCDS release/award/contract ID, or campaign finance filing ID)."
              },
              "sourceUrl": {
                "type": ["string", "null"],
                "format": "uri",
                "description": "Direct URL to the source record, if publicly accessible (for example, a USASpending award page, state open checkbook entry, legislative bill page, board agenda)."
              }
            },
            "required": ["sourceSystemUri", "sourceRecordId"],
            "additionalProperties": false
          }
        },

        "previousRecordHash": {
          "type": ["string", "null"],
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of the previous record for this relationship. Null for the initial record. Enables amendment chains and PROV-aligned 'wasRevisionOf' semantics for contracts, grants, and agreements over time."
        }
      },

      "required": [
        "recordKind",
        "recordSchemaUri",
        "schemaVersion",
        "recordTypeUri",
        "effectiveTimestamp",
        "jurisdictionIso"
      ],

      "oneOf": [
        {
          "properties": {
            "bilateralParties": { "type": "object" },
            "multilateralMembers": { "type": "null" }
          },
          "required": ["bilateralParties"]
        },
        {
          "properties": {
            "bilateralParties": { "type": "null" },
            "multilateralMembers": { "type": "array" }
          },
          "required": ["multilateralMembers"]
        }
      ],

      "additionalProperties": true
    }
  ]
}
