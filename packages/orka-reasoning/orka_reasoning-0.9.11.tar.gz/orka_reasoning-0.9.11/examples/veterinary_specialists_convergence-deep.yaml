orchestrator:
  id: veterinary_specialists_convergence_v2
  strategy: sequential
  agents:
    - patient_input_memory
    - specialists_loop
    - actionable_plan_builder
    - memory_writer
    - explanation_builder

agents:
  - id: patient_input_memory
    type: memory
    namespace: patient_cases
    config:
      operation: write
      memory_type: short_term
    prompt: |
      Store patient input: {{ get_input() }}

  - id: specialists_loop
    type: loop
    max_loops: 2
    scoring:
      preset: moderate
    stop_condition: "{{ get_agent_response('diagnosis_join').response.CONVERGENCE_SCORE >= 0.9 }}"
    internal_workflow:
      orchestrator:
        id: specialists-internal-v2
        strategy: sequential
        agents:
          - specialists_fork
          - diagnosis_join
          - convergence_scorer
      agents:
        - id: specialists_fork
          type: fork
          targets:
            - [internal_medicine_history, internal_medicine_diagnostics, internal_medicine_management]
            - [surgery_assessment, surgery_risk, surgery_plan]
            - [infectious_disease_screening, infectious_disease_tests, infectious_disease_plan]
            - [dermatology_history, dermatology_tests, dermatology_plan]

        # Internal Medicine Path
        - id: internal_medicine_history
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Act as a veterinary internal medicine specialist. Focus ONLY on collecting and interpreting the patient's history and clinical signs.
            Patient data: {{ get_input() }}
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Urinalysis: {{ get_input().test_results.urinalysis if get_input().test_results and get_input().test_results.urinalysis else "Non disponibile" }}
            Altri test: {{ get_input().test_results if get_input().test_results else "Nessun test disponibile" }}
            Output: HISTORY_SUMMARY: <summary>, KEY_CLINICAL_SIGNS: [<sign1>, <sign2>]

        - id: internal_medicine_diagnostics
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Based on the history and signs: {{ previous_outputs.internal_medicine_history }}, and available test results:
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Urinalysis: {{ get_input().test_results.urinalysis if get_input().test_results and get_input().test_results.urinalysis else "Non disponibile" }}
            Propose a prioritized diagnostic workup (tests, rationale, urgency).
            Output: DIAGNOSTIC_PLAN: [<test1>, <test2>], RATIONALE: <explanation>

        - id: internal_medicine_management
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Given diagnostics: {{ previous_outputs.internal_medicine_diagnostics }}, and all available test results:
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Urinalysis: {{ get_input().test_results.urinalysis if get_input().test_results and get_input().test_results.urinalysis else "Non disponibile" }}
            Suggest initial medical management and monitoring.
            Output: MANAGEMENT_PLAN: [<step1>, <step2>], MONITORING: <instructions>

        # Surgery Path
        - id: surgery_assessment
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Act as a veterinary surgeon. Assess for surgical/traumatic causes based on history: {{ get_input() }}.
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Radiographs: {{ get_input().test_results.radiographs if get_input().test_results and get_input().test_results.radiographs else "Non disponibili" }}
            Altri test: {{ get_input().test_results if get_input().test_results else "Nessun test disponibile" }}
            Output: SURGICAL_DIFFERENTIALS: [<dx1>, <dx2>], URGENCY: <score 0-1>

        - id: surgery_risk
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            For each differential: {{ previous_outputs.surgery_assessment }}, and available test results:
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Radiographs: {{ get_input().test_results.radiographs if get_input().test_results and get_input().test_results.radiographs else "Non disponibili" }}
            Evaluate surgical risk and perioperative considerations.
            Output: RISK_ASSESSMENT: <summary>, PRE_OP: <instructions>

        - id: surgery_plan
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Propose a surgical or non-surgical plan, including post-op care, based on risk: {{ previous_outputs.surgery_risk }}.
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Biochemistry: {{ get_input().test_results.biochemistry if get_input().test_results and get_input().test_results.biochemistry else "Non disponibile" }}
            Radiographs: {{ get_input().test_results.radiographs if get_input().test_results and get_input().test_results.radiographs else "Non disponibili" }}
            Output: SURGERY_PLAN: <plan>, POST_OP: <care>

        # Infectious Disease Path
        - id: infectious_disease_screening
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Act as an infectious disease specialist. List all possible infectious/parasitic causes and relevant risk factors.
            Patient data: {{ get_input() }}
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Serology: {{ get_input().test_results.serology if get_input().test_results and get_input().test_results.serology else "Non disponibile" }}
            Fecal tests: {{ get_input().test_results.fecal_tests if get_input().test_results and get_input().test_results.fecal_tests else "Non disponibili" }}
            Output: INFECTIOUS_DIFFERENTIALS: [<dx1>, <dx2>], RISK_FACTORS: [<factor1>]

        - id: infectious_disease_tests
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            For each differential: {{ previous_outputs.infectious_disease_screening }}, and available test results:
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Serology: {{ get_input().test_results.serology if get_input().test_results and get_input().test_results.serology else "Non disponibile" }}
            Fecal tests: {{ get_input().test_results.fecal_tests if get_input().test_results and get_input().test_results.fecal_tests else "Non disponibili" }}
            Recommend specific diagnostic tests and isolation protocols.
            Output: TESTS: [<test1>, <test2>], ISOLATION: <instructions>

        - id: infectious_disease_plan
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Based on test results and protocols: {{ previous_outputs.infectious_disease_tests }}, and all available test results:
            CBC: {{ get_input().test_results.cbc if get_input().test_results and get_input().test_results.cbc else "Non disponibile" }}
            Serology: {{ get_input().test_results.serology if get_input().test_results and get_input().test_results.serology else "Non disponibile" }}
            Fecal tests: {{ get_input().test_results.fecal_tests if get_input().test_results and get_input().test_results.fecal_tests else "Non disponibili" }}
            Suggest treatment and public health actions.
            Output: TREATMENT: <plan>, PUBLIC_HEALTH: <advice>

        # Dermatology Path
        - id: dermatology_history
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Act as a veterinary dermatologist. Focus on history and lesion description.
            Patient data: {{ get_input() }}
            Skin cytology: {{ get_input().test_results.skin_cytology if get_input().test_results and get_input().test_results.skin_cytology else "Non disponibile" }}
            Allergy testing: {{ get_input().test_results.allergy_testing if get_input().test_results and get_input().test_results.allergy_testing else "Non disponibile" }}
            Output: DERM_HISTORY: <summary>, LESIONS: [<lesion1>, <lesion2>]

        - id: dermatology_tests
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Propose dermatological diagnostics based on: {{ previous_outputs.dermatology_history }}.
            Skin cytology: {{ get_input().test_results.skin_cytology if get_input().test_results and get_input().test_results.skin_cytology else "Non disponibile" }}
            Allergy testing: {{ get_input().test_results.allergy_testing if get_input().test_results and get_input().test_results.allergy_testing else "Non disponibile" }}
            Output: DERM_TESTS: [<test1>, <test2>], RATIONALE: <explanation>

        - id: dermatology_plan
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          prompt: |
            Suggest a treatment and follow-up plan based on: {{ previous_outputs.dermatology_tests }}.
            Skin cytology: {{ get_input().test_results.skin_cytology if get_input().test_results and get_input().test_results.skin_cytology else "Non disponibile" }}
            Allergy testing: {{ get_input().test_results.allergy_testing if get_input().test_results and get_input().test_results.allergy_testing else "Non disponibile" }}
            Output: DERM_PLAN: <plan>, FOLLOW_UP: <instructions>

        # Join specialist perspectives
        - id: diagnosis_join
          type: join
          group: specialists_fork
          prompt: |
            Combine all specialist path outputs for synthesis.
            Internal Medicine: |
              {{ safe_get_response('internal_medicine_management', '{}') }}
            Surgery: |
              {{ safe_get_response('surgery_plan', '{}') }}
            Infectious Disease: |
              {{ safe_get_response('infectious_disease_plan', '{}') }}
            Dermatology: |
              {{ safe_get_response('dermatology_plan', '{}') }}
            Synthesize and return ONLY the following as a YAML string:
            CONVERGENCE_SCORE: <score 0.0-1.0>
            SYNTHESIS: <one paragraph summary>

        - id: convergence_scorer
          type: local_llm
          model: openai/gpt-oss-20b
          prompt: |
            Score the convergence and actionability of the specialists' synthesis.
            Synthesis: |
              {{ safe_get_response('diagnosis_join', '') }}
            Return ONLY the following as a YAML string:
            ---
            CONVERGENCE_SCORE: <score 0.0-1.0>
            ACTIONABILITY_NOTES: |
              <key actionable points, one per line>

  - id: actionable_plan_builder
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    prompt: |
      Build a step-by-step actionable plan for the vet and owner, integrating all specialist recommendations.
      Patient data: {{ get_input() }}
      Synthesis: {{ get_agent_response('specialists_loop.diagnosis_join') }}
      Output ONLY as YAML:
      ACTION_PLAN: |
        <step-by-step plan, with dosages, rationales, and owner instructions>

  - id: memory_writer
    type: memory
    namespace: patient_cases
    config:
      operation: write
      memory_type: long_term
    prompt: |
      Store the following structured YAML object as the final result for this patient case:
      synthesis: |
        {{ get_agent_response('specialists_loop.diagnosis_join') }}
      action_plan: |
        {{ get_agent_response('actionable_plan_builder') }}

  - id: explanation_builder
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    prompt: |
      # TASK
      Compose a comprehensive, actionable explanation for the owner and vet.
      Patient data: {{ get_input() }}
      Synthesis: {{ get_agent_response('specialists_loop.diagnosis_join') }}
      Action plan: {{ get_agent_response('actionable_plan_builder') }}
      # CONSTRAINT:
      - DEVI RISPONDERE IN LINGUA ITALIANA.
      - Output ONLY as YAML, filling all fields:
        diagnosis: <main detailed diagnosis with reasoning and differentials>
        differentials:
          - <differential 1>
          - <differential 2>
        specialist_reasoning: <detailed highlighting key points from each specialist>
        action_plan: <detailed of the action plan>
        owner_instructions: <actionable explanation for the owner with warning signs and next steps>
      
