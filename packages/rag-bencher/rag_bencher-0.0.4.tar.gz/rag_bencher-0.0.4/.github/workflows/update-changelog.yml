name: Update Changelog

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to sync (blank = latest release)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  changelog:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release details
        id: release
        uses: actions/github-script@v7
        env:
          WORKFLOW_TAG_INPUT: ${{ github.event.inputs.release_tag }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagInput = process.env.WORKFLOW_TAG_INPUT || '';
            const {owner, repo} = context.repo;

            let release = null;

            if (context.eventName === 'release' && context.payload.release) {
              release = context.payload.release;
            } else if (tagInput) {
              release = (await github.rest.repos.getReleaseByTag({owner, repo, tag: tagInput})).data;
            } else {
              release = (await github.rest.repos.getLatestRelease({owner, repo})).data;
            }

            if (!release) {
              throw new Error('No release information available.');
            }

            core.setOutput('name', release.name || release.tag_name || 'Unspecified');
            core.setOutput('tag', release.tag_name);
            core.setOutput('body', release.body || '');
            core.setOutput('published_at', release.published_at || release.created_at || new Date().toISOString());

      - name: Insert release notes into CHANGELOG.md
        env:
          RELEASE_NAME: ${{ steps.release.outputs.name }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
          RELEASE_BODY: ${{ steps.release.outputs.body }}
          RELEASE_DATE: ${{ steps.release.outputs.published_at }}
          CHANGELOG_PATH: CHANGELOG.md
        run: |
          node - <<'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          const path = process.env.CHANGELOG_PATH;
          const rawBody = (process.env.RELEASE_BODY || '').trim();

          if (!rawBody) {
          console.log('Release body is empty; skipping changelog update.');
          process.exit(0);
          }

          const versionId = (process.env.RELEASE_TAG || '').trim();
          if (!versionId) {
          console.error('Release tag is missing; cannot update changelog.');
          process.exit(1);
          }

          const date = new Date(process.env.RELEASE_DATE || Date.now())
          .toISOString()
          .split('T')[0];

          // Shift headings down for CHANGELOG nesting
          let body = rawBody
          .replace(/^### /gm, '#### ')
          .replace(/^## /gm, '### ');

          // Try to determine previous tag for compare URL
          let previousTag = null;
          try {
          const tagList = execSync('git tag --sort=version:refname', { encoding: 'utf8' })
              .split('\n')
              .map(t => t.trim())
              .filter(Boolean);

          const idx = tagList.indexOf(versionId);
          if (idx > 0) {
              previousTag = tagList[idx - 1];
              console.log(`Previous tag detected: ${previousTag}`);
          } else {
              console.log('No previous tag found (this may be the first release).');
          }
          } catch (err) {
          console.log('Could not determine previous tag:', err.message);
          }

          // Build optional Full Changelog link
          const repoSlug = process.env.GITHUB_REPOSITORY || '';
          let compareLine = '';
          if (previousTag && repoSlug) {
          const url = `https://github.com/${repoSlug}/compare/${previousTag}...${versionId}`;
          compareLine = `\n\n**Full Changelog**: ${url}`;
          }

          const newSection = `## [${versionId}] - ${date}\n${body}${compareLine}\n\n`;

          const changelog = fs.readFileSync(path, 'utf8');

          const unreleasedHeader = '## [Unreleased]';
          const unreleasedIndex = changelog.indexOf(unreleasedHeader);
          if (unreleasedIndex === -1) {
          console.error('Unable to find Unreleased section in CHANGELOG.md');
          process.exit(1);
          }

          const escape = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const headerRegex = new RegExp(
          '^## \\[' + escape(versionId) + '\\](?: - \\d{4}-\\d{2}-\\d{2})?',
          'm'
          );

          const existingMatch = changelog.match(headerRegex);

          let updated;

          if (existingMatch) {
          console.log(`Existing section found for ${versionId}; replacing it.`);
          const start = existingMatch.index;
          const nextHeaderIdx = changelog.indexOf('\n## [', start + 1);
          const end = nextHeaderIdx === -1 ? changelog.length : nextHeaderIdx;
          updated = changelog.slice(0, start) + newSection + changelog.slice(end);
          } else {
          console.log(`No section found for ${versionId}; inserting a new one.`);
          const nextSectionIdx = changelog.indexOf(
              '\n## [',
              unreleasedIndex + unreleasedHeader.length
          );
          const insertPos = nextSectionIdx === -1 ? changelog.length : nextSectionIdx;
          updated = changelog.slice(0, insertPos) + '\n\n' + newSection + changelog.slice(insertPos);
          }

          fs.writeFileSync(path, updated);
          EOF

      - name: Create changelog PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CHANGELOG_PAT }}
          base: ${{ github.event.release.target_commitish || 'main' }}
          branch: chore/changelog-release-${{ steps.release.outputs.tag }}
          title: "chore: update changelog for ${{ steps.release.outputs.tag }}"
          body: "Update CHANGELOG.md with notes from ${{ steps.release.outputs.tag }}."
          commit-message: "chore: update changelog for ${{ steps.release.outputs.tag }}"
          add-paths: |
            CHANGELOG.md
