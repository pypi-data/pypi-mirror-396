<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Klaude Code - $first_user_message</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%230851b2%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%2216 18 22 12 16 6%22></polyline><polyline points=%228 6 2 12 8 18%22></polyline></svg>"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3/400.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3/400-italic.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3/700.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3/700-italic.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/fira-code/400.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/fira-code/700.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-body: #eae9e5;
        --bg-container: #edece9;
        --bg-card: #efeeeb;
        --bg-error: #ffebee;
        --bg-code: #f2f1ed;
        --border: #c8c8c8;
        --text: #111111;
        --text-dim: #64748b;
        --accent: #0851b2;
        --accent-dim: rgba(8, 145, 178, 0.08);
        --success: #15803d;
        --error: #dc2626;
        --fg-inline-code: #4f4fc7;
        --font-mono: "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;
        --font-markdown-mono: "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;
        --font-markdown: "Source Sans 3", system-ui, sans-serif;
        --font-weight-bold: 700;
        --font-size-xs: 13px;
        --font-size-sm: 14px;
        --font-size-base: 15px;
        --font-size-lg: 16px;
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 12px;
        --spacing-lg: 16px;
        --spacing-xl: 24px;
        --radius-sm: 4px;
        --radius-md: 6px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-body);
        color: var(--text);
        font-family: var(--font-mono);
        line-height: 1.6;
        font-size: var(--font-size-lg);
        -webkit-font-smoothing: antialiased;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Header */
      .header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .header h1 {
        font-size: 20px;
        font-weight: var(--font-weight-bold);
        margin-bottom: 16px;
        color: var(--text);
        display: inline-block;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .meta-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        color: var(--text-dim);
      }

      .meta-value {
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Components - Collapsible sections */
      details.collapsible-section {
        background: transparent;
        margin-bottom: 4px;
      }

      details.collapsible-section:last-of-type {
        margin-bottom: 16px;
      }

      details.collapsible-section > summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s;
      }

      details.collapsible-section > summary:hover,
      details.collapsible-section[open] > summary {
        color: var(--text);
      }

      details.collapsible-section > summary::-webkit-details-marker {
        display: none;
      }
      details.collapsible-section > summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        margin-right: 4px;
        display: inline-block;
        min-width: 24px;
      }
      details.collapsible-section[open] > summary::before {
        content: "[-]";
      }

      details.collapsible-section > .details-content {
        padding: 8px 0 16px 24px;
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        overflow-x: auto;
        border-left: 1px solid var(--border);
        margin-left: 10px;
      }

      /* Messages */
      .message-stream {
        display: block;
      }

      .message-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .message-header .role-label {
        margin-bottom: 0;
      }

      .role-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        margin-bottom: 4px;
        color: var(--text-dim);
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }
      .message-header .role-label {
        width: auto;
      }
      .role-label.user {
        color: var(--accent);
      }
      .role-label.assistant {
        color: var(--success);
      }

      details.developer-message {
        background: transparent;
        margin-bottom: 4px;
      }

      details.developer-message > summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s;
      }

      details.developer-message > summary:hover,
      details.developer-message[open] > summary {
        color: var(--text);
      }

      details.developer-message > summary::-webkit-details-marker {
        display: none;
      }
      details.developer-message > summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        margin-right: 4px;
        display: inline-block;
        min-width: 24px;
      }
      details.developer-message[open] > summary::before {
        content: "[-]";
      }

      details.developer-message > .details-content {
        padding: 8px 0 16px 24px;
        font-size: var(--font-size-xs);
        color: var(--text-dim);
        overflow-x: auto;
        border-left: 1px solid var(--border);
        margin-left: 10px;
      }

      details.developer-message.gap-below {
        margin-bottom: 16px;
      }

      .message-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        font-size: var(--font-size-base);
      }
      .assistant-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .assistant-toolbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
      .raw-toggle {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        padding: 2px 10px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .raw-toggle:hover {
        color: var(--text);
        border-color: var(--accent);
      }
      .raw-toggle.active {
        color: var(--accent);
        border-color: var(--accent);
        background: var(--accent-dim);
      }

      .copy-raw-btn {
        margin-left: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        padding: 2px 10px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .copy-raw-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .mermaid-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.98);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .mermaid-modal.active {
        opacity: 1;
        pointer-events: auto;
      }
      .mermaid-modal-content {
        width: 95%;
        height: 90%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
      }
      .mermaid-modal-content svg {
        width: auto !important;
        height: auto !important;
        max-width: 100%;
        max-height: 100%;
      }
      .mermaid-modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: transparent;
        border: none;
        font-size: 32px;
        cursor: pointer;
        color: var(--text-dim);
        z-index: 1001;
        line-height: 1;
        padding: 8px;
      }
      .mermaid-modal-close:hover {
        color: var(--text);
      }

      .copy-mermaid-btn {
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        padding: 2px 10px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .copy-mermaid-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .fullscreen-mermaid-btn {
        margin-left: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        padding: 2px 10px;
        border-radius: 999px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .fullscreen-mermaid-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .assistant-rendered {
        width: 100%;
      }
      .assistant-raw {
        display: none;
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        white-space: pre-wrap;
        background: var(--bg-body);
        border: 1px dashed var(--border);
        border-radius: var(--radius-sm);
        padding: 20px;
      }
      .assistant-message.show-raw .assistant-rendered {
        display: none;
      }
      .assistant-message.show-raw .assistant-raw {
        display: block;
      }

      .message-content.user {
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
        font-weight: var(--font-weight-bold);
        font-family: var(--font-markdown);
      }

      .thinking-block {
        margin-top: 8px;
        margin-bottom: 16px;
        padding: 12px 16px;
        border-left: 2px solid var(--border);
        color: var(--text-dim);
        font-style: italic;
        font-size: var(--font-size-sm);
        background: var(--bg-body);
      }
      .thinking-block.markdown-body p {
        margin-bottom: 8px;
      }
      .thinking-block.markdown-body p:last-child {
        margin-bottom: 0;
      }

      /* Response Metadata */
      .response-metadata {
        margin: 8px 0 16px 0;
        padding: 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        color: var(--text-dim);
        border-left: 2px solid transparent;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .metadata-line {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        line-height: 1.4;
      }
      .metadata-model {
        font-weight: var(--font-weight-bold);
        color: var(--text);
      }
      .metadata-provider {
        opacity: 0.8;
      }
      .metadata-stat {
        white-space: nowrap;
      }
      .metadata-divider {
        color: var(--border);
        margin: 0 2px;
      }

      /* Tool Calls */
      .tool-call {
        margin-top: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        overflow: hidden;
        font-size: var(--font-size-base);
      }

      .tool-header {
        padding: 8px 12px;
        background: var(--bg-container);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: var(--font-mono);
      }

      .tool-name {
        font-weight: var(--font-weight-bold);
        color: var(--accent);
      }
      .tool-id {
        color: var(--text-dim);
        font-size: var(--font-size-xs);
      }

      .tool-header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .timestamp {
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        color: var(--text-dim);
        margin-left: auto;
        font-weight: normal;
      }

      .assistant-toolbar .timestamp {
        margin-right: 8px;
      }

      .tool-args {
        padding: 12px;
        background: var(--bg-body);
        font-family: var(--font-mono);
        color: var(--text-dim);
        overflow-x: auto;
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
      }

      /* Collapsible tool-args */
      details.tool-args-collapsible {
        padding: 0;
        background: var(--bg-body);
      }
      details.tool-args-collapsible > summary {
        padding: 8px 12px;
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-dim);
        transition: color 0.2s;
      }
      details.tool-args-collapsible > summary:hover,
      details.tool-args-collapsible[open] > summary {
        color: var(--text);
      }
      details.tool-args-collapsible > summary::-webkit-details-marker {
        display: none;
      }
      details.tool-args-collapsible > summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        display: inline-block;
        min-width: 24px;
      }
      details.tool-args-collapsible[open] > summary::before {
        content: "[-]";
      }
      details.tool-args-collapsible > .tool-args-content {
        padding: 12px;
        font-family: var(--font-mono);
        color: var(--text-dim);
        overflow-x: auto;
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
        border-top: 1px dashed var(--border);
      }

      .tool-result {
        border-top: 1px solid var(--border);
        padding: 12px;
        font-size: var(--font-size-sm);
      }
      .tool-result .full-text,
      .tool-result .preview-text,
      .tool-result pre,
      .tool-result code {
        font-size: var(--font-size-sm);
      }

      .tool-result.success {
        background: var(--bg-card);
        color: var(--text);
      }
      .tool-result.error {
        background: var(--bg-error);
        color: var(--error);
      }
      .tool-result.pending {
        background: var(--bg-body);
        color: var(--text-dim);
      }

      /* Sub-Agent Result */
      .sub-agent-result-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .sub-agent-toolbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 4px;
      }

      .sub-agent-content {
        width: 100%;
      }

      .sub-agent-raw {
        display: none;
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        white-space: pre-wrap;
        background: var(--bg-body);
        border: 1px dashed var(--border);
        border-radius: var(--radius-sm);
        padding: 20px;
      }

      .sub-agent-content.show-raw .sub-agent-rendered {
        display: none;
      }
      .sub-agent-content.show-raw .sub-agent-raw {
        display: block;
      }

      /* Markdown Elements */
      .markdown-body {
        font-family: var(--font-markdown);
        line-height: 1.6;
        font-size: var(--font-size-base);
      }
      .markdown-body > *:first-child {
        margin-top: 0 !important;
      }
      .markdown-body > *:last-child {
        margin-bottom: 0 !important;
      }
      
      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3,
      .markdown-body h4,
      .markdown-body h5,
      .markdown-body h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: var(--font-weight-bold);
        line-height: 1.25;
      }

      .markdown-body a {
        color: var(--accent);
        text-decoration: none;
        border-bottom: 1px solid rgba(8, 81, 178, 0.2);
        transition: border-color 0.2s, background-color 0.2s;
      }
      .markdown-body a:hover {
        border-bottom-color: var(--accent);
        background-color: rgba(8, 81, 178, 0.05);
        border-radius: 2px;
      }

      .markdown-body p {
        margin-bottom: 8px; /* Tighter spacing */
      }
      
      .markdown-body ul,
      .markdown-body ol {
        margin-bottom: 8px; /* Tighter spacing */
        padding-left: 1.5rem;
        list-style-position: outside;
      }
      
      .markdown-body ul ul,
      .markdown-body ol ul,
      .markdown-body ul ol,
      .markdown-body ol ol {
        margin-top: 0;
        margin-bottom: 0;
      }
      
      .markdown-body li > p {
        margin-bottom: 0;
      }
      .markdown-body li + li {
        margin-top: 0.25em;
      }

      .markdown-body blockquote {
        margin: 0 0 16px;
        padding: 0 1em;
        color: var(--text-dim);
        border-left: 0.25em solid var(--border);
      }

      .markdown-body table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 8px;
        margin-bottom: 16px;
        display: block;
        overflow-x: auto;
      }
      
      .markdown-body table tr {
        background-color: var(--bg-card);
        border-top: 1px solid var(--border);
      }
      
      .markdown-body table tr:nth-child(2n) {
        background-color: rgba(0, 0, 0, 0.02);
      }
      
      .markdown-body table th,
      .markdown-body table td {
        padding: 6px 13px;
        border: 1px solid var(--border);
      }
      
      .markdown-body table th {
        font-weight: var(--font-weight-bold);
        background-color: rgba(0, 0, 0, 0.04);
      }

      .markdown-body hr {
        height: 0;
        margin: 24px 0;
        border: none;
        border-top: 1px solid var(--border);
      }
      .markdown-body pre {
        background: var(--bg-code);
        padding: 12px;
        border-radius: var(--radius-md);
        overflow-x: auto;
        margin: 8px 0 16px 0;
        border: 1px solid var(--border);
      }
      .markdown-body code {
        font-family: var(--font-markdown-mono);
        color: var(--fg-inline-code);
        font-size: var(--font-size-sm);
        padding: 2px 4px;
        border-radius: var(--radius-sm);
        background-color: rgba(0, 0, 0, 0.05); /* Slight bg for inline code */
      }
      .markdown-body pre code {
        background: transparent;
        padding: 0;
        border-radius: 0;
        color: inherit;
      }
      .markdown-body pre code.hljs {
        background: transparent;
      }

      /* Diff View */
      .diff-view {
        font-family: var(--font-mono);
        background: var(--bg-code);
        padding: 12px;
        border-radius: var(--radius-md);
        overflow-x: auto;
        border: 1px solid var(--border);
      }
      .diff-line {
        white-space: pre;
      }
      .diff-plus {
        color: #166534;
        background: #e7f5e9;
        display: block;
      }
      .diff-minus {
        color: #991b1b;
        background: #ffebee;
        display: block;
      }
      .diff-ctx {
        color: var(--text-dim);
        opacity: 0.7;
        display: block;
      }

      /* Collapsible Diff View */
      details.diff-collapsible {
        background: transparent;
        margin-top: 8px;
      }
      details.diff-collapsible > summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-dim);
        transition: color 0.2s;
      }
      details.diff-collapsible > summary:hover,
      details.diff-collapsible[open] > summary {
        color: var(--text);
      }
      details.diff-collapsible > summary::-webkit-details-marker {
        display: none;
      }
      details.diff-collapsible > summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        display: inline-block;
        min-width: 24px;
      }
      details.diff-collapsible[open] > summary::before {
        content: "[-]";
      }
      details.diff-collapsible > .diff-view {
        margin-top: 8px;
      }

      .footer {
        margin-top: 60px;
        text-align: center;
        color: var(--text-dim);
        font-size: var(--font-size-sm);
        border-top: 1px solid var(--border);
        padding-top: 24px;
      }

      .footer-link {
        color: inherit;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
      }

      .footer-link:hover {
        color: var(--accent);
      }

      .expandable {
        cursor: pointer;
      }
      .expandable.expanded {
        cursor: auto;
      }
      .expandable .full-text {
        display: none;
      }
      .expandable .collapse-hint {
        display: none;
      }
      .expandable.expanded .preview-text {
        display: none;
      }
      .expandable.expanded .expand-hint {
        display: none;
      }
      .expandable.expanded .full-text {
        display: block;
      }
      .expandable.expanded .collapse-hint {
        display: block;
        cursor: pointer;
        color: var(--accent);
        font-size: var(--font-size-xs);
        margin-top: 4px;
        border-top: 1px dashed var(--border);
        padding-top: 4px;
      }
      .expand-hint {
        font-size: var(--font-size-xs);
        color: var(--accent);
        margin-top: 4px;
      }

      /* Todo List */
      .todo-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .todo-item {
        display: flex;
        gap: 8px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        align-items: flex-start;
      }
      .todo-bullet {
        flex-shrink: 0;
        font-size: 10px;
        line-height: 1.5;
        opacity: 0.7;
      }
      .todo-item.status-completed {
        color: var(--text-dim);
        text-decoration: line-through;
      }
      .todo-item.status-in_progress {
        color: var(--success);
        font-weight: 500;
      }
      .todo-item.status-pending {
        color: var(--text-dim);
      }

      /* Sub-agent Session */
      details.sub-agent-session {
        background: transparent;
        margin: 16px 0;
        border-left: 3px solid var(--accent);
        padding-left: 16px;
      }
      details.sub-agent-session > summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s;
      }
      details.sub-agent-session > summary:hover,
      details.sub-agent-session[open] > summary {
        color: var(--text);
      }
      details.sub-agent-session > summary::-webkit-details-marker {
        display: none;
      }
      details.sub-agent-session > summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        margin-right: 4px;
        display: inline-block;
        min-width: 24px;
      }
      details.sub-agent-session[open] > summary::before {
        content: "[-]";
      }
      details.sub-agent-session > .sub-agent-content {
        padding: 8px 0 0 0;
      }

      /* Scroll to Bottom Button */
      .scroll-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 1px solid var(--border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: var(--text-dim);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
      }

      .scroll-btn:hover {
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      }

      .scroll-btn.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      /* Tool details in Available Tools section */
      .tool-details {
        margin-bottom: 2px;
      }
      .tool-details summary {
        color: var(--accent);
        font-weight: 500;
        text-transform: none;
        letter-spacing: normal;
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tool-details summary::-webkit-details-marker {
        display: none;
      }
      .tool-details summary:hover {
        color: var(--text);
      }
      .tool-details summary::before {
        content: "[+]";
        min-width: 24px;
        display: inline-block;
      }
      .tool-details[open] summary::before {
        content: "[-]";
      }
      .tool-description {
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
      }
      .tool-params {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px dashed var(--border);
      }
      .tool-params-title {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        color: var(--text-dim);
        margin-bottom: 8px;
      }
      .tool-param {
        margin-bottom: 8px;
        padding-left: 12px;
        font-size: var(--font-size-sm);
      }
      .tool-param-name {
        color: var(--success);
        font-weight: 500;
      }
      .tool-param-type {
        color: var(--text-dim);
      }
      .tool-param-required {
        color: var(--error);
        margin-left: 4px;
      }
      .tool-param-desc {
        color: var(--text-dim);
        font-size: var(--font-size-sm);
        margin-top: 2px;
      }
      /* TOC Sidebar */
      .toc-sidebar {
        position: fixed;
        top: 33vh;
        left: 20px;
        width: 220px;
        bottom: 33vh;
        overflow-y: auto;
        padding-right: 12px;
        /* Vertical padding to offset mask */
        padding-top: 30px;
        padding-bottom: 30px;
        display: none;
        scrollbar-width: none;
        z-index: 100;
        /* Linear mask for fading edges */
        -webkit-mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 30px,
          black calc(100% - 30px),
          transparent 100%
        );
        mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 30px,
          black calc(100% - 30px),
          transparent 100%
        );
      }

      .toc-sidebar::-webkit-scrollbar {
        display: none;
      }

      /* Show TOC on wide screens */
      @media (min-width: 1400px) {
        .toc-sidebar {
          display: block;
        }
      }

      .toc-item {
        display: block;
        padding: 3px 10px;
        margin-bottom: 1px;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.3;
        color: var(--text-dim);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-radius: 4px;
      }

      .toc-item:hover {
        color: var(--text);
        background: rgba(0, 0, 0, 0.03);
      }

      .toc-item.active {
        color: var(--text);
        background: var(--bg-card);
        font-weight: bold;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <div id="toc-sidebar" class="toc-sidebar"></div>
    <div class="container">
      <div class="header">
        <h1>Klaude Code</h1>
        <div class="meta-grid">
          <div class="meta-item">
            <span class="meta-label">First Message</span>
            <span class="meta-value" title="$first_user_message"
              >$first_user_message</span
            >
          </div>
          <div class="meta-item">
            <span class="meta-label">Model</span>
            <span class="meta-value">$model_name</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Updated</span>
            <span class="meta-value">$session_updated</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Directory</span>
            <span class="meta-value" title="$work_dir_full">$work_dir</span>
          </div>
        </div>
      </div>

      <details class="collapsible-section">
        <summary>System Prompt</summary>
        <div
          class="details-content system-prompt-content"
          style="font-family: var(--font-mono); white-space: pre-wrap"
        >
          $system_prompt
        </div>
      </details>

      <details class="collapsible-section">
        <summary>Available Tools</summary>
        <div class="details-content">$tools_html</div>
      </details>

      <div class="message-stream">$messages_html</div>

      <div class="footer">
        Generated by
        <a
          href="https://github.com/inspirepan/klaude-code"
          class="footer-link"
          target="_blank"
          >klaude-code</a
        >
        &bull; $footer_time &bull; $total_messages messages
      </div>
    </div>

    <div id="scroll-btn" class="scroll-btn" title="Scroll to bottom">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
    </div>

    <div id="mermaid-modal" class="mermaid-modal">
      <button class="mermaid-modal-close" id="mermaid-modal-close">
        &times;
      </button>
      <div class="mermaid-modal-content" id="mermaid-modal-content"></div>
    </div>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
      mermaid.initialize({
        startOnLoad: true,
        theme: "neutral",
        fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace',
      });
    </script>
    <script>
      // Trim whitespace from pre-wrap content to avoid formatting artifacts
      document.querySelectorAll(".system-prompt-content").forEach((el) => {
        el.textContent = el.textContent.trim();
      });

      // Markdown rendering and Syntax Highlighting
      document.querySelectorAll(".markdown-content").forEach((el) => {
        const raw = el.dataset.raw;
        if (raw && window.marked) {
          // 1. Render Markdown
          el.innerHTML = window.marked.parse(raw);

          // 2. Apply Syntax Highlighting to generated code blocks
          if (window.hljs) {
            el.querySelectorAll("pre code").forEach((block) => {
              hljs.highlightElement(block);
            });
          }
        }
      });

      // Expandable tool outputs
      document.querySelectorAll(".expandable").forEach((el) => {
        el.addEventListener("click", (e) => {
          if (!el.classList.contains("expanded")) {
            el.classList.add("expanded");
          } else if (e.target.classList.contains("collapse-hint")) {
            el.classList.remove("expanded");
          }
        });
      });

      // Assistant raw toggle
      document.querySelectorAll(".assistant-message-group").forEach((group) => {
        const toggle = group.querySelector(".raw-toggle");
        const copyBtn = group.querySelector(".copy-raw-btn");
        const block = group.querySelector(".assistant-message");
        const rendered = block
          ? block.querySelector(".assistant-rendered")
          : null;
        const raw = block ? block.querySelector(".assistant-raw") : null;

        // Copy button logic
        if (copyBtn && rendered) {
          copyBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const rawContent = rendered.dataset.raw;
            if (!rawContent) return;

            try {
              // Decode HTML entities for copy
              const textarea = document.createElement("textarea");
              textarea.innerHTML = rawContent;
              const decoded = textarea.value;

              await navigator.clipboard.writeText(decoded);

              // Visual feedback
              const originalText = copyBtn.textContent;
              copyBtn.textContent = "Copied!";
              copyBtn.style.color = "var(--success)";
              copyBtn.style.borderColor = "var(--success)";

              setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.color = "";
                copyBtn.style.borderColor = "";
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
              copyBtn.textContent = "Error";
              copyBtn.style.color = "var(--error)";
              setTimeout(() => {
                copyBtn.textContent = "Copy";
                copyBtn.style.color = "";
              }, 2000);
            }
          });
        }

        if (!toggle || !rendered || !raw) {
          return;
        }

        const setState = (showRaw) => {
          block.classList.toggle("show-raw", showRaw);
          toggle.classList.toggle("active", showRaw);
          toggle.setAttribute("aria-pressed", String(showRaw));
          toggle.textContent = showRaw ? "Markdown" : "Raw";
        };

        toggle.addEventListener("click", (event) => {
          event.stopPropagation();
          const nextState = !block.classList.contains("show-raw");
          setState(nextState);
        });
      });

      // Sub-agent raw toggle
      document
        .querySelectorAll(".sub-agent-result-container")
        .forEach((group) => {
          const toggle = group.querySelector(".raw-toggle");
          const copyBtn = group.querySelector(".copy-raw-btn");
          const block = group.querySelector(".sub-agent-content");
          const rendered = block
            ? block.querySelector(".sub-agent-rendered")
            : null;
          const raw = block ? block.querySelector(".sub-agent-raw") : null;

          // Copy button logic
          if (copyBtn && rendered) {
            copyBtn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const rawContent = rendered.dataset.raw;
              if (!rawContent) return;

              try {
                const textarea = document.createElement("textarea");
                textarea.innerHTML = rawContent;
                const decoded = textarea.value;

                await navigator.clipboard.writeText(decoded);

                const originalText = copyBtn.textContent;
                copyBtn.textContent = "Copied!";
                copyBtn.style.color = "var(--success)";
                copyBtn.style.borderColor = "var(--success)";

                setTimeout(() => {
                  copyBtn.textContent = originalText;
                  copyBtn.style.color = "";
                  copyBtn.style.borderColor = "";
                }, 2000);
              } catch (err) {
                console.error("Failed to copy:", err);
                copyBtn.textContent = "Error";
                copyBtn.style.color = "var(--error)";
                setTimeout(() => {
                  copyBtn.textContent = "Copy";
                  copyBtn.style.color = "";
                }, 2000);
              }
            });
          }

          if (!toggle || !rendered || !raw) {
            return;
          }

          const setState = (showRaw) => {
            block.classList.toggle("show-raw", showRaw);
            toggle.classList.toggle("active", showRaw);
            toggle.setAttribute("aria-pressed", String(showRaw));
            toggle.textContent = showRaw ? "Markdown" : "Raw";
          };

          toggle.addEventListener("click", (event) => {
            event.stopPropagation();
            const nextState = !block.classList.contains("show-raw");
            setState(nextState);
          });
        });

      // Mermaid copy button
      document.querySelectorAll(".copy-mermaid-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.stopPropagation();
          const rawContent = btn.dataset.code;
          if (!rawContent) return;

          try {
            const textarea = document.createElement("textarea");
            textarea.innerHTML = rawContent;
            const decoded = textarea.value;

            await navigator.clipboard.writeText(decoded);

            const originalText = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.color = "var(--success)";
            btn.style.borderColor = "var(--success)";

            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.color = "";
              btn.style.borderColor = "";
            }, 2000);
          } catch (err) {
            console.error("Failed to copy:", err);
            btn.textContent = "Error";
            btn.style.color = "var(--error)";
            setTimeout(() => {
              btn.textContent = "Copy Code";
              btn.style.color = "";
            }, 2000);
          }
        });
      });

      // Mermaid Fullscreen Logic
      const modal = document.getElementById("mermaid-modal");
      const modalContent = document.getElementById("mermaid-modal-content");
      const modalClose = document.getElementById("mermaid-modal-close");

      if (modal && modalContent && modalClose) {
        const closeModal = () => {
          modal.classList.remove("active");
          modalContent.innerHTML = "";
        };

        modalClose.addEventListener("click", closeModal);

        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // Handle Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("active")) {
            closeModal();
          }
        });

        document.querySelectorAll(".fullscreen-mermaid-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            // The structure is:
            // wrapper > mermaid > svg
            // wrapper > toolbar > buttons > btn

            // We need to find the mermaid div that is a sibling of the toolbar

            // Traverse up to the wrapper
            let wrapper = btn.closest("div[style*='background: white']");

            if (!wrapper) {
              // Fallback: try to find by traversing up and looking for .mermaid
              let p = btn.parentElement;
              while (p) {
                if (p.querySelector(".mermaid")) {
                  wrapper = p;
                  break;
                }
                p = p.parentElement;
                if (p === document.body) break;
              }
            }

            if (wrapper) {
              const mermaidDiv = wrapper.querySelector(".mermaid");
              if (mermaidDiv) {
                const svg = mermaidDiv.querySelector("svg");

                if (svg) {
                  // Clone the SVG to put in modal
                  // We treat the SVG as the source
                  const clone = svg.cloneNode(true);
                  // Remove fixed sizes to let it scale in flex container
                  clone.removeAttribute("height");
                  clone.removeAttribute("width");
                  clone.style.maxWidth = "100%";
                  clone.style.maxHeight = "100%";

                  modalContent.appendChild(clone);
                  modal.classList.add("active");
                } else if (mermaidDiv.textContent.trim()) {
                  // Fallback if not rendered yet (should not happen on export usually)
                  modalContent.textContent = "Diagram not rendered yet.";
                  modal.classList.add("active");
                }
              }
            }
          });
        });
      }

      // Scroll to bottom button
      const scrollBtn = document.getElementById("scroll-btn");

      function updateScrollBtn() {
        // Show button if we are not at the bottom
        const isAtBottom =
          window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 100;
        if (isAtBottom) {
          scrollBtn.classList.remove("visible");
        } else {
          scrollBtn.classList.add("visible");
        }
      }

      window.addEventListener("scroll", updateScrollBtn);
      window.addEventListener("resize", updateScrollBtn);
      updateScrollBtn(); // Initial check

      scrollBtn.addEventListener("click", () => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });
      });

      // TOC Logic
      document.addEventListener("DOMContentLoaded", () => {
        const tocSidebar = document.getElementById("toc-sidebar");
        if (!tocSidebar) return;

        const sections = [];
        let userCount = 0;
        let assistantCount = 0;

        // 1. System Prompt
        const sysPrompt = document.querySelector(
          ".collapsible-section summary"
        );
        if (sysPrompt && sysPrompt.textContent.includes("System Prompt")) {
          const details = sysPrompt.parentElement;
          details.id = details.id || "section-system-prompt";
          sections.push({
            id: details.id,
            label: "System Prompt",
            el: details,
          });
        }

        // 2. Messages and Tools
        const stream = document.querySelector(".message-stream");
        if (stream) {
          // Use a Walker to find top-level relevant items if structure is complex
          // But assuming flat children of message-stream based on CSS
          Array.from(stream.children).forEach((child) => {
            let label = null;
            let idPrefix = "section";

            if (child.classList.contains("message-group")) {
              const roleLabel = child.querySelector(".role-label");
              if (roleLabel) {
                if (roleLabel.classList.contains("user")) {
                  userCount++;
                  label = `USER $${userCount}`;
                  idPrefix = "user";
                } else if (roleLabel.classList.contains("assistant")) {
                  assistantCount++;
                  label = `ASSISTANT $${assistantCount}`;
                  idPrefix = "assistant";
                } else {
                  label = roleLabel.textContent.trim();
                }
              }
            } else if (child.classList.contains("tool-call")) {
              const toolName = child.querySelector(".tool-name");
              if (toolName) {
                label = toolName.textContent.trim();
                idPrefix = "tool";
              } else {
                label = "Tool";
              }
            }

            if (label) {
              child.id =
                child.id ||
                `$${idPrefix}-$${Math.random().toString(36).substr(2, 9)}`;
              sections.push({ id: child.id, label: label, el: child });
            }
          });
        }

        // Render TOC
        sections.forEach((section) => {
          const item = document.createElement("div");
          item.className = "toc-item";
          item.textContent = section.label;
          item.dataset.target = section.id;
          item.addEventListener("click", () => {
            section.el.scrollIntoView({ behavior: "smooth", block: "start" });
          });
          tocSidebar.appendChild(item);
        });

        // Scroll Spy with throttling
        let ticking = false;
        const offset = 150; // Pixel offset for "active" area

        function updateActiveSection() {
          let currentId = sections.length > 0 ? sections[0].id : null;
          const scrollY = window.scrollY;

          // We look for the last section that has passed the top threshold (+ offset)
          for (let i = 0; i < sections.length; i++) {
            const el = sections[i].el;
            // If element top is above the "active line" (scrollY + offset)
            if (el.offsetTop <= scrollY + offset) {
              currentId = sections[i].id;
            } else {
              // Since sections are ordered by position, we can stop once we find one below the line
              break;
            }
          }

          // Update UI
          document.querySelectorAll(".toc-item").forEach((item) => {
            const isActive = item.dataset.target === currentId;
            if (item.classList.contains("active") !== isActive) {
              item.classList.toggle("active", isActive);
              if (isActive) {
                // Auto-scroll sidebar to visible
                const sidebarRect = tocSidebar.getBoundingClientRect();
                const itemRect = item.getBoundingClientRect();
                // Check if item is out of view in sidebar (accounting for mask)
                if (
                  itemRect.top < sidebarRect.top + 40 ||
                  itemRect.bottom > sidebarRect.bottom - 40
                ) {
                  item.scrollIntoView({ behavior: "smooth", block: "center" });
                }
              }
            }
          });

          ticking = false;
        }

        window.addEventListener("scroll", () => {
          if (!ticking) {
            window.requestAnimationFrame(updateActiveSection);
            ticking = true;
          }
        });

        // Initial update
        updateActiveSection();
      });
    </script>
  </body>
</html>
