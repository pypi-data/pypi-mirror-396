name: Publish to PyPI

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# Deny all permissions by default for security
permissions: {}

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    # Grant minimal permissions required for PyPI trusted publishing
    permissions:
      actions: read # Required for SBOM action to find workflow artifacts when attaching release assets
      contents: write # Required to upload release artifacts
      id-token: write # Required for trusted publishing
      attestations: write # Required for generating attestations
    environment:
      name: pypi
      url: https://pypi.org/p/immich-migrator

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7.1.5
        with:
          version: "latest"
          enable-cache: false
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Build package
        run: uv run just build

      - name: Verify package contents
        run: uv run just verify

      - name: Generate SHA256 checksums
        run: |
          cd dist
          sha256sum ./* > SHA256SUMS
          cat SHA256SUMS

      - name: Generate SBOM
        uses: anchore/sbom-action@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0.20.11
        with:
          path: ./
          artifact-name: sbom.spdx.json
          output-file: dist/sbom.spdx.json
          format: spdx-json
          upload-artifact: true
          upload-release-assets: true
          dependency-snapshot: true

      - name: Generate build provenance attestations
        id: attest
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: "dist/*"

      - name: Sign artifacts with Sigstore
        uses: sigstore/gh-action-sigstore-python@a5caf349bc536fbef3668a10ed7f5cd309a4b53d # v3.2.0
        with:
          inputs: ./dist/*

      - name: Publish to PyPI with trusted publishing
        run: uv publish

      - name: Capture build metadata
        id: build-meta
        run: |
          {
            echo "python_version=$(uv run python --version | cut -d' ' -f2)"
            echo "uv_version=$(uv --version | cut -d' ' -f2)"
            echo "build_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          } >> "$GITHUB_OUTPUT"

      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/SHA256SUMS
          append_body: true
          body: |

            ### üî® Build Information
            - **Python:** ${{ steps.build-meta.outputs.python_version }}
            - **uv:** ${{ steps.build-meta.outputs.uv_version }}
            - **Built:** ${{ steps.build-meta.outputs.build_time }}
            - **Commit:** ${{ github.sha }}

            ### üîê Verification

            Verify package integrity:
            ```bash
            # Verify checksums
            sha256sum -c SHA256SUMS

            # Verify build provenance attestation (requires GitHub CLI)
            gh attestation verify immich_migrator-*.whl --owner ${{ github.repository_owner }}
            ```

            See [SLSA build provenance](${{ steps.attest.outputs.attestation-url }}) for attestation details.
