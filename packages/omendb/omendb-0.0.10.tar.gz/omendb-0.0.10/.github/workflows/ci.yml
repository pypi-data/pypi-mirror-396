name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Pin nightly for reproducibility (update monthly)
  RUST_NIGHTLY: nightly-2025-12-04

jobs:
  # ==========================================================================
  # Stage 1: Fast checks (parallel, fail fast on lint)
  # ==========================================================================

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_NIGHTLY }}
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Clippy (lib)
        run: |
          cargo clippy --lib -- \
            -D warnings \
            -D clippy::correctness \
            -W clippy::suspicious
      - name: Clippy (tests)
        run: |
          cargo clippy --tests -- \
            -D clippy::correctness \
            -W clippy::suspicious

  # ==========================================================================
  # Stage 2: Rust tests (after lint passes)
  # ==========================================================================

  test:
    name: Test (Rust)
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_NIGHTLY }}
      - uses: Swatinem/rust-cache@v2
      - name: Unit tests
        run: cargo test --lib
        timeout-minutes: 10

  proptest:
    name: Property Tests
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_NIGHTLY }}
      - uses: Swatinem/rust-cache@v2
      - name: Property-based tests
        run: cargo test --lib proptest
        timeout-minutes: 15
        env:
          PROPTEST_CASES: 500

  # ==========================================================================
  # Stage 2: Python bindings (parallel with Rust tests)
  # ==========================================================================

  python:
    name: Test (Python)
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_NIGHTLY }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        working-directory: python
        run: uv sync

      - name: Check formatting (ruff)
        working-directory: python
        run: uv run ruff format --check .

      - name: Lint (ruff)
        working-directory: python
        run: uv run ruff check .

      - name: Build
        working-directory: python
        run: uv run maturin develop --release

      - name: Test
        working-directory: python
        run: uv run pytest tests/ -x --timeout=60 -m "not slow and not soak"

  # ==========================================================================
  # Stage 2: Node.js bindings (parallel with Rust tests)
  # ==========================================================================

  node:
    name: Test (Node.js)
    runs-on: ubuntu-latest
    needs: [fmt, clippy]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_NIGHTLY }}

      - name: Install dependencies
        working-directory: node
        run: npm install

      - name: Build
        working-directory: node
        run: npm run build

      - name: Test
        working-directory: node
        run: npm test
