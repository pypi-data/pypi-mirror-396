"""Adding client secret uuid

Revision ID: d3c9f0a45db6
Revises: c92a78f11036
Create Date: 2025-06-30 12:53:29.723691

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "d3c9f0a45db6"
down_revision: Union[str, None] = "c92a78f11036"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "client_secret_assoc",
        sa.Column("client_secret_uuid", sa.UUID(), server_default=sa.text("gen_random_uuid()"), nullable=False),
        schema="account",
    )

    # Step 2: Populate the column for existing rows (if any)
    op.execute(
        """
        UPDATE account.client_secret_assoc
        SET client_secret_uuid = gen_random_uuid()
        WHERE client_secret_uuid IS NULL
        """
    )

    # Step 3: Alter the column to nullable=True
    op.alter_column("client_secret_assoc", "client_secret_uuid", nullable=True, schema="account")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("client_secret_assoc", "client_secret_uuid", schema="account")
    # ### end Alembic commands ###
