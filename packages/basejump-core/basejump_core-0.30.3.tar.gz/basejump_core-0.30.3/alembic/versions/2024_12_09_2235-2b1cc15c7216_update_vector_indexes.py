"""update vector indexes

Revision ID: 2b1cc15c7216
Revises: e77bd77d15ff
Create Date: 2024-12-09 22:35:11.173726

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "2b1cc15c7216"
down_revision: Union[str, None] = "e77bd77d15ff"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


REDIS_PARTITION_PREFIX = "basejump_pclient"
# WARNING: Changing this will change the index location.
# To change this number, add this value to the connect.vector_db table.
# Then the modulo can be calculated based off of that instead of this constant
REDIS_INDEX_CT = 100


def get_index_name(client_id: int) -> str:
    """Gets the index name

    Warnings
    -------
    Keep this as a suffix unless changing ManageVectorIndexes.get_redis_indexes since that function
    depends on this one appending the type to the end.
    """
    # TODO: Use this function in ManageVectorIndexes.get_redis_indexes so there is a more clear dependency
    # index_name = (str(vector_uuid) + vector_datasource_type.value).lower()
    return REDIS_PARTITION_PREFIX + str(client_id % REDIS_INDEX_CT)


def upgrade() -> None:
    from basejump.core.database.db_connect import ConnectDB, conn_params_noasync

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    engine = conn_db.connect_db()
    with engine.connect() as conn:
        result = conn.execute(
            sa.text(
                "select client_id, index_name from connect.vector_db where index_name not like '%basejump_pclient%'"
            )
        )
        result_all = result.all()
    for row in result_all:
        new_index_name = get_index_name(client_id=row.client_id)
        print(f"Updating index {row.index_name} to {new_index_name}")
        op.execute(
            f"UPDATE connect.vector_db SET index_name = '{new_index_name}' WHERE index_name = '{row.index_name}'"
        )
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
