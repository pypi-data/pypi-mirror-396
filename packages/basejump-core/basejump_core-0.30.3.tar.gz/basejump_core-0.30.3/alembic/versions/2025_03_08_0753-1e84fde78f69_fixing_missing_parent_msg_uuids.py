"""fixing missing parent msg uuids

Revision ID: 1e84fde78f69
Revises: 6a94c1aa01e0
Create Date: 2025-03-08 07:53:30.191177

"""

from typing import Sequence, Union

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "1e84fde78f69"
down_revision: Union[str, None] = "6a94c1aa01e0"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        """

with earliest_parent_msg as (
select
      parent_msg_uuid
    , min(timestamp) as early_timestamp

from ai_model.chat_history
group by
    parent_msg_uuid
)

, distinct_chat_results as (
select distinct
      result_uuid
    , parent_msg_uuid
    , timestamp

from ai_model.chat_history
where role = 'assistant'
)

UPDATE ai_model.result_history res
SET parent_msg_uuid = chat.parent_msg_uuid
FROM distinct_chat_results chat
INNER JOIN earliest_parent_msg early
    ON chat.parent_msg_uuid = early.parent_msg_uuid
    AND chat.timestamp = early.early_timestamp
WHERE res.result_uuid = chat.result_uuid
AND res.parent_msg_uuid IS NULL;
    """
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
