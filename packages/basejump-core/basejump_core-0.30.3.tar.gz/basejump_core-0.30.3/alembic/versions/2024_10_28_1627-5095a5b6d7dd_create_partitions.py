"""create_partitions

Revision ID: 5095a5b6d7dd
Revises: e568ab18eda0
Create Date: 2024-10-28 16:27:26.723515

"""

from typing import Sequence, Union

from alembic import op
from basejump.core.common.config.globalconfig import ENV, EnvType

# revision identifiers, used by Alembic.
revision: str = "5095a5b6d7dd"
down_revision: Union[str, None] = "e568ab18eda0"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    PARTITION_NM_ID = "_pclient"
    MODULUS = 10
    LOCAL_MODULUS = 1  # This is to speed up alembic checks
    if ENV == EnvType.LOCAL:
        for remainder in range(LOCAL_MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "connect.team_connection",
                "connect.table_connection",
                "connect.database_tables",
                "connect.table_columns",
                "ai_model.user_chat_id",
                "ai_model.prompt_history",
                "ai_model.chat_history",
                "ai_model.result_history",
                "ai_model.token_count",
                "transaction.deposit_history",
                "transaction.withdraw_history",
                "transaction.basejump_credit_ledger",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {LOCAL_MODULUS}, REMAINDER {remainder})"""
                )
    else:
        for remainder in range(MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "connect.team_connection",
                "connect.table_connection",
                "connect.database_tables",
                "connect.table_columns",
                "ai_model.user_chat_id",
                "ai_model.prompt_history",
                "ai_model.chat_history",
                "ai_model.result_history",
                "ai_model.token_count",
                "transaction.deposit_history",
                "transaction.withdraw_history",
                "transaction.basejump_credit_ledger",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {MODULUS}, REMAINDER {remainder})"""
                )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
