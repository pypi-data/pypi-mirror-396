"""hash partitions

Revision ID: e568ab18eda0
Revises:
Create Date: 2024-10-28 14:07:39.107984

"""

from typing import Sequence, Union

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "e568ab18eda0"
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    from basejump.core.database.crud.crud_utils import gen_client_id_suffixes
    from basejump.core.database.db_connect import ConnectDB, conn_params_noasync

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    suffixes = gen_client_id_suffixes(engine=basejump_engine_noasync, reverse=False, local_override=True)
    print("Running suffixes...", suffixes)
    for suffix in suffixes:
        print("Running suffix:", suffix)
        if not suffix or suffix == "0":
            continue
        # Drop the view
        op.execute(f"DROP VIEW IF EXISTS connect{suffix}.team_connection")
        op.execute(f"DROP VIEW IF EXISTS connect{suffix}.table_connection")
        op.execute(f"DROP VIEW IF EXISTS connect{suffix}.database_tables")
        op.execute(f"DROP VIEW IF EXISTS connect{suffix}.table_columns")
        op.execute(f"DROP VIEW IF EXISTS ai_model{suffix}.user_chat_id")
        op.execute(f"DROP VIEW IF EXISTS ai_model{suffix}.prompt_history")
        op.execute(f"DROP VIEW IF EXISTS ai_model{suffix}.chat_history")
        op.execute(f"DROP VIEW IF EXISTS ai_model{suffix}.result_history")
        op.execute(f"DROP VIEW IF EXISTS ai_model{suffix}.token_count")
        op.execute(f"DROP VIEW IF EXISTS transaction{suffix}.deposit_history")
        op.execute(f"DROP VIEW IF EXISTS transaction{suffix}.withdraw_history")
        op.execute(f"DROP VIEW IF EXISTS transaction{suffix}.basejump_credit_ledger")

    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        """
CREATE TABLE ai_model.prompt_history (
    client_id INT NOT NULL,
    prompt_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    prompt_uuid UUID DEFAULT gen_random_uuid(),
    PRIMARY KEY (client_id, prompt_id),
    UNIQUE (client_id, prompt_uuid),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE
) PARTITION BY HASH(client_id);
    """
    )
    op.execute(
        """
CREATE TABLE transaction.deposit_history (
    client_id INT NOT NULL,
    deposit_id INT GENERATED BY DEFAULT AS IDENTITY,
    deposit_uuid UUID DEFAULT gen_random_uuid(),
    sub_plan_id INT,
    transaction_item_description VARCHAR NOT NULL,
    transaction_item_quantity INT NOT NULL,
    transaction_item_cost DECIMAL NOT NULL,
    transaction_description VARCHAR NOT NULL,
    transaction_type VARCHAR NOT NULL,
    transaction_total_cost DECIMAL NOT NULL,
    deposited_credits INT NOT NULL,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, deposit_id),
    UNIQUE (client_id, deposit_uuid),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (sub_plan_id) REFERENCES account.subscription_plan(sub_plan_id)
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE transaction.withdraw_history (
    client_id INT NOT NULL,
    withdrawal_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    withdrawal_uuid UUID DEFAULT gen_random_uuid(),
    prompt_id BIGINT,
    sub_plan_id INT,
    transaction_amt DECIMAL NOT NULL,
    transaction_description VARCHAR NOT NULL,
    withdrawn_credits DECIMAL NOT NULL,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, withdrawal_id),
    UNIQUE (client_id, withdrawal_uuid),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, prompt_id) REFERENCES ai_model.prompt_history(client_id, prompt_id),
    FOREIGN KEY (sub_plan_id) REFERENCES account.subscription_plan(sub_plan_id)
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE ai_model.user_chat_id (
    client_id INT NOT NULL,
    chat_id SERIAL,
    chat_uuid UUID DEFAULT gen_random_uuid(),
    user_id INT NOT NULL,
    team_id INT NOT NULL,
    chat_name VARCHAR,
    chat_description VARCHAR,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    last_updt_date TIMESTAMPTZ,
    PRIMARY KEY (client_id, chat_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES account.user(user_id) ON DELETE CASCADE,
    FOREIGN KEY (team_id) REFERENCES account.team(team_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
    CREATE TABLE ai_model.chat_history (
    client_id INT NOT NULL,
    msg_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    msg_uuid UUID DEFAULT gen_random_uuid(),
    parent_msg_uuid UUID,
    result_uuid UUID,
    chat_id INT NOT NULL,
    prompt_uuid UUID NOT NULL,
    initial_prompt VARCHAR NOT NULL,
    prompt_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    content VARCHAR,
    internal_content VARCHAR,
    role VARCHAR,
    msg_type VARCHAR,
    sql_query VARCHAR,
    result_type VARCHAR,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, msg_id),
    UNIQUE (client_id, msg_uuid),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, chat_id) REFERENCES ai_model.user_chat_id(client_id, chat_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, prompt_uuid) REFERENCES ai_model.prompt_history(client_id, prompt_uuid) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE ai_model.result_history (
    client_id INT NOT NULL,
    result_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    result_uuid UUID DEFAULT gen_random_uuid(),
    result_conn_id INT NOT NULL,
    result_exp_time TIMESTAMPTZ NOT NULL,
    result_deleted BOOLEAN DEFAULT FALSE,
    result_file_path VARCHAR NOT NULL,
    row_num_total INT NOT NULL,
    preview_file_path VARCHAR NOT NULL,
    row_num_preview INT NOT NULL,
    result_type VARCHAR NOT NULL,
    title VARCHAR NOT NULL,
    description VARCHAR NOT NULL,
    author_user_uuid UUID NOT NULL,
    author_team_uuid UUID,
    share_w_team BOOLEAN DEFAULT FALSE,
    saved_result BOOLEAN DEFAULT FALSE,
    refresh_result BOOLEAN DEFAULT FALSE,
    sql_query VARCHAR NOT NULL,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, result_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (result_conn_id) REFERENCES connect.connection(conn_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE ai_model.token_count (
    client_id INT NOT NULL,
    token_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    token_uuid UUID DEFAULT gen_random_uuid(),
    prompt_id INT,
    prompt VARCHAR NOT NULL,
    user_id INT NOT NULL,
    team_id INT NOT NULL,
    ai_model_provider VARCHAR NOT NULL,
    ai_model_nm VARCHAR NOT NULL,  -- Consider changing this to an ENUM if applicable
    cost_per_1k_tokens_input DECIMAL NOT NULL,
    cost_per_1k_tokens_output DECIMAL NOT NULL,
    total_embedding_token_count DECIMAL NOT NULL,
    prompt_llm_token_count DECIMAL NOT NULL,
    completion_llm_token_count DECIMAL NOT NULL,
    total_llm_token_count DECIMAL NOT NULL,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, token_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, prompt_id) REFERENCES ai_model.prompt_history(client_id, prompt_id),
    FOREIGN KEY (user_id) REFERENCES account.user(user_id),
    FOREIGN KEY (team_id) REFERENCES account.team(team_id)
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE connect.team_connection (
    client_id INT NOT NULL,
    conn_id INT NOT NULL,
    team_id INT NOT NULL,
    PRIMARY KEY (client_id, conn_id, team_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (conn_id) REFERENCES connect.connection(conn_id) ON DELETE CASCADE,
    FOREIGN KEY (team_id) REFERENCES account.team(team_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
    CREATE TABLE transaction.basejump_credit_ledger (
    client_id INT NOT NULL,
    credit_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    credit_uuid UUID DEFAULT gen_random_uuid(),
    sub_id INT NOT NULL,
    withdrawal_id BIGINT,
    deposit_id INT,
    allotted_credit_bal DECIMAL NOT NULL,
    purchased_credit_bal DECIMAL DEFAULT 0,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, credit_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (sub_id) REFERENCES account.subscription(sub_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, withdrawal_id) REFERENCES transaction.withdraw_history(client_id, withdrawal_id),
    FOREIGN KEY (client_id, deposit_id) REFERENCES transaction.deposit_history(client_id, deposit_id) ON DELETE CASCADE
    ) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE connect.database_tables (
    client_id INT NOT NULL,
    tbl_id SERIAL,
    tbl_uuid UUID DEFAULT gen_random_uuid(),
    db_id INT NOT NULL,
    table_name VARCHAR NOT NULL,
    context VARCHAR,
    ignore BOOLEAN DEFAULT FALSE,
    primary_keys TEXT[],  -- PostgreSQL array of strings
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, tbl_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (db_id) REFERENCES connect.database(db_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE connect.table_columns (
    client_id INT NOT NULL,
    col_id SERIAL,
    col_uuid UUID DEFAULT gen_random_uuid(),
    tbl_id INT NOT NULL,
    column_name VARCHAR NOT NULL,
    column_type VARCHAR NOT NULL,
    description VARCHAR,
    foreign_key_table_name VARCHAR,
    foreign_key_column_name VARCHAR,
    primary_key BOOLEAN,
    distinct_values TEXT[],  -- PostgreSQL array of strings
    ignore BOOLEAN DEFAULT FALSE,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, col_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, tbl_id) REFERENCES connect.database_tables(client_id, tbl_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    op.execute(
        """
CREATE TABLE connect.table_connection (
    client_id INT NOT NULL,
    conn_id INT NOT NULL,
    tbl_id INT NOT NULL,
    PRIMARY KEY (client_id, conn_id, tbl_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (conn_id) REFERENCES connect.db_conn(conn_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, tbl_id) REFERENCES connect.database_tables(client_id, tbl_id) ON DELETE CASCADE
) PARTITION BY HASH (client_id);
    """
    )
    # ### end Alembic commands ###

    for suffix in suffixes:
        print("Creating views for suffix:", suffix)
        if not suffix or suffix == "0":
            continue
        for table in [
            "connect.team_connection",
            "connect.table_connection",
            "connect.database_tables",
            "connect.table_columns",
            "ai_model.user_chat_id ",
            "ai_model.prompt_history",
            "ai_model.chat_history",
            "ai_model.result_history",
            "ai_model.token_count",
            "transaction.deposit_history",
            "transaction.withdraw_history",
            "transaction.basejump_credit_ledger",
        ]:
            # Create views
            table_name_w_suffix = f"{table.split('.')[0] + suffix}.{table.split('.')[1]}"
            op.execute(
                f"""\
        CREATE VIEW {table_name_w_suffix} WITH(security_invoker=TRUE) AS \
        SELECT * FROM {table} \
        WHERE client_id = {suffix}"""
            )


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("table_connection", schema="connect")
    op.drop_table("table_columns", schema="connect")
    op.drop_table("database_tables", schema="connect")
    op.drop_table("basejump_credit_ledger", schema="transaction")
    op.drop_table("team_connection", schema="connect")
    op.drop_table("user_chat_id", schema="ai_model")
    op.drop_table("token_count", schema="ai_model")
    op.drop_table("result_history", schema="ai_model")
    op.drop_table("withdraw_history", schema="transaction")
    op.drop_table("deposit_history", schema="transaction")
    op.drop_table("prompt_history", schema="ai_model")
    op.drop_table("chat_history", schema="ai_model")
    # ### end Alembic commands ###
