"""Add visual result table

Revision ID: 242ed63a90d4
Revises: f4b056ee415f
Create Date: 2025-01-30 04:48:14.218004

"""

from typing import Sequence, Union

from alembic import op
from basejump.core.common.config.globalconfig import ENV, EnvType

# revision identifiers, used by Alembic.
revision: str = "242ed63a90d4"
down_revision: Union[str, None] = "f4b056ee415f"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        """CREATE TABLE ai_model.visual_result_history (
        client_id INT NOT NULL,
        visual_result_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
        visual_result_uuid UUID DEFAULT gen_random_uuid() NOT NULL,
        parent_msg_uuid UUID,
        result_id INT NOT NULL,
        result_uuid UUID NOT NULL,
        visual_json JSONB,
        visual_explanation VARCHAR,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NOT NULL,
        PRIMARY KEY (client_id, visual_result_id),
        FOREIGN KEY (client_id, result_id) REFERENCES ai_model.result_history(client_id, result_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE
    ) PARTITION BY HASH (client_id);"""
    )
    # ### end Alembic commands ###
    PARTITION_NM_ID = "_pclient"
    MODULUS = 10
    LOCAL_MODULUS = 1  # This is to speed up alembic checks
    if ENV == EnvType.LOCAL:
        for remainder in range(LOCAL_MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "ai_model.visual_result_history",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {LOCAL_MODULUS}, REMAINDER {remainder})"""
                )
    else:
        for remainder in range(MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "ai_model.visual_result_history",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {MODULUS}, REMAINDER {remainder})"""
                )


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_foreign_key(
        "user_tokens_client_id_token_id_fkey",
        "user_tokens",
        "token_count_pclient0",
        ["client_id", "token_id"],
        ["client_id", "token_id"],
        source_schema="ai_model",
        referent_schema="ai_model",
        ondelete="CASCADE",
    )
    # ### end Alembic commands ###
