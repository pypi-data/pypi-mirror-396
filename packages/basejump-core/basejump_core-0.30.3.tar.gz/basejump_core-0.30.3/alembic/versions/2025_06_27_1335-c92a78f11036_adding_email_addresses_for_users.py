"""Adding email addresses for users

Revision ID: c92a78f11036
Revises: 991d1cc5a9d8
Create Date: 2025-06-27 13:35:40.496030

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "c92a78f11036"
down_revision: Union[str, None] = "991d1cc5a9d8"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("user", sa.Column("email_address", sa.String(), nullable=True), schema="account")
    # ### end Alembic commands ###

    email_regex = r"^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$"

    op.execute(
        f"""
        UPDATE account.user
        SET email_address = username
        WHERE username ~* '{email_regex}';
        """
    )


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("user", "email_address", schema="account")
    # ### end Alembic commands ###
