"""adding new ssl cols to DB

Revision ID: ecf858ab7798
Revises: 26976d90c6b2
Create Date: 2025-01-18 13:40:45.526199

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "ecf858ab7798"
down_revision: Union[str, None] = "26976d90c6b2"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute("CREATE TYPE sslmodes AS ENUM ('REQUIRE', 'VERIFY_CA', 'VERIFY_FULL');")
    op.add_column(
        "database",
        sa.Column("ssl_mode", sa.Enum("REQUIRE", "VERIFY_CA", "VERIFY_FULL", name="sslmodes"), nullable=True),
        schema="connect",
    )
    op.execute("UPDATE connect.database SET ssl_mode = 'REQUIRE'")
    op.alter_column("database", "ssl_mode", nullable=False, schema="connect")
    op.add_column("database", sa.Column("ssl_root_cert", sa.String(), nullable=True), schema="connect")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("database", "ssl_root_cert", schema="connect")
    op.drop_column("database", "ssl_mode", schema="connect")
    op.create_foreign_key(
        "user_tokens_client_id_token_id_fkey",
        "user_tokens",
        "token_count_pclient0",
        ["client_id", "token_id"],
        ["client_id", "token_id"],
        source_schema="ai_model",
        referent_schema="ai_model",
        ondelete="CASCADE",
    )
    op.drop_column("token_count", "cost_per_1k_tokens_output", schema="ai_model")
    op.drop_column("token_count", "cost_per_1k_tokens_input", schema="ai_model")
    # ### end Alembic commands ###
