"""adding user_tokens partition

Revision ID: 231860cd0113
Revises: 113aaadff722
Create Date: 2024-11-18 10:36:49.624261

"""

from typing import Sequence, Union

from alembic import op
from basejump.core.common.config.globalconfig import ENV, EnvType

# revision identifiers, used by Alembic.
revision: str = "231860cd0113"
down_revision: Union[str, None] = "113aaadff722"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    op.execute(
        """CREATE TABLE IF NOT EXISTS ai_model.user_tokens (
        client_id INT NOT NULL,
        user_id INT NOT NULL,
        token_id INT NOT NULL,
        CONSTRAINT pk_user_tokens PRIMARY KEY (client_id, user_id, token_id),
        CONSTRAINT fk_user_tokens_client_token
            FOREIGN KEY (client_id, token_id)
            REFERENCES ai_model.token_count (client_id, token_id)
            ON DELETE CASCADE,
        CONSTRAINT fk_user_tokens_user
            FOREIGN KEY (user_id)
            REFERENCES account.user (user_id)
            ON DELETE CASCADE

    ) PARTITION BY HASH(client_id);"""
    )

    PARTITION_NM_ID = "_pclient"
    MODULUS = 10
    LOCAL_MODULUS = 1  # This is to speed up alembic checks
    if ENV == EnvType.LOCAL:
        for remainder in range(LOCAL_MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "ai_model.user_tokens",
                "connect.team_connection",
                "connect.table_connection",
                "connect.database_tables",
                "connect.table_columns",
                "ai_model.user_chat_id",
                "ai_model.prompt_history",
                "ai_model.chat_history",
                "ai_model.result_history",
                "ai_model.token_count",
                "transaction.deposit_history",
                "transaction.withdraw_history",
                "transaction.basejump_credit_ledger",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {LOCAL_MODULUS}, REMAINDER {remainder})"""
                )
    else:
        for remainder in range(MODULUS):
            # NOTE: These need to be added incrementally
            print("Creating partitions for INDEX:", remainder)
            for table in [
                "ai_model.user_tokens",
                "connect.team_connection",
                "connect.table_connection",
                "connect.database_tables",
                "connect.table_columns",
                "ai_model.user_chat_id",
                "ai_model.prompt_history",
                "ai_model.chat_history",
                "ai_model.result_history",
                "ai_model.token_count",
                "transaction.deposit_history",
                "transaction.withdraw_history",
                "transaction.basejump_credit_ledger",
            ]:
                print("Creating partitions for TABLE:", table)
                op.execute(
                    f"""CREATE TABLE IF NOT EXISTS {table}{PARTITION_NM_ID}{remainder} PARTITION OF {table} \
    FOR VALUES WITH (MODULUS {MODULUS}, REMAINDER {remainder})"""
                )
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
