"""fix DBParams and remove sql vector assoc tbl

Revision ID: a46b7a29afa1
Revises: 341e978e4e29
Create Date: 2024-08-28 18:22:09.740769

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "a46b7a29afa1"
down_revision: Union[str, None] = "341e978e4e29"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # NOTE: Create any new schemas
    from basejump.core.database.setup_db.db_connect import (
        ConnectDB,
        conn_params_noasync,
    )
    from sqlalchemy import text

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    # for suffix in ["", "0", "10", "11"]:
    for suffix in ["", "0"]:
        for schema in ["connect", "ai_model", "account", "transaction", "migration"]:
            with basejump_engine_noasync.begin() as conn:
                conn.execute(text(f"CREATE SCHEMA IF NOT EXISTS {schema}{suffix}"))
        # ### commands auto generated by Alembic - please adjust! ###

        op.drop_table("sql_vector", schema=f"connect{suffix}")

        op.add_column("database", sa.Column("vector_conn_id", sa.Integer(), nullable=False), schema=f"connect{suffix}")

        op.create_foreign_key(
            None,
            "database",
            "vector_db",
            ["vector_conn_id"],
            ["vector_conn_id"],
            source_schema=f"connect{suffix}",
            referent_schema=f"connect{suffix}",
            ondelete="CASCADE",
        )
        # ### end Alembic commands ###


def downgrade() -> None:
    # NOTE: Create any new schemas
    from basejump.core.database.setup_db.db_connect import (
        ConnectDB,
        conn_params_noasync,
    )
    from sqlalchemy import text

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    for suffix in ["145", "142", "141", "122", "116", "114", "113", "11", "106", "10", "0", ""]:
        for schema in ["connect", "ai_model", "account", "transaction", "migration"]:
            with basejump_engine_noasync.begin() as conn:
                conn.execute(text(f"CREATE SCHEMA IF NOT EXISTS {schema}{suffix}"))
        # ### commands auto generated by Alembic - please adjust! ###
        op.drop_constraint(None, "database", schema=f"connect{suffix}", type_="foreignkey")
        op.drop_column("database", "vector_conn_id", schema=f"connect{suffix}")
        op.create_table(
            "sql_vector",
            sa.Column("vector_conn_id", sa.INTEGER(), autoincrement=False, nullable=False),
            sa.Column("db_id", sa.INTEGER(), autoincrement=False, nullable=False),
            sa.ForeignKeyConstraint(
                ["db_id"], [f"connect{suffix}.database.db_id"], name="sql_vector_db_id_fkey", ondelete="CASCADE"
            ),
            sa.ForeignKeyConstraint(
                ["vector_conn_id"],
                [f"connect{suffix}.vector_db.vector_conn_id"],
                name="sql_vector_vector_conn_id_fkey",
                ondelete="CASCADE",
            ),
            schema=f"connect{suffix}",
        )
        # ### end Alembic commands ###
