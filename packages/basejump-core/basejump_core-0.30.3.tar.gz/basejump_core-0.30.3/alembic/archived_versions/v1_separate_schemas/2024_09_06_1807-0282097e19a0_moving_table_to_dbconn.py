"""Moving table to DBConn

Revision ID: 0282097e19a0
Revises: 77ece048ced8
Create Date: 2024-09-06 18:07:15.633297

"""

import json
import uuid
from datetime import datetime
from typing import Sequence, Union

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision: str = "0282097e19a0"
down_revision: Union[str, None] = "77ece048ced8"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # NOTE: Create any new schemas
    from basejump.core.database.crud.crud_utils import gen_client_id_suffixes
    from basejump.core.database.db_connect import ConnectDB, conn_params_noasync
    from sqlalchemy import text

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    suffixes = gen_client_id_suffixes(engine=basejump_engine_noasync, reverse=False)
    print("running suffixes:", suffixes)
    for suffix in suffixes:
        for schema in ["connect", "ai_model", "account", "transaction", "migration"]:
            with basejump_engine_noasync.begin() as conn:
                conn.execute(text(f"CREATE SCHEMA IF NOT EXISTS {schema}{suffix}"))
        # ### commands auto generated by Alembic - please adjust! ###

        # Create fake records so values can be inserted
        # Insert into the vector table

        op.execute(
            f"""INSERT INTO connect{suffix}.vector_db (vector_conn_id,vector_uuid,vector_database_vendor,
vector_datasource_type,api_key,environment,index_name,vector_metadata,timestamp) VALUES (0,'{uuid.uuid4()}'\
,'filler','filler','filler','filler','filler', '{json.dumps({})}','{datetime.now()}')"""
        )

        # Insert into the Database table
        op.execute(
            f"""INSERT INTO connect{suffix}.database VALUES (0,'{uuid.uuid4()}',0,'{b'filler'.hex()}',\
'{b'filler'.hex()}','{b'filler'.hex()}','{b'filler'.hex()}','{b'filler'.hex()}','{b'filler'.hex()}','{b'filler'.hex()}','{b'filler'.hex()}'\
,'{b'filler'.hex()}','{datetime.now()}')"""
        )

        # Insert into the client table
        if not suffix:
            op.execute(f"INSERT INTO account.client VALUES (0,'{uuid.uuid4()}','filler','filler','{datetime.now()}')")

        # Insert into the Connection table
        op.execute(f"INSERT INTO connect{suffix}.connection VALUES (0,'{uuid.uuid4()}',0,'filler','filler')")

        # Insert into the DB conn table
        op.execute(f"INSERT INTO connect{suffix}.db_conn VALUES (0,0,'filler','filler','{datetime.now()}')")

        op.add_column(
            "database_tables",
            sa.Column("conn_id", sa.Integer(), nullable=False, server_default="0"),
            schema=f"connect{suffix}",
        )
        op.drop_constraint(
            "database_tables_db_id_fkey", "database_tables", schema=f"connect{suffix}", type_="foreignkey"
        )
        op.create_foreign_key(
            None,
            "database_tables",
            "db_conn",
            ["conn_id"],
            ["conn_id"],
            source_schema=f"connect{suffix}",
            referent_schema=f"connect{suffix}",
            ondelete="CASCADE",
        )
        op.drop_column("database_tables", "db_id", schema=f"connect{suffix}")
        # ### end Alembic commands ###


def downgrade() -> None:
    # NOTE: Create any new schemas
    raise Exception("Not yet implemented - refer to the above code")
    from basejump.core.database.db_utils import gen_client_id_suffixes
    from basejump.core.database.setup_db.db_connect import (
        ConnectDB,
        conn_params_noasync,
    )
    from sqlalchemy import text

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    suffixes = gen_client_id_suffixes(True)
    print("running suffixes:", suffixes)
    for suffix in suffixes:
        for schema in ["connect", "ai_model", "account", "transaction", "migration"]:
            with basejump_engine_noasync.begin() as conn:
                conn.execute(text(f"CREATE SCHEMA IF NOT EXISTS {schema}{suffix}"))
        # ### commands auto generated by Alembic - please adjust! ###
        op.add_column(
            "database_tables",
            sa.Column("db_id", sa.INTEGER(), autoincrement=False, nullable=False),
            schema=f"connect{suffix}",
        )
        op.drop_constraint(None, "database_tables", schema=f"connect{suffix}", type_="foreignkey")
        op.create_foreign_key(
            "database_tables_db_id_fkey",
            "database_tables",
            "database",
            ["db_id"],
            ["db_id"],
            source_schema=f"connect{suffix}",
            referent_schema=f"connect{suffix}",
            ondelete="CASCADE",
        )
        op.drop_column("database_tables", "conn_id", schema=f"connect{suffix}")
        # ### end Alembic commands ###
