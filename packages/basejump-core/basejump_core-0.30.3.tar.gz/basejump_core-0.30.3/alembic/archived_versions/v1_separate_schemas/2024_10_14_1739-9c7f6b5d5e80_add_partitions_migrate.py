"""add partitionsz

Revision ID: 9c7f6b5d5e80
Revises:
Create Date: 2024-10-14 17:39:50.417517

"""

from typing import Sequence, Union

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "9c7f6b5d5e80"
down_revision: Union[str, None] = "51fb0eff807a"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # 1.  account.user_team
    # 2.  [x] connect.team_connection (partition) -- needs insert
    # 3.  [x] connect.table_connection (partition) -- needs insert
    # 4.  account.client
    # 5.  account.team
    # 6.  account.user
    # 7.  connect.connection -- needs views
    # 8.  connect.database -- needs views
    # 9.  connect.db_conn -- needs views
    # 10. connect.vector_db -- needs views
    # 11. [x] connect.database_tables (partition)
    # 12. [x] connect.table_columns (partition)
    # 13. [x] ai_model.user_chat_id  (partition)
    # 14. [x] ai_model.prompt_history (partition)
    # 15. [x] ai_model.chat_history (partition)
    # 16. [x] ai_model.result_history (partition)
    # 17. [x] ai_model.token_count (partition)
    # 18. account.subscription
    # 19. account.subscription_plan
    # 20. [x] transaction.deposit_history (partition)
    # 21. [x] transaction.withdraw_history (partition)
    # 22. [x] transaction.basejump_credit_ledger (partition)

    # TODO
    # Get a list of all of the client IDs (just union all of the below tables)
    from basejump.core.database.crud.crud_utils import gen_client_id_suffixes
    from basejump.core.database.db_connect import ConnectDB, conn_params_noasync

    conn_db = ConnectDB(conn_params=conn_params_noasync)
    basejump_engine_noasync = conn_db.connect_db()
    suffixes = gen_client_id_suffixes(engine=basejump_engine_noasync, reverse=False)
    print("running suffixes:", suffixes)
    print("Updating connect.connection...")
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.connection CASCADE")
        # Create views
        op.execute(
            f"""\
    CREATE VIEW connect{suffix}.connection WITH(security_invoker=TRUE) AS \
    SELECT * FROM connect.connection \
    WHERE client_id = {suffix}"""
        )
    print("Updating connect.database...")
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.database CASCADE")
        # Create views
        op.execute(
            f"""\
    CREATE VIEW connect{suffix}.database WITH(security_invoker=TRUE) AS \
    SELECT * FROM connect.database \
    WHERE client_id = {suffix}"""
        )
    print("Updating connect.db_conn...")
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.db_conn CASCADE")
        # Create views
        op.execute(
            f"""\
    CREATE VIEW connect{suffix}.db_conn WITH(security_invoker=TRUE) AS \
    SELECT * FROM connect.db_conn \
    WHERE client_id = {suffix}"""
        )
    print("Updating connect.vector_db...")
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.vector_db CASCADE")
        # Create views
        op.execute(
            f"""\
    CREATE VIEW connect{suffix}.vector_db WITH(security_invoker=TRUE) AS \
    SELECT * FROM connect.vector_db \
    WHERE client_id = {suffix}"""
        )
    print("Creating ai_model.prompt_history...")
    op.execute(
        """
    CREATE TABLE ai_model.prompt_history_migrate (
        client_id INT NOT NULL,
        prompt_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        prompt_uuid UUID DEFAULT gen_random_uuid(),
        PRIMARY KEY (client_id, prompt_id),
        UNIQUE (client_id, prompt_uuid),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE
    ) PARTITION BY LIST(client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Create partitions
        op.execute(
            f"CREATE TABLE ai_model.prompt_history_pclient{suffix} PARTITION OF ai_model.prompt_history_migrate FOR VALUES IN ({suffix})"
        )
    op.execute(
        "INSERT INTO ai_model.prompt_history_migrate (client_id, prompt_id, prompt_uuid) SELECT client_id, prompt_id, prompt_uuid FROM ai_model.prompt_history"
    )
    op.execute("DROP TABLE ai_model.prompt_history CASCADE")
    op.execute("ALTER TABLE ai_model.prompt_history_migrate RENAME TO prompt_history")
    op.execute(
        "SELECT setval('ai_model.prompt_history_migrate_prompt_id_seq', (SELECT MAX(prompt_id) FROM ai_model.prompt_history));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE ai_model{suffix}.prompt_history CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW ai_model{suffix}.prompt_history WITH(security_invoker=TRUE) AS \
SELECT * FROM ai_model.prompt_history \
WHERE client_id = {suffix}"""
        )
    print("Creating transaction.deposit_history...")
    op.execute(
        """
    CREATE TABLE transaction.deposit_history_migrate (
        client_id INT NOT NULL,
        deposit_id INT GENERATED BY DEFAULT AS IDENTITY,
        deposit_uuid UUID DEFAULT gen_random_uuid(),
        sub_plan_id INT,
        transaction_item_description VARCHAR NOT NULL,
        transaction_item_quantity INT NOT NULL,
        transaction_item_cost DECIMAL NOT NULL,
        transaction_description VARCHAR NOT NULL,
        transaction_type VARCHAR NOT NULL,
        transaction_total_cost DECIMAL NOT NULL,
        deposited_credits INT NOT NULL,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, deposit_id),
        UNIQUE (client_id, deposit_uuid),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (sub_plan_id) REFERENCES account.subscription_plan(sub_plan_id)
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE transaction.deposit_history_pclient{suffix} PARTITION OF transaction.deposit_history_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO transaction.deposit_history_migrate (client_id,deposit_id,deposit_uuid,sub_plan_id,transaction_item_description,transaction_item_quantity,transaction_item_cost,transaction_description,transaction_type,transaction_total_cost,deposited_credits,timestamp) SELECT client_id,deposit_id,deposit_uuid,sub_plan_id,transaction_item_description,transaction_item_quantity,transaction_item_cost,transaction_description,transaction_type,transaction_total_cost,deposited_credits,timestamp FROM transaction.deposit_history"
    )
    op.execute("DROP TABLE transaction.deposit_history CASCADE")
    op.execute("ALTER TABLE transaction.deposit_history_migrate RENAME TO deposit_history")
    op.execute(
        "SELECT setval('transaction.deposit_history_migrate_deposit_id_seq', (SELECT MAX(deposit_id) FROM transaction.deposit_history));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE transaction{suffix}.deposit_history CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW transaction{suffix}.deposit_history WITH(security_invoker=TRUE) AS \
SELECT * FROM transaction.deposit_history \
WHERE client_id = {suffix}"""
        )
    print("Creating ai_model.result_history...")
    op.execute(
        """
    CREATE TABLE ai_model.result_history_migrate (
        client_id INT NOT NULL,
        result_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        result_uuid UUID DEFAULT gen_random_uuid(),
        result_conn_id INT NOT NULL,
        result_exp_time TIMESTAMPTZ NOT NULL,
        result_deleted BOOLEAN DEFAULT FALSE,
        result_file_path VARCHAR NOT NULL,
        row_num_total INT NOT NULL,
        preview_file_path VARCHAR NOT NULL,
        row_num_preview INT NOT NULL,
        result_type VARCHAR NOT NULL,
        title VARCHAR NOT NULL,
        description VARCHAR NOT NULL,
        author_user_uuid UUID NOT NULL,
        author_team_uuid UUID,
        share_w_team BOOLEAN DEFAULT FALSE,
        saved_result BOOLEAN DEFAULT FALSE,
        refresh_result BOOLEAN DEFAULT FALSE,
        sql_query VARCHAR NOT NULL,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, result_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (result_conn_id) REFERENCES connect.connection(conn_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE ai_model.result_history_pclient{suffix} PARTITION OF ai_model.result_history_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO ai_model.result_history_migrate (client_id,result_id,result_uuid,result_conn_id,result_exp_time,result_deleted,result_file_path,row_num_total,preview_file_path,row_num_preview,result_type,title,description,author_user_uuid,author_team_uuid,share_w_team,saved_result,refresh_result,sql_query,timestamp) SELECT client_id,result_id,result_uuid,result_conn_id,result_exp_time,result_deleted,result_file_path,row_num_total,preview_file_path,row_num_preview,result_type,title,description,author_user_uuid,author_team_uuid,share_w_team,saved_result,refresh_result,sql_query,timestamp FROM ai_model.result_history"
    )
    op.execute("DROP TABLE ai_model.result_history CASCADE")
    op.execute("ALTER TABLE ai_model.result_history_migrate RENAME TO result_history")
    op.execute(
        "SELECT setval('ai_model.result_history_migrate_result_id_seq', (SELECT MAX(result_id) FROM ai_model.result_history));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE ai_model{suffix}.result_history CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW ai_model{suffix}.result_history WITH(security_invoker=TRUE) AS \
SELECT * FROM ai_model.result_history \
WHERE client_id = {suffix}"""
        )
    print("Creating ai_model.token_count...")
    op.execute(
        """
    CREATE TABLE ai_model.token_count_migrate (
        client_id INT NOT NULL,
        token_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        token_uuid UUID DEFAULT gen_random_uuid(),
        prompt_id INT,
        prompt VARCHAR NOT NULL,
        user_id INT NOT NULL,
        team_id INT NOT NULL,
        ai_model_provider VARCHAR NOT NULL,
        ai_model_nm VARCHAR NOT NULL,  -- Consider changing this to an ENUM if applicable
        cost_per_1k_tokens_input DECIMAL NOT NULL,
        cost_per_1k_tokens_output DECIMAL NOT NULL,
        total_embedding_token_count DECIMAL NOT NULL,
        prompt_llm_token_count DECIMAL NOT NULL,
        completion_llm_token_count DECIMAL NOT NULL,
        total_llm_token_count DECIMAL NOT NULL,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, token_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, prompt_id) REFERENCES ai_model.prompt_history(client_id, prompt_id),
        FOREIGN KEY (user_id) REFERENCES account.user(user_id),
        FOREIGN KEY (team_id) REFERENCES account.team(team_id)
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE ai_model.token_count_pclient{suffix} PARTITION OF ai_model.token_count_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO ai_model.token_count_migrate (client_id,token_id,token_uuid,prompt_id,prompt,user_id,team_id,ai_model_provider,ai_model_nm,cost_per_1k_tokens_input,cost_per_1k_tokens_output,total_embedding_token_count,prompt_llm_token_count,completion_llm_token_count,total_llm_token_count,timestamp) SELECT client_id,token_id,token_uuid,prompt_id,prompt,user_id,team_id,ai_model_provider,ai_model_nm,cost_per_1k_tokens_input,cost_per_1k_tokens_output,total_embedding_token_count,prompt_llm_token_count,completion_llm_token_count,total_llm_token_count,timestamp FROM ai_model.token_count"
    )
    op.execute("DROP TABLE ai_model.token_count CASCADE")
    op.execute("ALTER TABLE ai_model.token_count_migrate RENAME TO token_count")
    op.execute(
        "SELECT setval('ai_model.token_count_migrate_token_id_seq', (SELECT MAX(token_id) FROM ai_model.token_count));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE ai_model{suffix}.token_count CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW ai_model{suffix}.token_count WITH(security_invoker=TRUE) AS \
SELECT * FROM ai_model.token_count \
WHERE client_id = {suffix}"""
        )
    print("Creating ai_model.user_chat_id...")
    op.execute(
        """
    CREATE TABLE ai_model.user_chat_id_migrate (
        client_id INT NOT NULL,
        chat_id SERIAL,
        chat_uuid UUID DEFAULT gen_random_uuid(),
        user_id INT NOT NULL,
        team_id INT NOT NULL,
        chat_name VARCHAR,
        chat_description VARCHAR,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        last_updt_date TIMESTAMPTZ,
        PRIMARY KEY (client_id, chat_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES account.user(user_id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES account.team(team_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE ai_model.user_chat_id_pclient{suffix} PARTITION OF ai_model.user_chat_id_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO ai_model.user_chat_id_migrate (client_id,chat_id,chat_uuid,user_id,team_id,chat_name,chat_description,timestamp,last_updt_date) SELECT client_id,chat_id,chat_uuid,user_id,team_id,chat_name,chat_description,timestamp,last_updt_date FROM ai_model.user_chat_id"
    )
    op.execute("DROP TABLE ai_model.user_chat_id CASCADE")
    op.execute("ALTER TABLE ai_model.user_chat_id_migrate RENAME TO user_chat_id")
    op.execute(
        "SELECT setval('ai_model.user_chat_id_migrate_chat_id_seq', (SELECT MAX(chat_id) FROM ai_model.user_chat_id));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE ai_model{suffix}.user_chat_id CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW ai_model{suffix}.user_chat_id WITH(security_invoker=TRUE) AS \
SELECT * FROM ai_model.user_chat_id \
WHERE client_id = {suffix}"""
        )
    print("Creating connect.team_connection...")
    op.execute(
        """
    CREATE TABLE connect.team_connection_migrate (
        client_id INT NOT NULL,
        conn_id INT NOT NULL,
        team_id INT NOT NULL,
        PRIMARY KEY (client_id, conn_id, team_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (conn_id) REFERENCES connect.connection(conn_id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES account.team(team_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE connect.team_connection_pclient{suffix} PARTITION OF connect.team_connection_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO connect.team_connection_migrate (client_id,conn_id,team_id) SELECT client_id,conn_id,team_id FROM connect.team_connection"
    )
    op.execute("DROP TABLE connect.team_connection CASCADE")
    op.execute("ALTER TABLE connect.team_connection_migrate RENAME TO team_connection")
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.team_connection CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW connect{suffix}.team_connection WITH(security_invoker=TRUE) AS \
SELECT * FROM connect.team_connection \
WHERE client_id = {suffix}"""
        )
    print("Creating transaction.withdraw_history...")
    op.execute(
        """
    CREATE TABLE transaction.withdraw_history_migrate (
        client_id INT NOT NULL,
        withdrawal_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        withdrawal_uuid UUID DEFAULT gen_random_uuid(),
        prompt_id BIGINT,
        sub_plan_id INT,
        transaction_amt DECIMAL NOT NULL,
        transaction_description VARCHAR NOT NULL,
        withdrawn_credits DECIMAL NOT NULL,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, withdrawal_id),
        UNIQUE (client_id, withdrawal_uuid),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, prompt_id) REFERENCES ai_model.prompt_history(client_id, prompt_id),
        FOREIGN KEY (sub_plan_id) REFERENCES account.subscription_plan(sub_plan_id)
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE transaction.withdraw_history_pclient{suffix} PARTITION OF transaction.withdraw_history_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO transaction.withdraw_history_migrate (client_id,withdrawal_id,withdrawal_uuid,prompt_id,sub_plan_id,transaction_amt,transaction_description,withdrawn_credits,timestamp) SELECT client_id,withdrawal_id,withdrawal_uuid,prompt_id,sub_plan_id,transaction_amt,transaction_description,withdrawn_credits,timestamp FROM transaction.withdraw_history"
    )
    op.execute("DROP TABLE transaction.withdraw_history CASCADE")
    op.execute("ALTER TABLE transaction.withdraw_history_migrate RENAME TO withdraw_history")
    op.execute(
        "SELECT setval('transaction.withdraw_history_migrate_withdrawal_id_seq', (SELECT MAX(withdrawal_id) FROM transaction.withdraw_history));"
    )

    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE transaction{suffix}.withdraw_history CASCADE")
        # Create views
        op.execute(
            f"""\
        CREATE VIEW transaction{suffix}.withdraw_history WITH(security_invoker=TRUE) AS \
        SELECT * FROM transaction.withdraw_history \
        WHERE client_id = {suffix}"""
        )

    print("Creating ai_model.chat_history...")
    op.execute(
        """
        CREATE TABLE ai_model.chat_history_migrate (
        client_id INT NOT NULL,
        msg_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
        msg_uuid UUID DEFAULT gen_random_uuid(),
        parent_msg_uuid UUID,
        result_uuid UUID,
        chat_id INT NOT NULL,
        prompt_uuid UUID NOT NULL,
        initial_prompt VARCHAR NOT NULL,
        prompt_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        content VARCHAR,
        internal_content VARCHAR,
        role VARCHAR,
        msg_type VARCHAR,
        sql_query VARCHAR,
        result_type VARCHAR,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, msg_id),
        UNIQUE (client_id, msg_uuid),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, chat_id) REFERENCES ai_model.user_chat_id(client_id, chat_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, prompt_uuid) REFERENCES ai_model.prompt_history(client_id, prompt_uuid) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE ai_model.chat_history_pclient{suffix} PARTITION OF ai_model.chat_history_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO ai_model.chat_history_migrate (client_id,msg_id,msg_uuid,parent_msg_uuid,result_uuid,chat_id,prompt_uuid,initial_prompt,prompt_time,content,internal_content,role,msg_type,sql_query,result_type,timestamp) SELECT client_id,msg_id,msg_uuid,parent_msg_uuid,result_uuid,chat_id,prompt_uuid,initial_prompt,prompt_time,content,internal_content,role,msg_type,sql_query,result_type,timestamp FROM ai_model.chat_history"
    )
    op.execute("DROP TABLE ai_model.chat_history CASCADE")
    op.execute("ALTER TABLE ai_model.chat_history_migrate RENAME TO chat_history")
    op.execute(
        "SELECT setval('ai_model.chat_history_migrate_msg_id_seq', (SELECT MAX(msg_id) FROM ai_model.chat_history));"
    )

    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE ai_model{suffix}.chat_history CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW ai_model{suffix}.chat_history WITH(security_invoker=TRUE) AS \
SELECT * FROM ai_model.chat_history \
WHERE client_id = {suffix}"""
        )
    print("Creating transaction.basejump_credit_ledger...")
    op.execute(
        """
    CREATE TABLE transaction.basejump_credit_ledger_migrate (
    client_id INT NOT NULL,
    credit_id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    credit_uuid UUID DEFAULT gen_random_uuid(),
    sub_id INT NOT NULL,
    withdrawal_id BIGINT,
    deposit_id INT,
    allotted_credit_bal DECIMAL NOT NULL,
    purchased_credit_bal DECIMAL DEFAULT 0,
    timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (client_id, credit_id),
    FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (sub_id) REFERENCES account.subscription(sub_id) ON DELETE CASCADE,
    FOREIGN KEY (client_id, withdrawal_id) REFERENCES transaction.withdraw_history(client_id, withdrawal_id),
    FOREIGN KEY (client_id, deposit_id) REFERENCES transaction.deposit_history(client_id, deposit_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
    """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE transaction.basejump_credit_ledger_pclient{suffix} PARTITION OF transaction.basejump_credit_ledger_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO transaction.basejump_credit_ledger_migrate (client_id,credit_id,credit_uuid,sub_id,withdrawal_id,deposit_id,allotted_credit_bal,purchased_credit_bal,timestamp) SELECT client_id,credit_id,credit_uuid,sub_id,withdrawal_id,deposit_id,allotted_credit_bal,purchased_credit_bal,timestamp FROM transaction.basejump_credit_ledger"
    )
    op.execute("DROP TABLE transaction.basejump_credit_ledger")
    op.execute("ALTER TABLE transaction.basejump_credit_ledger_migrate RENAME TO basejump_credit_ledger")
    op.execute(
        "SELECT setval('transaction.basejump_credit_ledger_migrate_credit_id_seq', (SELECT MAX(credit_id) FROM transaction.basejump_credit_ledger));"
    )

    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE transaction{suffix}.basejump_credit_ledger CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW transaction{suffix}.basejump_credit_ledger WITH(security_invoker=TRUE) AS \
SELECT * FROM transaction.basejump_credit_ledger \
WHERE client_id = {suffix}"""
        )
    print("Creating connect.database_tables...")
    op.execute(
        """
    CREATE TABLE connect.database_tables_migrate (
        client_id INT NOT NULL,
        tbl_id SERIAL,
        tbl_uuid UUID DEFAULT gen_random_uuid(),
        conn_id INT,
        conn_uuid UUID,
        db_id INT NOT NULL,
        table_name VARCHAR NOT NULL,
        context VARCHAR,
        ignore BOOLEAN DEFAULT FALSE,
        primary_keys TEXT[],  -- PostgreSQL array of strings
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, tbl_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (conn_id) REFERENCES connect.db_conn(conn_id) ON DELETE CASCADE,
        FOREIGN KEY (db_id) REFERENCES connect.database(db_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE connect.database_tables_pclient{suffix} PARTITION OF connect.database_tables_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO connect.database_tables_migrate (client_id,tbl_id,tbl_uuid,conn_id,conn_uuid,db_id,table_name,context,ignore,primary_keys,timestamp) SELECT client_id,tbl_id,tbl_uuid,conn_id,conn_uuid,db_id,table_name,context,ignore,primary_keys,timestamp FROM connect.database_tables"
    )
    op.execute("DROP TABLE connect.database_tables CASCADE")
    op.execute("ALTER TABLE connect.database_tables_migrate RENAME TO database_tables")
    op.execute(
        "SELECT setval('connect.database_tables_migrate_tbl_id_seq', (SELECT MAX(tbl_id) FROM connect.database_tables));"
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.database_tables CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW connect{suffix}.database_tables WITH(security_invoker=TRUE) AS \
SELECT * FROM connect.database_tables \
WHERE client_id = {suffix}"""
        )
    print("Creating connect.table_columns...")
    op.execute(
        """
    CREATE TABLE connect.table_columns_migrate (
        client_id INT NOT NULL,
        col_id SERIAL,
        col_uuid UUID DEFAULT gen_random_uuid(),
        tbl_id INT NOT NULL,
        column_name VARCHAR NOT NULL,
        column_type VARCHAR NOT NULL,
        description VARCHAR,
        foreign_key_table_name VARCHAR,
        foreign_key_column_name VARCHAR,
        primary_key BOOLEAN,
        distinct_values TEXT[],  -- PostgreSQL array of strings
        ignore BOOLEAN DEFAULT FALSE,
        timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (client_id, col_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, tbl_id) REFERENCES connect.database_tables(client_id, tbl_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE connect.table_columns_pclient{suffix} PARTITION OF connect.table_columns_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO connect.table_columns_migrate (client_id,col_id,col_uuid,tbl_id,column_name,column_type,description,foreign_key_table_name,foreign_key_column_name,primary_key,distinct_values,ignore,timestamp) SELECT client_id,col_id,col_uuid,tbl_id,column_name,column_type,description,foreign_key_table_name,foreign_key_column_name,primary_key,distinct_values,ignore,timestamp FROM connect.table_columns"
    )
    op.execute("DROP TABLE connect.table_columns CASCADE")
    op.execute("ALTER TABLE connect.table_columns_migrate RENAME TO table_columns")
    op.execute(
        "SELECT setval('connect.table_columns_migrate_col_id_seq', (SELECT MAX(col_id) FROM connect.table_columns));"
    )

    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.table_columns CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW connect{suffix}.table_columns WITH(security_invoker=TRUE) AS \
SELECT * FROM connect.table_columns \
WHERE client_id = {suffix}"""
        )
    print("Creating connect.table_connection...")
    op.execute(
        """
    CREATE TABLE connect.table_connection_migrate (
        client_id INT NOT NULL,
        conn_id INT NOT NULL,
        tbl_id INT NOT NULL,
        PRIMARY KEY (client_id, conn_id, tbl_id),
        FOREIGN KEY (client_id) REFERENCES account.client(client_id) ON DELETE CASCADE,
        FOREIGN KEY (conn_id) REFERENCES connect.db_conn(conn_id) ON DELETE CASCADE,
        FOREIGN KEY (client_id, tbl_id) REFERENCES connect.database_tables(client_id, tbl_id) ON DELETE CASCADE
    ) PARTITION BY LIST (client_id);
        """
    )
    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        op.execute(
            f"""CREATE TABLE connect.table_connection_pclient{suffix} PARTITION OF connect.table_connection_migrate FOR VALUES IN ({suffix})"""
        )
    op.execute(
        "INSERT INTO connect.table_connection_migrate (client_id,conn_id,tbl_id) SELECT client_id,conn_id,tbl_id FROM connect.table_connection"
    )
    op.execute("DROP TABLE connect.table_connection CASCADE")
    op.execute("ALTER TABLE connect.table_connection_migrate RENAME TO table_connection")

    for suffix in suffixes:
        if not suffix or suffix == 0:
            continue
        # Drop the old table
        op.execute(f"DROP TABLE connect{suffix}.table_connection CASCADE")
        # Create views
        op.execute(
            f"""\
CREATE VIEW connect{suffix}.table_connection WITH(security_invoker=TRUE) AS \
SELECT * FROM connect.table_connection \
WHERE client_id = {suffix}"""
        )


# ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("table_connection", schema="connect")
    op.drop_table("table_columns", schema="connect")
    op.drop_table("database_tables", schema="connect")
    op.drop_table("basejump_credit_ledger", schema="transaction")
    op.drop_table("db_conn", schema="connect")
    op.drop_table("chat_history", schema="ai_model")
    op.drop_table("withdraw_history", schema="transaction")
    op.drop_table("team_connection", schema="connect")
    op.drop_table("database", schema="connect")
    op.drop_table("user_chat_id", schema="ai_model")
    op.drop_table("token_count", schema="ai_model")
    op.drop_table("result_history", schema="ai_model")
    op.drop_table("user_team", schema="account")
    op.drop_table("deposit_history", schema="transaction")
    op.drop_table("vector_db", schema="connect")
    op.drop_table("connection", schema="connect")
    op.drop_table("prompt_history", schema="ai_model")
    op.drop_table("user", schema="account")
    op.drop_table("team", schema="account")
    op.drop_table("subscription", schema="account")
    op.drop_table("subscription_plan", schema="account")
    op.drop_table("client", schema="account")
    # ### end Alembic commands ###
