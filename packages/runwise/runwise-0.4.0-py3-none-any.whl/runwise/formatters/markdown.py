"""
Markdown formatter for Runwise output.

Converts Runwise summaries to GitHub-flavored markdown for use in:
- GitHub issues/PRs
- Notion
- Documentation
- Reports

Usage:
    from runwise.formatters.markdown import MarkdownFormatter, to_markdown

    # Use formatter instance
    fmt = MarkdownFormatter()
    md = fmt.format_run_summary(run, summary_text)

    # Or use convenience function
    md = to_markdown(summary_text)
"""

import re
from dataclasses import dataclass

from ..core import RunInfo


@dataclass
class MarkdownFormatter:
    """Converts Runwise output to GitHub-flavored markdown."""

    include_header: bool = True
    include_footer: bool = True
    code_fence_tables: bool = False  # If True, wrap tables in code blocks

    def format_run_summary(
        self,
        run: RunInfo,
        summary_text: str,
        include_collapsible_config: bool = True,
    ) -> str:
        """
        Format a run summary as markdown.

        Args:
            run: RunInfo object for the run
            summary_text: Plain text summary from RunAnalyzer.summarize_run()
            include_collapsible_config: Wrap config in <details> tag

        Returns:
            GitHub-flavored markdown string
        """
        lines = []

        if self.include_header:
            lines.append(f"## Run Summary: `{run.run_id}`")
            lines.append("")

        # Parse and convert the summary text
        lines.extend(self._convert_summary(summary_text))

        # Add run metadata
        if run.name or run.tags or run.notes:
            lines.append("")
            lines.append("### Run Context")
            if run.name:
                lines.append(f"- **Name:** {run.name}")
            if run.group:
                lines.append(f"- **Group:** {run.group}")
            if run.tags:
                tags_str = " ".join(f"`{tag}`" for tag in run.tags)
                lines.append(f"- **Tags:** {tags_str}")
            if run.notes:
                lines.append(f"- **Notes:** {run.notes[:200]}{'...' if len(run.notes) > 200 else ''}")

        # Add config if available and requested
        if include_collapsible_config and run.config:
            lines.append("")
            lines.append("<details>")
            lines.append("<summary>Hyperparameters</summary>")
            lines.append("")
            lines.append("| Parameter | Value |")
            lines.append("|-----------|-------|")
            for key, value in sorted(run.config.items()):
                if not key.startswith("_"):
                    lines.append(f"| `{key}` | `{value}` |")
            lines.append("")
            lines.append("</details>")

        if self.include_footer:
            lines.append("")
            lines.append("---")
            lines.append("*Generated by [Runwise](https://github.com/jasegehring/runwise)*")

        return "\n".join(lines)

    def format_run_list(self, list_text: str) -> str:
        """
        Convert run list output to markdown table.

        Args:
            list_text: Plain text from RunAnalyzer.format_run_list()

        Returns:
            Markdown table
        """
        lines = []

        if self.include_header:
            lines.append("## Recent Runs")
            lines.append("")

        # Parse the text table into markdown
        text_lines = list_text.strip().split("\n")

        # Find header and data
        in_table = False
        header_found = False

        for line in text_lines:
            line = line.strip()

            # Skip title line
            if line.startswith("RECENT RUNS"):
                continue

            # Skip empty lines before table
            if not line and not in_table:
                continue

            # Separator line indicates we found the header
            if line.startswith("-"):
                if not header_found:
                    # Previous line was header - output separator
                    lines.append("|" + "|".join(["---"] * len(lines[-1].split("|")[1:-1])) + "|")
                    header_found = True
                    in_table = True
                continue

            # Context line (starts with whitespace or has special chars)
            if line.startswith("└") or line.startswith(" "):
                # Add as note under previous row
                if lines:
                    clean_line = line.strip().lstrip("└─ ")
                    lines.append(f"| | *{clean_line}* |" + " |" * 3)
                continue

            # Parse table row
            parts = line.split()
            if len(parts) >= 4:
                # ID, State, Date, Steps, Primary metric, Trend (optional)
                md_row = "| " + " | ".join(parts) + " |"
                lines.append(md_row)

        if self.include_footer:
            lines.append("")
            lines.append("---")
            lines.append("*Generated by [Runwise](https://github.com/jasegehring/runwise)*")

        return "\n".join(lines)

    def format_comparison(self, compare_text: str) -> str:
        """
        Convert run comparison to markdown.

        Args:
            compare_text: Plain text from RunAnalyzer.compare_runs()

        Returns:
            Markdown with table
        """
        lines = []

        text_lines = compare_text.strip().split("\n")

        # Extract comparison header
        if text_lines and text_lines[0].startswith("COMPARISON:"):
            runs = text_lines[0].replace("COMPARISON:", "").strip()
            if self.include_header:
                lines.append(f"## Run Comparison: {runs}")
                lines.append("")

        # Find and convert tables
        in_table = False
        table_header = None

        for line in text_lines[1:]:
            line = line.rstrip()

            # Skip empty lines outside tables
            if not line and not in_table:
                continue

            # Section headers
            if line.endswith(":") and not in_table:
                lines.append(f"### {line[:-1]}")
                lines.append("")
                continue

            # Name lines (indented)
            if line.strip().startswith("A:") or line.strip().startswith("B:"):
                lines.append(f"- **{line.strip()}**")
                continue

            # Table header line (Metric, Run A, Run B, Delta)
            if "Metric" in line or "Parameter" in line:
                # Convert to markdown table header
                parts = [p.strip() for p in line.split() if p.strip()]
                table_header = parts
                lines.append("| " + " | ".join(parts) + " |")
                continue

            # Separator line starts table
            if line.startswith("-"):
                if table_header:
                    lines.append("|" + "|".join(["---"] * len(table_header)) + "|")
                    in_table = True
                continue

            # Table data row
            if in_table and line:
                parts = line.split()
                if parts:
                    lines.append("| " + " | ".join(parts) + " |")
            elif in_table and not line:
                in_table = False
                table_header = None
                lines.append("")

        if self.include_footer:
            lines.append("")
            lines.append("---")
            lines.append("*Generated by [Runwise](https://github.com/jasegehring/runwise)*")

        return "\n".join(lines)

    def _convert_summary(self, summary_text: str) -> list[str]:
        """Convert plain text summary to markdown lines."""
        lines = []
        text_lines = summary_text.strip().split("\n")

        for line in text_lines:
            line = line.rstrip()

            # Header line (=== ... ===)
            if line.startswith("===") and line.endswith("==="):
                # Already have header from format_run_summary
                continue

            # Run info line
            if line.startswith("Run:"):
                # Parse: Run: abc123 | Step: 50,000 | Runtime: 12.5h
                parts = line.split("|")
                if len(parts) >= 2:
                    lines.append("| Metric | Value |")
                    lines.append("|--------|-------|")
                    for part in parts:
                        part = part.strip()
                        if ":" in part:
                            key, val = part.split(":", 1)
                            lines.append(f"| {key.strip()} | `{val.strip()}` |")
                    lines.append("")
                continue

            # Section header (ends with :)
            if line.endswith(":") and not line.startswith(" "):
                section_name = line[:-1].strip()
                if section_name:
                    lines.append(f"### {section_name}")
                    lines.append("")
                continue

            # Anomaly lines (start with !)
            if line.strip().startswith("!"):
                warning = line.strip()[1:].strip()
                lines.append(f"> **Warning:** {warning}")
                lines.append("")
                continue

            # Metric lines (indented with :)
            if ":" in line and line.startswith(" "):
                # Parse: "  Loss: 0.2341  sparkline"
                match = re.match(r'\s+(.+?):\s+([\d.e%+-]+)\s*(.*)', line)
                if match:
                    name, value, extra = match.groups()
                    if extra:
                        lines.append(f"- **{name}:** `{value}` {extra}")
                    else:
                        lines.append(f"- **{name}:** `{value}`")
                else:
                    # Simple key: value
                    parts = line.strip().split(":", 1)
                    if len(parts) == 2:
                        lines.append(f"- **{parts[0].strip()}:** {parts[1].strip()}")
                continue

            # Context lines (Name:, Notes:, etc.)
            if ":" in line and not line.startswith(" "):
                parts = line.split(":", 1)
                if len(parts) == 2 and parts[0].strip() in ["Name", "Group", "Tags", "Notes"]:
                    lines.append(f"- **{parts[0].strip()}:** {parts[1].strip()}")
                    continue

            # Empty lines
            if not line:
                if lines and lines[-1] != "":
                    lines.append("")
                continue

            # Anything else - preserve
            if line.strip():
                lines.append(line)

        return lines


def to_markdown(text: str, output_type: str = "auto") -> str:
    """
    Convenience function to convert Runwise output to markdown.

    Args:
        text: Plain text output from Runwise
        output_type: "summary", "list", "comparison", or "auto" (detect)

    Returns:
        Markdown formatted string
    """
    formatter = MarkdownFormatter()

    if output_type == "auto":
        # Auto-detect based on content
        if text.startswith("COMPARISON:"):
            output_type = "comparison"
        elif text.startswith("RECENT RUNS"):
            output_type = "list"
        else:
            output_type = "summary"

    if output_type == "list":
        return formatter.format_run_list(text)
    elif output_type == "comparison":
        return formatter.format_comparison(text)
    else:
        # For summary, we need run info - use generic conversion
        lines = ["## Run Summary", ""]
        lines.extend(formatter._convert_summary(text))
        lines.append("")
        lines.append("---")
        lines.append("*Generated by [Runwise](https://github.com/jasegehring/runwise)*")
        return "\n".join(lines)
