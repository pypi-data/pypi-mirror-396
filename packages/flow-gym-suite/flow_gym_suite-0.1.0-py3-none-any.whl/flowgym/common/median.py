"""Comparator-network medians for JAX."""

import functools
from collections.abc import Sequence, Callable

import jax
import jax.numpy as jnp


def _bitonic_pairs(n: int) -> tuple[tuple[int, int], ...]:
    """Returns comparator index pairs for a bitonic sorting network.

    Args:
        n: Length of the sequence to sort.

    Returns:
        Tuple of (i, j) index pairs representing compare-swap operations.
    """
    pairs: list[tuple[int, int]] = []

    def gpot(k: int) -> int:
        p = 1
        while p < k:
            p <<= 1
        return p >> 1

    def merge(lo: int, size: int, up: bool) -> None:
        if size > 1:
            step = gpot(size)
            for i in range(lo, lo + size - step):
                pairs.append((i, i + step) if up else (i + step, i))
            merge(lo, step, up)
            merge(lo + step, size - step, up)

    def sort(lo: int, size: int, up: bool) -> None:
        if size > 1:
            mid = size // 2
            sort(lo, mid, True)
            sort(lo + mid, size - mid, False)
            merge(lo, size, up)

    if n % 2:
        raise ValueError("n must be even for median computation")
    sort(0, n, True)
    return tuple(pairs)


@functools.cache
def _pairs_for(n: int) -> tuple[tuple[int, int], ...]:
    """Memoises comparator networks per length."""
    return _bitonic_pairs(n)


def build_median_fn(n: int) -> Callable[[jnp.ndarray], jnp.ndarray]:
    """Builds a JIT-fused median function for vectors of fixed even length.

    Args:
        n: Vector length (must be even).

    Returns:
        Callable that computes the median along the last axis.
    """
    pairs = _pairs_for(n)
    k1, k2 = n // 2 - 1, n // 2

    def _median(x):
        for i, j in pairs:  # pure-Python loop
            vi, vj = x[..., i], x[..., j]
            low = jnp.minimum(vi, vj)
            high = jnp.maximum(vi, vj)
            x = x.at[..., i].set(low)
            x = x.at[..., j].set(high)
        return 0.5 * (x[..., k1] + x[..., k2])

    _median.__name__ = f"median{n}"
    median_fn = jax.jit(_median)
    return median_fn


median32 = build_median_fn(32)
median64 = build_median_fn(64)


def _cs(x: jnp.ndarray, y: jnp.ndarray) -> tuple[jnp.ndarray, jnp.ndarray]:
    """Compare and swap two values.

    Args:
        x: First value.
        y: Second value.

    Returns:
        Tuple of (min, max) values.
    """
    return jnp.minimum(x, y), jnp.maximum(x, y)


def from_comparator_pairs(
    comps: Sequence[tuple[int, int]],
) -> Callable[[jnp.ndarray], jnp.ndarray]:
    """Builds a JIT-fused median function from comparator pairs.

    Args:
        comps: Sequence of (i, j) pairs representing compare-swap operations.

    Returns:
        Callable that computes the median along the last axis.
    """
    n = max(max(i, j) for i, j in comps) + 1

    def _median(v: jnp.ndarray) -> jnp.ndarray:
        xs: list[jnp.ndarray] = [v[..., i] for i in range(n)]
        for i, j in comps:
            xs[i], xs[j] = _cs(xs[i], xs[j])

        k1 = n // 2
        if n % 2 == 0:
            k2 = k1 - 1
            return 0.5 * (xs[k1] + xs[k2])
        return xs[k1]

    return jax.jit(_median)


# The comparator networks are from
# https://bertdobbelaere.github.io/sorting_networks_extended.html


def median8(v: jnp.ndarray) -> jnp.ndarray:
    """Even-length median for the last axis, assuming length == 8.

    Args:
        v: Input array of shape (..., 8).

    Returns:
        Median value of the last axis, shape (...).
    """
    # Split the 8 lanes into scalars that still broadcast over the batch dims
    x0, x1, x2, x3, x4, x5, x6, x7 = (v[..., i] for i in range(8))

    # 19-comparator optimal network for n = 8  (Knuth, 1998)
    x0, x1 = _cs(x0, x1)
    x2, x3 = _cs(x2, x3)
    x4, x5 = _cs(x4, x5)
    x6, x7 = _cs(x6, x7)

    x0, x2 = _cs(x0, x2)
    x1, x3 = _cs(x1, x3)
    x4, x6 = _cs(x4, x6)
    x5, x7 = _cs(x5, x7)

    x1, x2 = _cs(x1, x2)
    x5, x6 = _cs(x5, x6)

    x0, x4 = _cs(x0, x4)
    x3, x7 = _cs(x3, x7)

    x1, x5 = _cs(x1, x5)
    x2, x6 = _cs(x2, x6)

    x1, x4 = _cs(x1, x4)
    x3, x6 = _cs(x3, x6)

    x2, x4 = _cs(x2, x4)
    x3, x5 = _cs(x3, x5)

    # x3, x4 = _cs(x3, x4)

    # 4th and 5th smallest (0-indexed) -> median for even length
    return 0.5 * (x3 + x4)


median9 = from_comparator_pairs(
    [
        # ── layer 1 ───────────────────────────────────────────────────────────
        (0, 3),
        (1, 7),
        (2, 5),
        (4, 8),
        # ── layer 2 ───────────────────────────────────────────────────────────
        (0, 7),
        (2, 4),
        (3, 8),
        (5, 6),
        # ── layer 3 ───────────────────────────────────────────────────────────
        (0, 2),
        (1, 3),
        (4, 5),
        (7, 8),
        # ── layer 4 ───────────────────────────────────────────────────────────
        (1, 4),
        (3, 6),
        (5, 7),
        # ── layer 5 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 4),
        (3, 5),
        (6, 8),
        # ── layer 6 ───────────────────────────────────────────────────────────
        (2, 3),
        (4, 5),
        (6, 7),
        # ── layer 7 ───────────────────────────────────────────────────────────
        (1, 2),
        (3, 4),
        (5, 6),
    ]
)


median24 = from_comparator_pairs(
    [
        # ── layer 1 ───────────────────────────────────────────────────────────
        (0, 20),
        (1, 12),
        (2, 16),
        (3, 23),
        (4, 6),
        (5, 10),
        (7, 21),
        (8, 14),
        (9, 15),
        (11, 22),
        (13, 18),
        (17, 19),
        # ── layer 2 ───────────────────────────────────────────────────────────
        (0, 3),
        (1, 11),
        (2, 7),
        (4, 17),
        (5, 13),
        (6, 19),
        (8, 9),
        (10, 18),
        (12, 22),
        (14, 15),
        (16, 21),
        (20, 23),
        # ── layer 3 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 4),
        (3, 12),
        (5, 8),
        (6, 9),
        (7, 10),
        (11, 20),
        (13, 16),
        (14, 17),
        (15, 18),
        (19, 21),
        (22, 23),
        # ── layer 4 ───────────────────────────────────────────────────────────
        (2, 5),
        (4, 8),
        (6, 11),
        (7, 14),
        (9, 16),
        (12, 17),
        (15, 19),
        (18, 21),
        # ── layer 5 ───────────────────────────────────────────────────────────
        (1, 8),
        (3, 14),
        (4, 7),
        (9, 20),
        (10, 12),
        (11, 13),
        (15, 22),
        (16, 19),
        # ── layer 6 ───────────────────────────────────────────────────────────
        (0, 7),
        (1, 5),
        (3, 4),
        (6, 11),
        (8, 15),
        (9, 14),
        (10, 13),
        (12, 17),
        (16, 23),
        (18, 22),
        (19, 20),
        # ── layer 7 ───────────────────────────────────────────────────────────
        (0, 2),
        (1, 6),
        (4, 7),
        (5, 9),
        (8, 10),
        (13, 15),
        (14, 18),
        (16, 19),
        (17, 22),
        (21, 23),
        # ── layer 8 ───────────────────────────────────────────────────────────
        (2, 3),
        (4, 5),
        (6, 8),
        (7, 9),
        (10, 11),
        (12, 13),
        (14, 16),
        (15, 17),
        (18, 19),
        (20, 21),
        # ── layer 9 ───────────────────────────────────────────────────────────
        (1, 2),
        (3, 6),
        (4, 10),
        (7, 8),
        (9, 11),
        (12, 14),
        (13, 19),
        (15, 16),
        (17, 20),
        (21, 22),
        # ── layer 10 ───────────────────────────────────────────────────────────
        (2, 3),
        (5, 10),
        (6, 7),
        (8, 9),
        (13, 18),
        (14, 15),
        (16, 17),
        (20, 21),
        # ── layer 11 ───────────────────────────────────────────────────────────
        (3, 4),
        (5, 7),
        (10, 12),
        (11, 13),
        (16, 18),
        (19, 20),
        # ── layer 12 ───────────────────────────────────────────────────────────
        (4, 6),
        (8, 10),
        (9, 12),
        (11, 14),
        (13, 15),
        (17, 19),
        # ── layer 13 ───────────────────────────────────────────────────────────
        (5, 6),
        (7, 8),
        (9, 10),
        (11, 12),
        (13, 14),
        (15, 16),
        (17, 18),
    ]
)

median25 = from_comparator_pairs(
    [
        # ── layer 1 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 3),
        (4, 5),
        (6, 7),
        (8, 9),
        (10, 11),
        (12, 13),
        (14, 15),
        (16, 17),
        (18, 19),
        (20, 21),
        (22, 23),
        # ── layer 2 ───────────────────────────────────────────────────────────
        (0, 2),
        (1, 3),
        (4, 6),
        (5, 7),
        (8, 10),
        (9, 11),
        (12, 14),
        (13, 15),
        (16, 18),
        (17, 19),
        (20, 22),
        (21, 24),
        # ── layer 3 ───────────────────────────────────────────────────────────
        (0, 4),
        (1, 5),
        (2, 6),
        (3, 7),
        (8, 12),
        (9, 13),
        (10, 14),
        (11, 15),
        (16, 20),
        (21, 22),
        (23, 24),
        # ── layer 4 ───────────────────────────────────────────────────────────
        (0, 8),
        (1, 12),
        (2, 10),
        (3, 14),
        (4, 9),
        (5, 13),
        (6, 11),
        (7, 15),
        (17, 22),
        (18, 21),
        (19, 24),
        # ── layer 5 ───────────────────────────────────────────────────────────
        (1, 18),
        (3, 9),
        (5, 17),
        (6, 20),
        (7, 13),
        (11, 14),
        (12, 22),
        (15, 24),
        (21, 23),
        # ── layer 6 ───────────────────────────────────────────────────────────
        (1, 16),
        (3, 12),
        (5, 21),
        (6, 18),
        (7, 11),
        (10, 17),
        (14, 23),
        (19, 20),
        # ─ layer 7 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 5),
        (4, 16),
        (6, 8),
        (7, 18),
        (9, 21),
        (10, 14),
        (11, 13),
        (12, 19),
        (15, 23),
        (20, 22),
        # ── layer 8 ───────────────────────────────────────────────────────────
        (1, 2),
        (3, 5),
        (4, 6),
        (7, 9),
        (8, 12),
        (10, 16),
        (11, 20),
        (13, 22),
        (14, 17),
        (15, 18),
        (19, 21),
        # ── layer 9 ───────────────────────────────────────────────────────────
        (1, 4),
        (2, 6),
        (3, 7),
        (5, 9),
        (8, 10),
        (11, 14),
        (12, 16),
        (13, 17),
        (15, 19),
        (18, 20),
        (22, 23),
        # ── layer 10 ──────────────────────────────────────────────────────────
        (2, 4),
        (3, 8),
        (5, 10),
        (7, 12),
        (9, 16),
        (11, 15),
        (13, 19),
        (14, 21),
        (17, 18),
        (20, 22),
        # ── layer 11 ──────────────────────────────────────────────────────────
        (3, 4),
        (5, 8),
        (6, 7),
        (9, 12),
        (10, 11),
        (13, 16),
        (14, 15),
        (17, 19),
        (18, 21),
        # ── layer 12 ──────────────────────────────────────────────────────────
        (5, 6),
        (7, 8),
        (9, 10),
        (11, 12),
        (13, 14),
        (15, 16),
        (17, 18),
        (20, 21),
        # ── layer 13 ──────────────────────────────────────────────────────────
        (4, 5),
        (6, 7),
        (8, 9),
        (10, 11),
        (12, 13),
        (14, 15),
        (16, 17),
        (18, 19),
    ]
)

median48 = from_comparator_pairs(
    [
        # ── layer 1 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 3),
        (4, 5),
        (6, 7),
        (8, 9),
        (10, 11),
        (12, 13),
        (14, 15),
        (16, 17),
        (18, 19),
        (20, 21),
        (22, 23),
        (24, 25),
        (26, 27),
        (28, 29),
        (30, 31),
        (32, 33),
        (34, 35),
        (36, 37),
        (38, 39),
        (40, 41),
        (42, 43),
        (44, 45),
        (46, 47),
        # ── layer 2 ───────────────────────────────────────────────────────────
        (0, 2),
        (1, 3),
        (4, 6),
        (5, 7),
        (8, 10),
        (9, 11),
        (12, 14),
        (13, 15),
        (16, 18),
        (17, 19),
        (20, 22),
        (21, 23),
        (24, 26),
        (25, 27),
        (28, 30),
        (29, 31),
        (32, 34),
        (33, 35),
        (36, 38),
        (37, 39),
        (40, 42),
        (41, 43),
        (44, 46),
        (45, 47),
        # ── layer 3 ───────────────────────────────────────────────────────────
        (0, 4),
        (1, 5),
        (2, 6),
        (3, 7),
        (8, 12),
        (9, 13),
        (10, 14),
        (11, 15),
        (16, 20),
        (17, 21),
        (18, 22),
        (19, 23),
        (24, 28),
        (25, 29),
        (26, 30),
        (27, 31),
        (32, 36),
        (33, 37),
        (34, 38),
        (35, 39),
        (40, 44),
        (41, 45),
        (42, 46),
        (43, 47),
        # ── layer 4 ───────────────────────────────────────────────────────────
        (0, 8),
        (1, 9),
        (2, 10),
        (3, 11),
        (4, 12),
        (5, 13),
        (6, 14),
        (7, 15),
        (16, 24),
        (17, 25),
        (18, 26),
        (19, 27),
        (20, 28),
        (21, 29),
        (22, 30),
        (23, 31),
        (32, 40),
        (33, 41),
        (34, 42),
        (35, 43),
        (36, 44),
        (37, 45),
        (38, 46),
        (39, 47),
        # ── layer 5 ───────────────────────────────────────────────────────────
        (0, 32),
        (1, 33),
        (2, 34),
        (3, 35),
        (4, 36),
        (5, 37),
        (6, 38),
        (7, 39),
        (8, 40),
        (9, 41),
        (10, 42),
        (11, 43),
        (12, 44),
        (13, 45),
        (14, 46),
        (15, 47),
        (17, 18),
        (19, 28),
        (20, 24),
        (21, 26),
        (22, 25),
        (23, 27),
        (29, 30),
        # ── layer 6 ───────────────────────────────────────────────────────────
        (0, 16),
        (1, 4),
        (2, 8),
        (3, 12),
        (5, 10),
        (6, 9),
        (7, 13),
        (11, 14),
        (17, 20),
        (18, 24),
        (19, 21),
        (23, 29),
        (26, 28),
        (27, 30),
        (31, 47),
        (33, 36),
        (34, 40),
        (35, 44),
        (37, 42),
        (38, 41),
        (39, 45),
        (43, 46),
        # ── layer 7 ───────────────────────────────────────────────────────────
        (1, 2),
        (3, 22),
        (4, 8),
        (5, 6),
        (7, 11),
        (9, 10),
        (13, 14),
        (15, 31),
        (16, 32),
        (25, 44),
        (33, 34),
        (36, 40),
        (37, 38),
        (39, 43),
        (41, 42),
        (45, 46),
        # ── layer 8 ───────────────────────────────────────────────────────────
        (1, 17),
        (3, 32),
        (6, 21),
        (7, 23),
        (10, 28),
        (11, 29),
        (12, 25),
        (13, 27),
        (15, 44),
        (18, 36),
        (19, 37),
        (20, 34),
        (22, 35),
        (24, 40),
        (26, 41),
        (30, 46),
        # ── layer 9 ───────────────────────────────────────────────────────────
        (1, 16),
        (2, 18),
        (4, 20),
        (5, 19),
        (6, 32),
        (7, 22),
        (8, 24),
        (9, 26),
        (10, 12),
        (11, 13),
        (14, 30),
        (15, 41),
        (17, 33),
        (21, 38),
        (23, 39),
        (25, 40),
        (27, 43),
        (28, 42),
        (29, 45),
        (31, 46),
        (34, 36),
        (35, 37),
        # ── layer 10 ──────────────────────────────────────────────────────────
        (2, 4),
        (3, 16),
        (7, 19),
        (8, 17),
        (9, 33),
        (10, 34),
        (11, 35),
        (12, 36),
        (13, 37),
        (14, 38),
        (28, 40),
        (30, 39),
        (31, 44),
        (43, 45),
        # ── layer 11 ──────────────────────────────────────────────────────────
        (2, 3),
        (4, 8),
        (5, 16),
        (6, 17),
        (7, 9),
        (10, 18),
        (11, 32),
        (13, 25),
        (14, 26),
        (15, 36),
        (19, 28),
        (21, 33),
        (22, 34),
        (29, 37),
        (30, 41),
        (31, 42),
        (38, 40),
        (39, 43),
        (44, 45),
        # ── layer 12 ──────────────────────────────────────────────────────────
        (3, 5),
        (6, 7),
        (11, 20),
        (12, 19),
        (13, 21),
        (14, 22),
        (15, 23),
        (16, 17),
        (24, 32),
        (25, 33),
        (26, 34),
        (27, 36),
        (28, 35),
        (30, 31),
        (40, 41),
        (42, 44),
        # ── layer 13 ──────────────────────────────────────────────────────────
        (3, 4),
        (5, 8),
        (7, 16),
        (9, 17),
        (10, 11),
        (12, 14),
        (13, 24),
        (15, 25),
        (18, 20),
        (19, 26),
        (21, 28),
        (22, 32),
        (23, 34),
        (27, 29),
        (30, 38),
        (31, 40),
        (33, 35),
        (36, 37),
        (39, 42),
        (43, 44),
        # ── layer 14 ──────────────────────────────────────────────────────────
        (4, 5),
        (6, 8),
        (7, 10),
        (9, 18),
        (11, 16),
        (12, 13),
        (14, 24),
        (15, 22),
        (17, 20),
        (19, 21),
        (23, 33),
        (25, 32),
        (26, 28),
        (27, 30),
        (29, 38),
        (31, 36),
        (34, 35),
        (37, 40),
        (39, 41),
        (42, 43),
        # ── layer 15 ──────────────────────────────────────────────────────────
        (6, 7),
        (9, 12),
        (10, 11),
        (13, 17),
        (14, 18),
        (15, 19),
        (20, 24),
        (21, 25),
        (22, 26),
        (23, 27),
        (28, 32),
        (29, 33),
        (30, 34),
        (35, 38),
        (36, 37),
        (40, 41),
        # ── layer 16 ──────────────────────────────────────────────────────────
        (5, 6),
        (8, 10),
        (9, 11),
        (12, 16),
        (13, 14),
        (15, 18),
        (17, 20),
        (19, 24),
        (21, 22),
        (23, 28),
        (25, 26),
        (27, 30),
        (29, 32),
        (31, 35),
        (33, 34),
        (36, 38),
        (37, 39),
        (41, 42),
        # ── layer 17 ──────────────────────────────────────────────────────────
        (7, 8),
        (9, 10),
        (12, 13),
        (14, 16),
        (15, 17),
        (18, 20),
        (19, 21),
        (22, 24),
        (23, 25),
        (26, 28),
        (27, 29),
        (30, 32),
        (31, 33),
        (34, 35),
        (37, 38),
        (39, 40),
        # ── layer 18 ──────────────────────────────────────────────────────────
        (11, 12),
        (13, 14),
        (15, 16),
        (17, 18),
        (19, 20),
        (21, 22),
        (23, 24),
        (25, 26),
        (27, 28),
        (29, 30),
        (31, 32),
        (33, 34),
        (35, 36),
    ]
)

median49 = from_comparator_pairs(
    [
        # ── layer 1 ───────────────────────────────────────────────────────────
        (0, 8),
        (1, 7),
        (2, 6),
        (3, 11),
        (4, 10),
        (5, 9),
        (12, 20),
        (13, 19),
        (14, 18),
        (15, 23),
        (16, 22),
        (17, 21),
        (24, 32),
        (25, 31),
        (26, 30),
        (27, 35),
        (28, 34),
        (29, 33),
        (36, 48),
        (37, 46),
        (38, 45),
        (39, 43),
        (41, 47),
        (42, 44),
        # ── layer 2 ───────────────────────────────────────────────────────────
        (0, 1),
        (2, 5),
        (3, 4),
        (6, 9),
        (7, 8),
        (10, 11),
        (12, 13),
        (14, 17),
        (15, 16),
        (18, 21),
        (19, 20),
        (22, 23),
        (24, 25),
        (26, 29),
        (27, 28),
        (30, 33),
        (31, 32),
        (34, 35),
        (37, 42),
        (38, 39),
        (40, 47),
        (43, 45),
        (44, 46),
        # ── layer 3 ───────────────────────────────────────────────────────────
        (0, 2),
        (1, 6),
        (5, 10),
        (9, 11),
        (12, 14),
        (13, 18),
        (17, 22),
        (21, 23),
        (24, 26),
        (25, 30),
        (29, 34),
        (33, 35),
        (36, 40),
        (37, 38),
        (39, 42),
        (43, 44),
        (45, 46),
        (47, 48),
        # ── layer 4 ───────────────────────────────────────────────────────────
        (0, 3),
        (1, 2),
        (4, 6),
        (5, 7),
        (8, 11),
        (9, 10),
        (12, 15),
        (13, 14),
        (16, 18),
        (17, 19),
        (20, 23),
        (21, 22),
        (24, 27),
        (25, 26),
        (28, 30),
        (29, 31),
        (32, 35),
        (33, 34),
        (40, 42),
        (41, 45),
        (44, 47),
        (46, 48),
        # ── layer 5 ───────────────────────────────────────────────────────────
        (0, 24),
        (1, 4),
        (3, 5),
        (6, 8),
        (7, 10),
        (11, 23),
        (13, 16),
        (15, 17),
        (18, 20),
        (19, 22),
        (25, 28),
        (27, 29),
        (30, 32),
        (31, 34),
        (36, 41),
        (39, 44),
        (40, 43),
        (42, 47),
        (45, 46),
        # ── layer 6 ───────────────────────────────────────────────────────────
        (1, 3),
        (2, 5),
        (6, 9),
        (8, 10),
        (13, 15),
        (14, 17),
        (18, 21),
        (20, 22),
        (25, 27),
        (26, 29),
        (30, 33),
        (32, 34),
        (36, 37),
        (38, 41),
        (42, 45),
        (43, 44),
        (46, 47),
        # ── layer 7 ───────────────────────────────────────────────────────────
        (1, 13),
        (2, 3),
        (4, 5),
        (6, 7),
        (8, 9),
        (10, 22),
        (12, 36),
        (14, 15),
        (16, 17),
        (18, 19),
        (20, 21),
        (26, 27),
        (28, 29),
        (30, 31),
        (32, 33),
        (35, 47),
        (37, 39),
        (38, 40),
        (41, 42),
        (45, 46),
        # ── layer 8 ───────────────────────────────────────────────────────────
        (0, 12),
        (2, 14),
        (4, 6),
        (5, 7),
        (9, 21),
        (11, 35),
        (16, 18),
        (17, 19),
        (23, 47),
        (24, 36),
        (28, 30),
        (29, 31),
        (34, 46),
        (37, 38),
        (39, 40),
        (41, 43),
        (42, 44),
        # ── layer 9 ───────────────────────────────────────────────────────────
        (3, 4),
        (5, 6),
        (7, 8),
        (10, 34),
        (12, 24),
        (15, 16),
        (17, 18),
        (19, 20),
        (22, 46),
        (23, 35),
        (25, 37),
        (27, 28),
        (29, 30),
        (31, 32),
        (38, 39),
        (40, 41),
        (42, 43),
        (44, 45),
        # ── layer 10 ──────────────────────────────────────────────────────────
        (1, 25),
        (3, 15),
        (4, 28),
        (5, 29),
        (6, 30),
        (7, 31),
        (8, 32),
        (13, 37),
        (19, 43),
        (20, 48),
        (22, 34),
        (26, 38),
        (33, 45),
        (39, 40),
        (41, 42),
        # ── layer 11 ──────────────────────────────────────────────────────────
        (2, 26),
        (4, 40),
        (7, 19),
        (8, 20),
        (9, 33),
        (13, 25),
        (14, 38),
        (16, 28),
        (17, 41),
        (18, 42),
        (21, 45),
        (27, 39),
        (31, 43),
        (32, 48),
        # ── layer 12 ──────────────────────────────────────────────────────────
        (3, 27),
        (5, 17),
        (6, 18),
        (9, 37),
        (10, 38),
        (14, 26),
        (15, 39),
        (19, 31),
        (20, 32),
        (21, 33),
        (28, 44),
        (29, 41),
        (30, 42),
        (35, 43),
        (36, 40),
        # ── layer 13 ──────────────────────────────────────────────────────────
        (5, 13),
        (6, 14),
        (8, 28),
        (9, 25),
        (10, 26),
        (11, 39),
        (15, 27),
        (16, 36),
        (17, 29),
        (18, 30),
        (20, 40),
        (21, 37),
        (22, 38),
        (32, 44),
        (33, 41),
        (34, 42),
        (43, 46),
        # ── layer 14 ──────────────────────────────────────────────────────────
        (4, 16),
        (7, 15),
        (8, 24),
        (9, 13),
        (10, 14),
        (11, 27),
        (17, 25),
        (18, 26),
        (21, 29),
        (22, 30),
        (23, 39),
        (28, 36),
        (32, 40),
        (33, 37),
        (34, 38),
        (42, 48),
        # ── layer 15 ──────────────────────────────────────────────────────────
        (3, 9),
        (4, 12),
        (11, 15),
        (13, 17),
        (14, 18),
        (19, 27),
        (21, 25),
        (22, 26),
        (23, 31),
        (24, 28),
        (29, 33),
        (30, 34),
        (32, 36),
        (35, 39),
        (38, 44),
        (43, 48),
        # ── layer 16 ──────────────────────────────────────────────────────────
        (1, 4),
        (3, 5),
        (7, 13),
        (8, 12),
        (11, 17),
        (15, 19),
        (16, 24),
        (20, 28),
        (23, 27),
        (30, 36),
        (31, 35),
        (34, 40),
        (39, 45),
        # ── layer 17 ──────────────────────────────────────────────────────────
        (2, 8),
        (7, 9),
        (12, 16),
        (15, 21),
        (19, 25),
        (20, 24),
        (23, 29),
        (27, 33),
        (28, 32),
        (31, 37),
        (34, 36),
        (35, 41),
        (39, 42),
        (45, 48),
        # ── layer 18 ──────────────────────────────────────────────────────────
        (2, 4),
        (6, 12),
        (10, 16),
        (14, 20),
        (18, 24),
        (19, 21),
        (22, 28),
        (23, 25),
        (26, 32),
        (29, 30),
        (31, 33),
        (35, 38),
        (37, 40),
        (39, 44),
        (43, 45),
        (46, 48),
        # ── layer 19 ──────────────────────────────────────────────────────────
        (6, 8),
        (10, 12),
        (11, 14),
        (13, 16),
        (15, 20),
        (17, 18),
        (22, 24),
        (26, 28),
        (27, 32),
        (31, 34),
        (33, 36),
        (35, 37),
        (38, 40),
        (41, 44),
        (47, 48),
        # ── layer 20 ──────────────────────────────────────────────────────────
        (3, 6),
        (5, 8),
        (7, 10),
        (9, 12),
        (11, 13),
        (14, 16),
        (15, 17),
        (18, 20),
        (19, 22),
        (21, 24),
        (23, 26),
        (25, 28),
        (27, 29),
        (30, 32),
        (33, 34),
        (35, 36),
        (37, 38),
        (39, 41),
        (42, 44),
        # ── layer 21 ──────────────────────────────────────────────────────────
        (3, 4),
        (5, 6),
        (7, 8),
        (9, 10),
        (11, 12),
        (13, 14),
        (15, 16),
        (17, 18),
        (19, 20),
        (21, 22),
        (23, 24),
        (25, 26),
        (27, 28),
        (29, 30),
        (31, 32),
        (39, 40),
        (43, 44),
    ]
)


def median(v: jnp.ndarray) -> jnp.ndarray:
    """Computes the median of a vector.

    Args:
        v: Input array of shape (..., dim).

    Returns:
        Median value of the last axis, shape (...).
    """
    dim = v.shape[-1]
    if dim == 8:
        return median8(v)
    if dim == 9:
        return median9(v)
    if dim == 24:
        return median24(v)
    if dim == 25:
        return median25(v)
    if dim == 48:
        return median48(v)
    if dim == 49:
        return median49(v)

    center = dim // 2
    part = jnp.partition(v, center, axis=-1)
    if dim % 2 == 1:
        return part[..., center]
    return 0.5 * (part[..., center] + jnp.max(part[..., :center], axis=-1))
