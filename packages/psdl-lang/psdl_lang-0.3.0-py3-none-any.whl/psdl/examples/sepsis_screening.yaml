# PSDL Example: Sepsis Screening (qSOFA + Lactate)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Implements qSOFA (quick Sequential Organ Failure Assessment)
# combined with lactate-based sepsis screening.
#
# qSOFA Criteria (2+ = positive screen):
# - Respiratory rate >=22/min
# - Altered mental status (GCS <15)
# - Systolic BP <=100 mmHg
#
# Reference: Singer et al. JAMA 2016 (Sepsis-3)

scenario: Sepsis_Screening_v1
version: "0.3.0"
description: "Sepsis screening using qSOFA criteria and lactate"

# ── Audit Block ──────────────────────────────────
audit:
  intent: "Screen for sepsis using qSOFA criteria combined with lactate"
  rationale: "Early sepsis identification enables timely antibiotics and resuscitation"
  provenance: "Singer et al. JAMA 2016 (Sepsis-3 Consensus Definition)"

# ── Population ───────────────────────────────────
population:
  include:
    - age >= 18
    - location IN ["ED", "ICU", "Ward"]
  exclude:
    - status == "comfort_care_only"

# ── Signals (v0.3: 'ref' required) ───────────────
signals:
  RR:
    ref: respiratory_rate
    concept_id: 3024171
    unit: breaths/min
    domain: measurement

  SBP:
    ref: systolic_blood_pressure
    concept_id: 3004249
    unit: mmHg
    domain: measurement

  HR:
    ref: heart_rate
    concept_id: 3027018
    unit: beats/min
    domain: measurement

  Temp:
    ref: body_temperature
    concept_id: 3020891
    unit: C
    domain: measurement

  GCS:
    ref: glasgow_coma_scale
    concept_id: 3032652
    unit: score
    domain: measurement

  Lact:
    ref: lactate
    concept_id: 3047181
    unit: mmol/L
    domain: measurement

  WBC:
    ref: white_blood_cell_count
    concept_id: 3010813
    unit: 10^9/L
    domain: measurement

  Plt:
    ref: platelet_count
    concept_id: 3024929
    unit: 10^9/L
    domain: measurement

  Cr:
    ref: creatinine
    concept_id: 3016723
    unit: mg/dL
    domain: measurement

# ── Trends (v0.3: numeric values only) ───────────
trends:
  rr_current:
    expr: last(RR)
    description: "Current respiratory rate"

  sbp_current:
    expr: last(SBP)
    description: "Current systolic BP"

  hr_current:
    expr: last(HR)
    description: "Current heart rate"

  temp_current:
    expr: last(Temp)
    description: "Current temperature"

  gcs_current:
    expr: last(GCS)
    description: "Current GCS score"

  lact_current:
    expr: last(Lact)
    description: "Current lactate"

  lact_slope_2h:
    expr: slope(Lact, 2h)
    description: "Lactate slope over 2 hours"

  wbc_current:
    expr: last(WBC)
    description: "Current WBC count"

  plt_current:
    expr: last(Plt)
    description: "Current platelet count"

  cr_delta_24h:
    expr: delta(Cr, 24h)
    description: "Creatinine change over 24 hours"

# ── Logic (v0.3: 'when' with comparisons) ────────
logic:
  # qSOFA components
  tachypnea:
    when: rr_current >= 22
    description: "Respiratory rate >=22/min (qSOFA criterion)"

  hypotension:
    when: sbp_current <= 100
    description: "Systolic BP <=100 mmHg (qSOFA criterion)"

  altered_mental_status:
    when: gcs_current < 15
    description: "GCS <15 (qSOFA criterion)"

  # Lactate criteria
  lactate_elevated:
    when: lact_current > 2.0
    description: "Lactate >2.0 mmol/L"

  lactate_high:
    when: lact_current > 4.0
    description: "Lactate >4.0 mmol/L (severe)"

  lactate_rising:
    when: lact_slope_2h > 0.5
    description: "Rapidly rising lactate"

  # SIRS criteria
  fever:
    when: temp_current > 38.3
    description: "Temperature >38.3C"

  hypothermia:
    when: temp_current < 36.0
    description: "Temperature <36.0C"

  tachycardia:
    when: hr_current > 90
    description: "Heart rate >90 bpm"

  leukocytosis:
    when: wbc_current > 12.0
    description: "WBC >12.0 x10^9/L"

  leukopenia:
    when: wbc_current < 4.0
    description: "WBC <4.0 x10^9/L"

  # Organ dysfunction markers
  thrombocytopenia:
    when: plt_current < 100
    description: "Platelets <100 x10^9/L"

  aki_marker:
    when: cr_delta_24h > 0.5
    description: "Creatinine rise >0.5 in 24h"

  # qSOFA scoring
  qsofa_1:
    when: tachypnea
    severity: low
    description: "qSOFA: 1 criterion (tachypnea)"

  qsofa_2:
    when: tachypnea AND (hypotension OR altered_mental_status)
    severity: medium
    description: "qSOFA >=2 criteria - positive screen"

  qsofa_3:
    when: tachypnea AND hypotension AND altered_mental_status
    severity: high
    description: "qSOFA 3/3 criteria - high risk"

  # SIRS positive
  sirs_positive:
    when: (fever OR hypothermia) AND (tachycardia OR tachypnea) AND (leukocytosis OR leukopenia)
    severity: medium
    description: "SIRS criteria positive"

  # Combined sepsis screening
  sepsis_screen_positive:
    when: qsofa_2 AND lactate_elevated
    severity: high
    description: "Sepsis screen positive - qSOFA >=2 + elevated lactate"

  # Septic shock
  septic_shock:
    when: sepsis_screen_positive AND hypotension AND lactate_high
    severity: critical
    description: "Septic shock - vasopressor requirement + lactate >4"

  # Deteriorating sepsis
  sepsis_worsening:
    when: sepsis_screen_positive AND lactate_rising
    severity: critical
    description: "Sepsis with worsening trajectory"

  # Multi-organ dysfunction
  multi_organ_dysfunction:
    when: sepsis_screen_positive AND (thrombocytopenia OR aki_marker)
    severity: critical
    description: "Sepsis with multi-organ dysfunction"

  # Early warning
  infection_possible:
    when: (fever OR hypothermia) AND (tachycardia AND tachypnea)
    severity: low
    description: "Possible infection - monitor closely"
