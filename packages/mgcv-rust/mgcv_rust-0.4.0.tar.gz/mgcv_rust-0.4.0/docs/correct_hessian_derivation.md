# Correct Hessian Derivation for REML

## Starting Point: Corrected Gradient

From `reml_gradient_multi_qr`, we have:

```
∂REML/∂ρᵢ = [tr(A⁻¹·λᵢ·Sᵢ) - rank(Sᵢ) + ∂(P/φ)/∂ρᵢ + (n-r)·(1/φ)·∂φ/∂ρᵢ] / 2
```

where:
- `P = RSS + Σⱼ λⱼ·β'·Sⱼ·β`
- `φ = RSS / (n-r)`
- `∂β/∂ρᵢ = -A⁻¹·λᵢ·Sᵢ·β`
- `∂RSS/∂ρᵢ = -2·r'·X·∂β/∂ρᵢ` (where `r = y - Xβ`)
- `∂φ/∂ρᵢ = (∂RSS/∂ρᵢ)/(n-r)`
- `∂P/∂ρᵢ = ∂RSS/∂ρᵢ + λᵢ·β'·Sᵢ·β + 2·Σⱼ λⱼ·β'·Sⱼ·∂β/∂ρᵢ`
- `∂(P/φ)/∂ρᵢ = (1/φ)·∂P/∂ρᵢ - (P/φ²)·∂φ/∂ρᵢ`

## Hessian Formula

```
H[i,j] = ∂²REML/∂ρⱼ∂ρᵢ
       = [∂/∂ρⱼ[tr(A⁻¹·λᵢ·Sᵢ)] - ∂/∂ρⱼ[rank(Sᵢ)] + ∂²(P/φ)/∂ρⱼ∂ρᵢ + ∂/∂ρⱼ[(n-r)·(1/φ)·∂φ/∂ρᵢ]] / 2
```

Let's compute each term:

### Term 1: ∂/∂ρⱼ[tr(A⁻¹·λᵢ·Sᵢ)]

```
tr(A⁻¹·λᵢ·Sᵢ) = λᵢ·tr(A⁻¹·Sᵢ)

∂/∂ρⱼ[λᵢ·tr(A⁻¹·Sᵢ)] = ∂λᵢ/∂ρⱼ · tr(A⁻¹·Sᵢ) + λᵢ·∂/∂ρⱼ[tr(A⁻¹·Sᵢ)]

Since λᵢ = exp(ρᵢ), we have ∂λᵢ/∂ρⱼ = δᵢⱼ·λᵢ

For the second part, using ∂A⁻¹/∂ρⱼ = -A⁻¹·∂A/∂ρⱼ·A⁻¹ = -A⁻¹·λⱼ·Sⱼ·A⁻¹:

∂/∂ρⱼ[tr(A⁻¹·Sᵢ)] = tr(∂A⁻¹/∂ρⱼ · Sᵢ)
                    = tr(-A⁻¹·λⱼ·Sⱼ·A⁻¹·Sᵢ)
                    = -λⱼ·tr(A⁻¹·Sⱼ·A⁻¹·Sᵢ)

Therefore:
∂/∂ρⱼ[tr(A⁻¹·λᵢ·Sᵢ)] = δᵢⱼ·λᵢ·tr(A⁻¹·Sᵢ) - λᵢ·λⱼ·tr(A⁻¹·Sⱼ·A⁻¹·Sᵢ)
```

### Term 2: ∂/∂ρⱼ[rank(Sᵢ)] = 0

The rank doesn't depend on ρⱼ.

### Term 3: ∂²(P/φ)/∂ρⱼ∂ρᵢ

This is the most complex term. Starting with:
```
∂(P/φ)/∂ρᵢ = (1/φ)·∂P/∂ρᵢ - (P/φ²)·∂φ/∂ρᵢ
```

Taking derivative with respect to ρⱼ:
```
∂²(P/φ)/∂ρⱼ∂ρᵢ = ∂/∂ρⱼ[(1/φ)·∂P/∂ρᵢ] - ∂/∂ρⱼ[(P/φ²)·∂φ/∂ρᵢ]
```

**Part A: ∂/∂ρⱼ[(1/φ)·∂P/∂ρᵢ]**
```
= -∂φ/∂ρⱼ·(1/φ²)·∂P/∂ρᵢ + (1/φ)·∂²P/∂ρⱼ∂ρᵢ
```

**Part B: ∂/∂ρⱼ[(P/φ²)·∂φ/∂ρᵢ]**
```
= ∂P/∂ρⱼ·(1/φ²)·∂φ/∂ρᵢ + P·∂/∂ρⱼ[(1/φ²)]·∂φ/∂ρᵢ + (P/φ²)·∂²φ/∂ρⱼ∂ρᵢ

where ∂/∂ρⱼ[(1/φ²)] = -2·(1/φ³)·∂φ/∂ρⱼ

= ∂P/∂ρⱼ·(1/φ²)·∂φ/∂ρᵢ - 2·P·(1/φ³)·∂φ/∂ρⱼ·∂φ/∂ρᵢ + (P/φ²)·∂²φ/∂ρⱼ∂ρᵢ
```

**Combining:**
```
∂²(P/φ)/∂ρⱼ∂ρᵢ = (1/φ)·∂²P/∂ρⱼ∂ρᵢ
                  - (1/φ²)·[∂φ/∂ρⱼ·∂P/∂ρᵢ + ∂P/∂ρⱼ·∂φ/∂ρᵢ]
                  + 2·(P/φ³)·∂φ/∂ρⱼ·∂φ/∂ρᵢ
                  - (P/φ²)·∂²φ/∂ρⱼ∂ρᵢ
```

### Term 4: ∂/∂ρⱼ[(n-r)·(1/φ)·∂φ/∂ρᵢ]

```
= (n-r)·∂/∂ρⱼ[(1/φ)·∂φ/∂ρᵢ]
= (n-r)·[-∂φ/∂ρⱼ·(1/φ²)·∂φ/∂ρᵢ + (1/φ)·∂²φ/∂ρⱼ∂ρᵢ]
= (n-r)·[(1/φ)·∂²φ/∂ρⱼ∂ρᵢ - (1/φ²)·∂φ/∂ρⱼ·∂φ/∂ρᵢ]
```

## Second-Order Derivatives

### ∂²β/∂ρⱼ∂ρᵢ

From the IFT applied to `A·β = X'y`:
```
∂β/∂ρᵢ = -A⁻¹·∂A/∂ρᵢ·β = -A⁻¹·λᵢ·Sᵢ·β

∂²β/∂ρⱼ∂ρᵢ = -∂/∂ρⱼ[A⁻¹·λᵢ·Sᵢ·β]
            = -[∂A⁻¹/∂ρⱼ·λᵢ·Sᵢ·β + A⁻¹·∂λᵢ/∂ρⱼ·Sᵢ·β + A⁻¹·λᵢ·Sᵢ·∂β/∂ρⱼ]
            = -[-A⁻¹·λⱼ·Sⱼ·A⁻¹·λᵢ·Sᵢ·β + δᵢⱼ·A⁻¹·λᵢ·Sᵢ·β + A⁻¹·λᵢ·Sᵢ·∂β/∂ρⱼ]
            = λⱼ·A⁻¹·Sⱼ·A⁻¹·λᵢ·Sᵢ·β - δᵢⱼ·A⁻¹·λᵢ·Sᵢ·β - A⁻¹·λᵢ·Sᵢ·∂β/∂ρⱼ
            = λᵢ·λⱼ·A⁻¹·Sⱼ·A⁻¹·Sᵢ·β - δᵢⱼ·∂β/∂ρᵢ - A⁻¹·λᵢ·Sᵢ·∂β/∂ρⱼ
```

### ∂²RSS/∂ρⱼ∂ρᵢ

```
RSS = ||y - Xβ||² = r'·r  where r = y - Xβ

∂RSS/∂ρᵢ = -2·r'·X·∂β/∂ρᵢ

∂²RSS/∂ρⱼ∂ρᵢ = -2·[∂r'/∂ρⱼ·X·∂β/∂ρᵢ + r'·X·∂²β/∂ρⱼ∂ρᵢ]

Since ∂r/∂ρⱼ = -X·∂β/∂ρⱼ:

∂²RSS/∂ρⱼ∂ρᵢ = -2·[-∂β'/∂ρⱼ·X'·X·∂β/∂ρᵢ + r'·X·∂²β/∂ρⱼ∂ρᵢ]
               = 2·∂β'/∂ρⱼ·X'·X·∂β/∂ρᵢ - 2·r'·X·∂²β/∂ρⱼ∂ρᵢ
```

### ∂²φ/∂ρⱼ∂ρᵢ

```
φ = RSS / (n-r)

∂φ/∂ρᵢ = (1/(n-r))·∂RSS/∂ρᵢ

∂²φ/∂ρⱼ∂ρᵢ = (1/(n-r))·∂²RSS/∂ρⱼ∂ρᵢ
```

### ∂²P/∂ρⱼ∂ρᵢ

```
P = RSS + Σₖ λₖ·β'·Sₖ·β

∂P/∂ρᵢ = ∂RSS/∂ρᵢ + λᵢ·β'·Sᵢ·β + 2·Σₖ λₖ·∂β'/∂ρᵢ·Sₖ·β

Note: The factor of 2 comes from ∂/∂ρᵢ[β'·Sₖ·β] = 2·∂β'/∂ρᵢ·Sₖ·β (by symmetry of Sₖ)

∂²P/∂ρⱼ∂ρᵢ = ∂²RSS/∂ρⱼ∂ρᵢ
             + ∂/∂ρⱼ[λᵢ·β'·Sᵢ·β]
             + 2·∂/∂ρⱼ[Σₖ λₖ·∂β'/∂ρᵢ·Sₖ·β]

For the second term:
∂/∂ρⱼ[λᵢ·β'·Sᵢ·β] = δᵢⱼ·λᵢ·β'·Sᵢ·β + 2·λᵢ·∂β'/∂ρⱼ·Sᵢ·β

For the third term:
∂/∂ρⱼ[Σₖ λₖ·∂β'/∂ρᵢ·Sₖ·β] = Σₖ[δₖⱼ·λₖ·∂β'/∂ρᵢ·Sₖ·β + λₖ·∂²β'/∂ρⱼ∂ρᵢ·Sₖ·β + λₖ·∂β'/∂ρᵢ·Sₖ·∂β/∂ρⱼ]

Therefore:
∂²P/∂ρⱼ∂ρᵢ = ∂²RSS/∂ρⱼ∂ρᵢ
             + δᵢⱼ·λᵢ·β'·Sᵢ·β
             + 2·λᵢ·∂β'/∂ρⱼ·Sᵢ·β
             + 2·Σₖ[δₖⱼ·λₖ·∂β'/∂ρᵢ·Sₖ·β + λₖ·∂²β'/∂ρⱼ∂ρᵢ·Sₖ·β + λₖ·∂β'/∂ρᵢ·Sₖ·∂β/∂ρⱼ]
```

## Final Hessian Assembly

Combining all terms:

```
H[i,j] = [
    δᵢⱼ·λᵢ·tr(A⁻¹·Sᵢ) - λᵢ·λⱼ·tr(A⁻¹·Sⱼ·A⁻¹·Sᵢ)
    + (1/φ)·∂²P/∂ρⱼ∂ρᵢ
    - (1/φ²)·[∂φ/∂ρⱼ·∂P/∂ρᵢ + ∂P/∂ρⱼ·∂φ/∂ρᵢ]
    + 2·(P/φ³)·∂φ/∂ρⱼ·∂φ/∂ρᵢ
    - (P/φ²)·∂²φ/∂ρⱼ∂ρᵢ
    + (n-r)·(1/φ)·∂²φ/∂ρⱼ∂ρᵢ
    - (n-r)·(1/φ²)·∂φ/∂ρⱼ·∂φ/∂ρᵢ
] / 2

Simplifying the φ terms:
H[i,j] = [
    δᵢⱼ·λᵢ·tr(A⁻¹·Sᵢ) - λᵢ·λⱼ·tr(A⁻¹·Sⱼ·A⁻¹·Sᵢ)
    + (1/φ)·∂²P/∂ρⱼ∂ρᵢ
    - (1/φ²)·[∂φ/∂ρⱼ·∂P/∂ρᵢ + ∂P/∂ρⱼ·∂φ/∂ρᵢ]
    + 2·(P/φ³)·∂φ/∂ρⱼ·∂φ/∂ρᵢ
    + [(n-r) - P]·(1/φ²)·∂²φ/∂ρⱼ∂ρᵢ
    - (n-r)·(1/φ²)·∂φ/∂ρⱼ·∂φ/∂ρᵢ
] / 2
```

## Implementation Notes

1. Pre-compute:
   - `A⁻¹` (from QR: `A⁻¹ = P·P'` where `P = R⁻¹`)
   - `β = A⁻¹·X'y`
   - `r = y - Xβ`
   - `RSS`
   - `φ = RSS/(n-r)`
   - `P = RSS + Σₖ λₖ·β'·Sₖ·β`

2. For each i, compute:
   - `∂β/∂ρᵢ = -A⁻¹·λᵢ·Sᵢ·β`
   - `∂RSS/∂ρᵢ = -2·r'·X·∂β/∂ρᵢ`
   - `∂φ/∂ρᵢ = (1/(n-r))·∂RSS/∂ρᵢ`
   - `∂P/∂ρᵢ` (as in gradient)

3. For each (i,j) pair, compute:
   - `∂²β/∂ρⱼ∂ρᵢ`
   - `∂²RSS/∂ρⱼ∂ρᵢ`
   - `∂²φ/∂ρⱼ∂ρᵢ = (1/(n-r))·∂²RSS/∂ρⱼ∂ρᵢ`
   - `∂²P/∂ρⱼ∂ρᵢ`
   - Assemble `H[i,j]` using formula above

4. Return symmetric Hessian matrix
