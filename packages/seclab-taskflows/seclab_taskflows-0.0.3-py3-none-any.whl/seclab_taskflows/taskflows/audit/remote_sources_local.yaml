# SPDX-FileCopyrightText: 2025 GitHub
# SPDX-License-Identifier: MIT

seclab-taskflow-agent:
  filetype: taskflow
  version: 1

model_config: seclab_taskflows.configs.model_config_codeql_python

globals:
  repo:
# Taskflow to analyze the existing information
taskflow:
  - task:
      must_complete: true
      headless: true
      model: general_tasks
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        Clear the memory cache and clear the codeql_sqlite database for repo {{ GLOBALS_repo }}.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.memcache
        - seclab_taskflows.toolboxes.codeql_python
  - task:
      model: general_tasks
      must_complete: true
      headless: true
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        For the repo {{ GLOBALS_repo }} fetch the Python CodeQL database and find all remote flow sources using CodeQL.
      toolboxes:
        - seclab_taskflows.toolboxes.gh_code_scanning
        - seclab_taskflows.toolboxes.codeql_python
  - task:
      must_complete: true
      exclude_from_context: true
      model: general_tasks
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        Fetch the zipball of the repository {{ GLOBALS_repo }}.
      toolboxes:
        - seclab_taskflows.toolboxes.local_gh_resources
  - task:
      must_complete: true
      exclude_from_context: true
      model: general_tasks
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        Fetch the sources from the repo {{ GLOBALS_repo }}.
      toolboxes:
        - seclab_taskflows.toolboxes.codeql_python
  - task:
      model: code_analysis
      must_complete: false
      repeat_prompt: true
      max_steps: 100
      name: source analysis
      description: Identify actions that untrusted users are allowed to perform on the source.
      agents:
        - seclab_taskflows.personalities.auditor
      user_prompt: |
        The source is a {{ RESULT_source_type }} in {{ RESULT_repo }} in the location {{ RESULT_source_location }} on line {{ RESULT_line }}.
        If the source is in a folder relating to tests or demo code, skip the analysis and update the source entry in the codeql_sqlite database indicating it is not relevant.
        Analyze what the source endpoint is used for.
        If it is a web endpoint, identify the routing path that reaches this source, HTTP method,
        any middlewares used, which roles are allowed to call it.
        Note which kind of authentication is required for that endpoint.
        It is possible that the source does not require any authentication.
        If authorization is required, note the details.

        Update the source entry in the codeql_sqlite database with your findings.
        ## IMPORTANT: General Guidance that ALWAYS applies

        1. Do NOT ask the user for permission to perform next steps, continue your
        analysis autonomously until it is complete.

        2. Do NOT use 'fetch_sources' or 'remote_sources' tools.

        3. Do NOT speculate. If you do not have access to the information you need, respond with
        the error you encountered.
      toolboxes:
        - seclab_taskflows.toolboxes.codeql_python
        - seclab_taskflows.toolboxes.local_file_viewer
  - task:
      must_complete: true
      agents:
        - seclab_taskflows.personalities.auditor
      model: code_analysis
      user_prompt: |
        Fetch the sources of the repo {{ GLOBALS_repo }} and give a summary of the notes.
      toolboxes:
        - seclab_taskflows.toolboxes.codeql_python
