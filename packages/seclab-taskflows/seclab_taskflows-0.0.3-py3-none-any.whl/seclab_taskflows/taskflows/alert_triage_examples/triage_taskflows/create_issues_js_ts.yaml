# SPDX-FileCopyrightText: 2025 GitHub
# SPDX-License-Identifier: MIT

seclab-taskflow-agent:
  filetype: taskflow
  version: 1

model_config: seclab_taskflows.configs.model_config

taskflow:
  - task:
      must_complete: true
      exclude_from_context: true
      model: general_tasks
      name: get memcache entries
      agents:
        - seclab_taskflow_agent.personalities.assistant
      user_prompt: |
        Get all memcache entries
      toolboxes:
        - seclab_taskflow_agent.toolboxes.memcache
  - task:
      must_complete: true
      model: general_tasks
      name: fetch valid alert results
      agents:
        - seclab_taskflow_agent.personalities.assistant
      exclude_from_context: true
      user_prompt: |
        Fetch all the valid alert results of the rule `js/xss`.
      toolboxes:
        - seclab_taskflows.toolboxes.report_alert_state
  - task:
      must_complete: true
      repeat_prompt: true
      model: triage
      async: true
      name: create GitHub issue
      description: |
        Create a GitHub issue for a valid alert.
      agents:
        - seclab_taskflows.personalities.web_application_security_expert
      user_prompt: |
        The alert_id is {{ RESULT_alert_id }}. The repository name is {{ RESULT_repo }}

        First check if an open issue with the alert id already exists in {{ RESULT_repo }}.
        If it does, then do not create a new issue and your task is done.

        Otherwise, create an issue in {{ RESULT_repo }} using these notes:
        ```
        {{ RESULT_result }}
        ```
        Remove any duplicate information of the notes and use it as the issue body.
        The issue body should be formatted in markdown.
        
        Structure the issue body as follows:
        - Short summary
        - A list of entries with the factors that make the alert an exploitable vulnerability. Prepend each entry with a bullet point, followed by the :heavy_plus_sign: emoji.
        - Another list of entries with the factors that render the vulnerability of the alert not exploitable. Prepend each entry with a bullet point, followed by the :heavy_minus_sign: emoji.

        If references to source code locations are present in the notes, link them like this: https://github.com/{{ RESULT_repo }}/blob/master/{{ RESULT_file_path }}#L{{ RESULT_line_number }}). Remove any occurences of `'` from that link.

        At the bottom of the issue body create a link to the alert like this: https://github.com/{{ RESULT_repo }}/security/code-scanning/{{ RESULT_alert_id }}, name the link `Code scanning alert #{{ RESULT_alert_id }}`. Remove any occurences of `'` from that link.
        Then add following text to the issue body: ðŸ¤– I'm a robot beep boop.
        
        The title of the issue should be:
        ```
        Code scanning alert #{{ RESULT_alert_id }} triage report for {{ RESULT_rule }}. Remove any occurences of `'` from the rule.
        ```
        Use `barry-agent` as the label for the issue.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.github_official
        - seclab_taskflows.toolboxes.gh_code_scanning
      env:
        GITHUB_MCP_TOOLSETS: repos,issues
  - task:
      must_complete: true
      model: general_tasks
      name: fetch invalid alerts
      agents:
        - seclab_taskflow_agent.personalities.assistant
      exclude_from_context: true
      user_prompt: |
        Fetch all the invalid alert results of the rule `js/xss`.
      toolboxes:
        - seclab_taskflows.toolboxes.report_alert_state
  - task:
      must_complete: true
      model: triage
      agents:
        - seclab_taskflows.personalities.web_application_security_expert
      repeat_prompt: true
      async: true
      name: Create issue for FP
      description: |
        Create GitHub issue for FP alerts and label it with FP.
      user_prompt: |
        The alert_id is {{ RESULT_alert_id }}. The repository name is {{ RESULT_repo }}

        First check if an open issue with the alert id already exists in {{ RESULT_repo }}.
        If it does, then do not create a new issue and your task is done.

        Otherwise, create an issue in {{ RESULT_repo }} using these notes:
        ```
        {{ RESULT_result }}
        ```
        Remove any duplicate information of the notes and use it as the issue body.
        The issue body should be formatted in markdown.
        
        Structure the issue body as follows:
        - Short summary
        - A list of entries with the factors that make the alert an exploitable vulnerability. Prepend each entry with a bullet point, followed by the :heavy_plus_sign: emoji.
        - Another list of entries with the factors that render the vulnerability of the alert not exploitable. Prepend each entry with a bullet point, followed by the :heavy_minus_sign: emoji.
        The issue body should be formatted in markdown.

        If references to source code locations are present in the notes, link them like this: https://github.com/{{ RESULT_repo }}/blob/master/{{ RESULT_file_path }}#L{{ RESULT_line_number }}). Remove any occurences of `'` from that link.

        At the bottom of the issue body create a link to the alert like this: https://github.com/{{ RESULT_repo }}/security/code-scanning/{{ RESULT_alert_id }}, name the link `Code scanning alert #{{ RESULT_alert_id }}`. Remove any occurences of `'` from that link.
        Then add following text to the issue body: ðŸ¤– I'm a robot beep boop.

        The title of the issue should be:
        ```
        Code scanning alert #{{ RESULT_alert_id }} triage report for {{ RESULT_rule }}. Remove any occurences of `'` from the rule.
        ```
        Use [barry-agent,FP] as labels for the issue.
      toolboxes:
        - seclab_taskflow_agent.toolboxes.github_official
        - seclab_taskflows.toolboxes.gh_code_scanning
      env:
        GITHUB_MCP_TOOLSETS: repos,issues
