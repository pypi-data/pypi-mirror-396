# SPDX-FileCopyrightText: 2025 GitHub
# SPDX-License-Identifier: MIT

seclab-taskflow-agent:
  filetype: taskflow
  version: 1

model_config: seclab_taskflows.configs.model_config

globals:
  repo:
  id:
# Taskflow to audit some potential issues.
taskflow:
  - task:
      must_complete: true
      agents:
        - seclab_taskflows.personalities.web_application_security_expert
      model: code_analysis
      user_prompt: |
        Fetch the list of issues for component {{ GLOBALS_id }} in repo {{ GLOBALS_repo }}. Check if there is any issue 
        that involves access control or authentication. If there isn't any, then your task is finished.

        If there are any authentication or access control that are crucial in determining whether issue is vulnerable or not,
        then go through these measures and look carefully to see if there is any way to bypass these checks. Also look for 
        inconsistencies in access controls. The goal of this task is to scrutinize the access control, authentication
        relevent to the issue. You should limit your audit to those that are involved in the in issue. 

        Look at the authentication and access control mechanism used in this component. Note that the implementation of 
        the authentication and access control may well be defined outside of this component. In which case, you need to 
        look at files in the repo outside of the component. For each end point, take note of 
        its intended functionality and any access control/authetnication that is applied. When looking at access control,
        do not just check if access control is applied, but note down the exact role/authority that is required.

        Go through the list of access control and authentication that you made earlier, and consider the followings:
        - Look through end points functionalities and identify those that should require similar level of privilege. For example, 
        endpoint that modifies data should require similar privilege to endpoints that write to data, but endpoints that only 
        read data allows lower privilege. Within the group of endpoint, do access control ensure that they have the same privilege?
        Or do some endpoint required higher privilege than others? Take a note of such inconsistencies stating clearly 
        which endpoints should require similar privilege but doesn't. Then decide whether it is 
        a security issue or not.

        - Are there other ways to bypass ownership/access control checks via IDOR etc.?

        Do not consider scenarios where authentication is bypassed via stolen credential, misconfiguration etc. We only consider situations that are 
        achievable from within the source code itself.

        Keep a record of the audit notes, be sure to include all relevant file path and line number. Just stating an end point, e.g.
        `IDOR in user update/delete endpoints (PUT /user/:id)` is not sufficient. I need to have the file and line number.

        If you believe there is a vulnerability, then you must include a realistic attack scenario, with details of all the file and line included, and also what an 
        attacker can gain by exploiting the vulnerability. Only consider the issue a vulnerability if an attacker can gain privilege by 
        performing an action that is not intended by the component. However, if a realistic attack scenario exists but may not be a 
        security issue because the intention of the end point or privilege model is not clear from the source code alone, then you should 
        also include the issue but state clearly that it is a potential issue that requires further investigation into the intend of the 
        endpoint.

        It is ok to conclude that there is no security issue.

        Likewise, if while auditing these issues, you noticed other inconsistencies that may lead to vulnerabilities according to the 
        criteria that I set out, then do investigate such issues and include them in the notes.

        Before reporting to the user, reflect on the notes and check the attack scenario:
        1. Have you included all the file and line number?
        2. Have you included a scenario of how the vulnerability can be exploited, including the end point and untrusted input that 
        may be used?
        3. Is this a realistic scenario that does not require stolen credential, misconfiguration etc. that is outside of what can be achieved via source code?
        4. In the attack scenario, what privilege can an attacker gain that is not intended by the application?

        Remember, if these criteria are not satisfied, it is ok to report that there is no vulnerabilities.

      toolboxes:
        - seclab_taskflows.toolboxes.repo_context
        - seclab_taskflows.toolboxes.local_file_viewer
