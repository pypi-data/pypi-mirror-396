(()=>{"use strict";var e;var t="undefined"==typeof document?void 0:document,n=!!t&&"content"in t.createElement("template"),i=!!t&&t.createRange&&"createContextualFragment"in t.createRange();function o(o){return o=o.trim(),n?function(e){var n=t.createElement("template");return n.innerHTML=e,n.content.childNodes[0]}(o):i?function(n){return e||(e=t.createRange()).selectNode(t.body),e.createContextualFragment(n).childNodes[0]}(o):function(e){var n=t.createElement("body");return n.innerHTML=e,n.childNodes[0]}(o)}function r(e,t){var n,i,o=e.nodeName,r=t.nodeName;return o===r||(n=o.charCodeAt(0),i=r.charCodeAt(0),n<=90&&i>=97?o===r.toUpperCase():i<=90&&n>=97&&r===o.toUpperCase())}function a(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var s={OPTION:function(e,t){var n=e.parentNode;if(n){var i=n.nodeName.toUpperCase();"OPTGROUP"===i&&(i=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==i||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}a(e,t,"selected")},INPUT:function(e,t){a(e,t,"checked"),a(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var i=e.firstChild;if(i){var o=i.nodeValue;if(o==n||!n&&o==e.placeholder)return;i.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,i,o=-1,r=0,a=e.firstChild;a;)if("OPTGROUP"===(i=a.nodeName&&a.nodeName.toUpperCase()))(a=(n=a).firstChild)||(a=n.nextSibling,n=null);else{if("OPTION"===i){if(a.hasAttribute("selected")){o=r;break}r++}!(a=a.nextSibling)&&n&&(a=n.nextSibling,n=null)}e.selectedIndex=o}}};function d(){}function l(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var c=function(e){return function(n,i,a){if(a||(a={}),"string"==typeof i)if("#document"===n.nodeName||"HTML"===n.nodeName||"BODY"===n.nodeName){var c=i;(i=t.createElement("html")).innerHTML=c}else i=o(i);else 11===i.nodeType&&(i=i.firstElementChild);var u=a.getNodeKey||l,f=a.onBeforeNodeAdded||d,h=a.onNodeAdded||d,m=a.onBeforeElUpdated||d,p=a.onElUpdated||d,v=a.onBeforeNodeDiscarded||d,b=a.onNodeDiscarded||d,E=a.onBeforeElChildrenUpdated||d,N=a.skipFromChildren||d,g=a.addChild||function(e,t){return e.appendChild(t)},y=!0===a.childrenOnly,k=Object.create(null),A=[];function T(e){A.push(e)}function w(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var i=void 0;t&&(i=u(n))?T(i):(b(n),n.firstChild&&w(n,t)),n=n.nextSibling}}function S(e,t,n){!1!==v(e)&&(t&&t.removeChild(e),b(e),w(e,n))}function C(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=u(t);n&&(k[n]=t),C(t),t=t.nextSibling}}function L(e){h(e);for(var t=e.firstChild;t;){var n=t.nextSibling,i=u(t);if(i){var o=k[i];o&&r(t,o)?(t.parentNode.replaceChild(o,t),R(o,t)):L(t)}else L(t);t=n}}function R(n,i,o){var a=u(i);if(a&&delete k[a],!o){var d=m(n,i);if(!1===d)return;if(d instanceof HTMLElement&&C(n=d),e(n,i),p(n),!1===E(n,i))return}"TEXTAREA"!==n.nodeName?function(e,n){var i,o,a,d,l,c=N(e,n),h=n.firstChild,m=e.firstChild;e:for(;h;){for(d=h.nextSibling,i=u(h);!c&&m;){if(a=m.nextSibling,h.isSameNode&&h.isSameNode(m)){h=d,m=a;continue e}o=u(m);var p=m.nodeType,v=void 0;if(p===h.nodeType&&(1===p?(i?i!==o&&((l=k[i])?a===l?v=!1:(e.insertBefore(l,m),o?T(o):S(m,e,!0),o=u(m=l)):v=!1):o&&(v=!1),(v=!1!==v&&r(m,h))&&R(m,h)):3!==p&&8!=p||(v=!0,m.nodeValue!==h.nodeValue&&(m.nodeValue=h.nodeValue))),v){h=d,m=a;continue e}o?T(o):S(m,e,!0),m=a}if(i&&(l=k[i])&&r(l,h))c||g(e,l),R(l,h);else{var b=f(h);!1!==b&&(b&&(h=b),h.actualize&&(h=h.actualize(e.ownerDocument||t)),g(e,h),L(h))}h=d,m=a}!function(e,t,n){for(;t;){var i=t.nextSibling;(n=u(t))?T(n):S(t,e,!0),t=i}}(e,m,o);var E=s[e.nodeName];E&&E(e,n)}(n,i):s.TEXTAREA(n,i)}C(n);var x,I,M=n,O=M.nodeType,P=i.nodeType;if(!y)if(1===O)1===P?r(n,i)||(b(n),M=function(e,t){for(var n=e.firstChild;n;){var i=n.nextSibling;t.appendChild(n),n=i}return t}(n,(x=i.nodeName,(I=i.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==I?t.createElementNS(I,x):t.createElement(x)))):M=i;else if(3===O||8===O){if(P===O)return M.nodeValue!==i.nodeValue&&(M.nodeValue=i.nodeValue),M;M=i}if(M===i)b(n);else{if(i.isSameNode&&i.isSameNode(M))return;if(R(M,i,y),A)for(var q=0,U=A.length;q<U;q++){var D=k[A[q]];D&&S(D,D.parentNode,!1)}}return!y&&M!==n&&n.parentNode&&(M.actualize&&(M=M.actualize(n.ownerDocument||t)),n.parentNode.replaceChild(M,n)),M}}(function(e,t){var n,i,o,r,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var s=a.length-1;s>=0;s--)i=(n=a[s]).name,o=n.namespaceURI,r=n.value,o?(i=n.localName||i,e.getAttributeNS(o,i)!==r&&("xmlns"===n.prefix&&(i=n.name),e.setAttributeNS(o,i,r))):e.getAttribute(i)!==r&&e.setAttribute(i,r);for(var d=e.attributes,l=d.length-1;l>=0;l--)i=(n=d[l]).name,(o=n.namespaceURI)?(i=n.localName||i,t.hasAttributeNS(o,i)||e.removeAttributeNS(o,i)):t.hasAttribute(i)||e.removeAttribute(i)}});const u=c;var f=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function a(e){try{d(i.next(e))}catch(e){r(e)}}function s(e){try{d(i.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}d((i=i.apply(e,t||[])).next())})};window.falk=new class{constructor(){this.init=()=>f(this,void 0,void 0,function*(){this.websocketsAvailable=yield this.connectWebsocket(),"complete"===document.readyState?this.dispatchRenderEvents(document.body,{initial:!0}):window.addEventListener("load",()=>{this.dispatchRenderEvents(document.body,{initial:!0})})}),this.parseDelay=e=>{if("number"==typeof e)return 1e3*e;const t=/^(\d+(?:\.\d+)?)(ms|s|m|h)?$/.exec(e.trim());if(!t)throw new Error("Invalid time format: "+e);const n=parseFloat(t[1]),i=t[2]||"s";if("ms"===i)return n;if("s"===i)return 1e3*n;if("m"===i)return 60*n*1e3;if("h"===i)return 60*n*60*1e3;throw new Error("Unknown unit: "+i)},this.sendHttpRequest=e=>f(this,void 0,void 0,function*(){return new Promise((t,n)=>f(this,void 0,void 0,function*(){const i=yield fetch(window.location+"",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),redirect:"manual"});i.ok||n(`HTTP error! Status: ${i.status}`);const o=yield i.json();o.flags.reload&&window.location.reload(),t(o)}))}),this.handleWebsocketMessage=e=>{const[t,n]=JSON.parse(e.data),i=n.json,o=this.pendingWebsocketRequests.get(t);i.flags.reload&&window.location.reload(),o.resolve(i),this.pendingWebsocketRequests.delete(n)},this.connectWebsocket=()=>new Promise(e=>{this.websocket=new WebSocket(window.location+""),this.websocket.addEventListener("message",this.handleWebsocketMessage),this.websocket.addEventListener("open",()=>{this.websocketMessageIdCounter=1,this.pendingWebsocketRequests=new Map,e(!0)}),this.websocket.addEventListener("error",t=>{e(!1)})}),this.sendWebsocketRequest=e=>f(this,void 0,void 0,function*(){return new Promise((t,n)=>f(this,void 0,void 0,function*(){this.websocket.readyState!==this.websocket.OPEN&&(yield this.connectWebsocket());const i=this.websocketMessageIdCounter,o=JSON.stringify([i,e]);this.websocketMessageIdCounter+=1,this.websocket.send(o),this.pendingWebsocketRequests.set(i,{resolve:t,reject:n})}))}),this.sendRequest=e=>f(this,void 0,void 0,function*(){return this.websocketsAvailable?yield this.sendWebsocketRequest(e):yield this.sendHttpRequest(e)}),this.iterNodes=(e,t,n=document.body)=>{n.nodeType===Node.ELEMENT_NODE&&(Array.from(n.children).forEach(n=>{this.iterNodes(e,t,n)}),n.matches(e)&&t(n))},this.dispatchEvent=(e,t)=>{const n=`on${e}`,i=`falk:${e}`,o=t.getAttribute(n),r=new Function("event",o),a=new CustomEvent(i,{bubbles:!0,cancelable:!0});try{r.call(t,a)}catch(e){console.error(e)}t.dispatchEvent(a)},this.dispatchRenderEvents=(e=document.body,t={initial:!1})=>{this.iterNodes("[data-falk-id]",n=>{(t.initial||n!=e)&&this.dispatchEvent("initialrender",n),this.dispatchEvent("render",n)},e)},this.dumpEvent=e=>{const t={type:"",data:void 0,formData:{}};if(!e)return t;if(t.type=e.type,"input"==e.type||"change"==e.type||"submit"==e.type)if(e.currentTarget instanceof HTMLFormElement){const n=new FormData(e.currentTarget);for(const[e,i]of n.entries())t.formData[e]=i}else{const n=e.currentTarget;if(t.data=n.value,n.hasAttribute("name")){const e=n.getAttribute("name");e&&(t.formData[e]=n.value)}}return t},this.patchNode=(e,t,n)=>{const i=e=>!n.forceRendering&&(!!n.skipRendering||e.hasAttribute("data-skip-rerendering"));return u(e,t,{onBeforeNodeAdded:e=>{if(e.nodeType!==Node.ELEMENT_NODE)return e;const t=e.tagName;return!["SCRIPT","LINK","STYLE"].includes(t)&&(i(e),e)},onBeforeNodeDiscarded:e=>{if(e.nodeType!==Node.ELEMENT_NODE)return!0;const t=e.tagName;return!["SCRIPT","LINK","STYLE"].includes(t)&&!i(e)},onBeforeElUpdated:(e,t)=>!i(e)&&(!["SCRIPT","LINK","STYLE"].includes(e.tagName)&&((e instanceof HTMLInputElement&&t instanceof HTMLInputElement||e instanceof HTMLTextAreaElement&&t instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement&&t instanceof HTMLSelectElement)&&(t.value=e.value),!0))})},this.patchNodeAttributes=(e,t)=>u(e,t,{onBeforeElChildrenUpdated:(e,t)=>!1}),this.runCallback=e=>f(this,void 0,void 0,function*(){let t;if(e.optionsString){const t=JSON.parse(decodeURIComponent(e.optionsString));e=Object.assign(t)}if(e.node)t=[e.node];else if(e.nodeId){const n=document.querySelector(`[data-falk-id=${e.nodeId}]`);if(!n)throw`no node with id ${e.nodeId}`;t=[n]}else e.selector&&(t=Array.from(document.querySelectorAll(e.selector)));for(const n of t){const t=n.getAttribute("data-falk-token"),i={requestType:"falk/mutation",nodeId:n.getAttribute("data-falk-id"),token:t,callbackName:e.callbackName||"",callbackArgs:e.callbackArgs||{},event:{}};e.event&&(i.event=this.dumpEvent(e.event)),e.event&&e.stopEvent&&(e.event.stopPropagation(),e.event.preventDefault()),setTimeout(()=>f(this,void 0,void 0,function*(){this.dispatchEvent("beforerequest",n);const e=yield this.sendRequest(i),t=(new DOMParser).parseFromString(e.body,"text/html");t.head.querySelectorAll("link[rel=stylesheet]").forEach(e=>{let t;const n=e.getAttribute("href");if(n)t=`link[href="${n}"]`;else{t=`link[data-falk-id="${e.getAttribute("data-falk-id")}"]`}document.querySelector(t)||document.head.appendChild(e)});t.head.querySelectorAll("style").forEach(e=>{const t=`style[data-falk-id="${e.getAttribute("data-falk-id")}"]`;document.querySelector(t)||document.head.appendChild(e)});const o=t.body.querySelectorAll("script"),r=new Array;o.forEach(e=>{let t;const n=e.getAttribute("src");if(n)t=`script[src="${n}"]`;else{t=`script[data-falk-id="${e.getAttribute("data-falk-id")}"]`}if(document.querySelector(t))return;const i=document.createElement("script");for(const t of e.attributes)i.setAttribute(t.name,t.value);if(e.src){const e=new Promise(e=>{i.addEventListener("load",()=>{e(null)})});r.push(e)}else i.textContent=e.textContent;document.body.appendChild(i)}),yield Promise.all(r),"HTML"==n.tagName?(this.patchNodeAttributes(n,t.children[0]),document.title=t.title,this.patchNode(document.body,t.body,e.flags)):this.patchNode(n,t.body.firstChild,e.flags),this.dispatchRenderEvents(n);for(const t of e.callbacks)this.runCallback({selector:t[0],callbackName:t[1],callbackArgs:t[2]})}),this.parseDelay(e.delay||0))}}),this.filterEvents=(e,t)=>n=>{if(n.target.matches(e))return t(n)},this.on=(...e)=>{const t=`falk:${e[0]}`;let n,i;2==e.length?(i=e[1],document.addEventListener(t,i)):3==e.length&&(n=e[1],i=e[2],document.addEventListener(t,this.filterEvents(n,i)))}}},window.falk.init()})();