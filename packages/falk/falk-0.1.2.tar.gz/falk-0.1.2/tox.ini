[tox]
envlist=python3.9,python3.10,python3.11,python3.12,python3.13


# tests
[testenv]
ignore_errors = True
deps = .[pytest,test]

passenv =
    DISPLAY

setenv =
    PYTHONPATH=/app/test_apps/
    PLAYWRIGHT_BROWSERS_PATH = /app/playwright

allowlist_externals =
    coverage \
    playwright

commands =
    playwright install

    coverage erase

    coverage run -a \
        -m pytest {tty:--color=yes} {posargs} \
            --junitxml {toxworkdir}{/}junit.{envname}.xml

    coverage report
    coverage xml
    coverage html -d htmlcov


[testenv:server]
deps = .[dev]
use_develop = True

commands =
    python3.13 -m watchfiles \
        "python3.13 -m falk.server -H 0.0.0.0 -P 8000 --configure-app=falk.test_app.configure_app" \
        /app/falk \
        --ignore-paths /app/falk/static


# docs
[testenv:docs]
deps = .[docs]

allowlist_externals =
    /bin/bash

commands =
    /bin/bash -c "cd docs && mkdocs build"


[testenv:docs-server]
deps = .[docs]
use_develop = True

allowlist_externals =
    /bin/bash

commands =
    /bin/bash -c "cd docs && mkdocs serve --dev-addr 0.0.0.0:8000"


[testenv:grip]
deps = .[docs]

commands =
    grip 0.0.0.0:8000


# test apps
[testenv:no-app]
deps = .[dev]
use_develop = True

commands =
    python3.13 -m watchfiles \
        "python3.13 -m falk.server -H 0.0.0.0 -P 8000" \
        /app/falk \
        --ignore-paths /app/falk/static


[testenv:wsgi-test-app]
deps = .[dev]
use_develop = True

setenv =
    PYTHONPATH=/app/test_apps/
    FALK_TOKEN_KEY=secret
    FALK_COMPONENT_ID_SALT=salt

commands =
    python3.13 -m watchfiles \
    	"uvicorn test_app.app:wsgi_app --host 0.0.0.0 --port 8000 --interface wsgi"
        /app/falk \
        /app/test_apps/test_app \
        --ignore-paths /app/falk/static

[testenv:asgi-test-app]
deps = .[dev]
use_develop = True

setenv =
    PYTHONPATH=/app/test_apps/
    FALK_TOKEN_KEY=secret
    FALK_COMPONENT_ID_SALT=salt

commands =
    python3.13 -m watchfiles \
    	"uvicorn test_app.app:asgi_app --host 0.0.0.0 --port 8000"
        /app/falk \
        /app/test_apps/test_app \
        --ignore-paths /app/falk/static
