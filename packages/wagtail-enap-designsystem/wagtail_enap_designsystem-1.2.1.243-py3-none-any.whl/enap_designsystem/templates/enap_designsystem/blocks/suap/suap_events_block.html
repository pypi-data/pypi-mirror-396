{% load wagtailcore_tags wagtailimages_tags %}
{% block block_render %}
{% load static %}
<section class="enap-events-section">
    <div class="enap-wrapper-texts">
        <h2 class="enap-h2-title"> {{ bloco_suap.title }}</h2>
        <h3 class="enap-sub-title"> {{ bloco_suap.description }} </h3>
    </div>
    
    <div class="enap-wrapper">
        <div class="enap-events-carousel-container" id="enap-events-carousel-container">
            <div class="enap-events-carousel-items" id="enap-events-carousel-items">
                {% for event in events_suap %}
                <div class="enap-events-carousel-item">
                    <a href="{{event.url}}" class="enap-events-item-link">
                        <div class="enap-events-carousel-item-content">
                            <div class="enap-events-carousel-datetime">
                                <div class="enap-event-date">
                                    <span class="enap-event-day">{{ event.data_inicio|date:"d" }}</span>
                                    <div class="enap-event-month-year">
                                        <span class="enap-text-date">{{ event.data_inicio|date:"F" }}</span>
                                        <span class="enap-text-date">{{ event.data_inicio|date:"Y" }}</span>
                                    </div>
                                    <span class="enap-text-date">{{ event.data_inicio|date:"l" }}</span>
                                </div>
                                {% if event.horario %}
                                    <p class="enap-event-time">{{ event.horario }}</p>
                                {% endif %}
                            </div>
                            <div class="enap-events-carousel-content">
                                <div>
                                <div class="enap-event-tag"> {{event.tipo_acao }} </div>
                                <h3 class="enap-events-title">{{ event.descricao|truncatewords:10 }}</h3>
                                <p class="enap-card-text">{{ event.breve_descricao|truncatechars:50 }}</p>
                                </div>
                                <div class="enap-event-location"><i class="fa-solid fa-location-dot"></i> {{ event.tipo_modalidade|capfirst }}</div>
                            </div>
                        </div>
                    </a>
                </div>
                {% empty %}
                <div class="enap-events-carousel-item">
                    <p>Nenhum evento disponível.</p>
                </div>
                {% endfor %}
            </div>
            <button tabindex="-1" class="enap-events-carousel-control enap-events-carousel-control-prev"><img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconleft.svg' %}" alt="Passar pro lado esquerdo"></button>
            <button tabindex="-1" class="enap-events-carousel-control enap-events-carousel-control-next"><img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconrig.svg' %}" alt="Passar pro lado direito"></button>
        </div>
    </div>

    
    <a class="btn-todos" href="/busca/?q=&tipo=eventos&ordenacao=recentes">Ver todos os eventos</a>
</section>

<style>
    .btn-todos{
        width: 210px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        text-decoration: none;
        color: #007D7A;
        border: 1px solid #007D7A;
        padding: 8px 24px;
        border-radius: 40px;
        margin: auto;
        background-color: white;
        font-weight: 600;
    }
    .enap-btn-todos:hover{
        color: #006969;
        border: 1px solid #006969;
    }

    .enap-btn-todos:active{
        color: #025257;
        border: 1px solid #025257;
    }
    .enap-events-section {
        max-width: 74.1rem;
        margin: auto;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 40px;
        overflow: hidden;
        padding: 60px 15px;
    }
    
    .enap-wrapper-texts {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .enap-h2-title {
        margin: 0;
        font-size: 40px;
        font-weight: 600;
        color: #024248;
    }
    
    .enap-sub-title {
        font-size: 20px;
        font-weight: 400;
        margin: 10px 0 0 0;
        color: #434A54;
    }
    
    .enap-wrapper {
        position: relative;
        width: 1142px;
        margin: auto;
    }
    
    .enap-events-carousel-container {
        position: relative;
        max-width: 1142px;
        margin: auto;
    }
    
    .enap-events-carousel-items {
        display: flex;
        transition: transform 0.3s ease-in-out;
        gap: 25px;
        cursor: grab;
        width: calc(100% + 25px); /* Compensa o gap */
        margin-right: -25px;
    }
    
    .enap-events-carousel-items:active {
        cursor: grabbing;
    }
    
    .enap-events-carousel-item {
        flex-shrink: 0;
        width: 367px;
        margin-right: 0; /* Remove qualquer margem extra */
    }
    
    .enap-events-item-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .enap-events-carousel-item-content {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #C8D1E0;
        height: 300px;
    }
    
    .enap-events-carousel-datetime {
        width: 35%;
        border-radius: 8px 0 0 8px;
        overflow: hidden;
        text-align: center;
        background-color: #EBEFF5;
        padding: 20px 10px;
        height: 216px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
    }
    
    .enap-event-date {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .enap-event-day {
        font-size: 44px;
        color: #007D7A;
        font-weight: 700;
        line-height: 1;
    }
    
    .enap-event-month-year {
        margin: 5px 0;
    }
    
    .enap-text-date {
        font-size: 16px;
        color: #58606E;
        font-weight: 300;
        text-align: center;
    }
    
    .enap-event-time {
        font-size: 14px;
        color: #58606E;
        margin-top: 10px;
    }
    
    .enap-events-carousel-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: space-between;
        width: 65%;
        background-color: white;
        height: 216px;
        padding: 20px;
        text-align: left;
        height: 100%;
    }
    
    .enap-event-tag {
        border: 1px solid #D1441F;
        font-size: 14px;
        color: #D1441F;
        border-radius: 24px;
        padding: 0px 15px;
        display: inline-block;
    }
    
    .enap-events-title {
        font-size: 20px;
        color: #007D7A;
        text-decoration: none;
        font-weight: 500;
        margin: 10px 0;
    }
    
    .enap-card-text {
        text-align: left;
        margin: 0;
        font-size: 14px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
    }
    
    .enap-event-location {
        font-size: 14px;
        color: #58606E;
    }
    
    .enap-events-carousel-control {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 30px;
        color: #333;
        cursor: pointer;
        border: none;
        background-color: transparent;
        z-index: 10;
    }
    
    .enap-events-carousel-control-prev {
        left: -22px;
    }
    
    .enap-events-carousel-control-next {
        right: -22px;
    }
    
    .enap-btn {
        border: none;
        border-radius: 32px;
        color: #007D7A;
        text-decoration: none;
        display: inline-block;
        margin-top: 20px;
    }
    
    /* Estilos responsivos */
    @media (max-width: 992px) {
        .enap-events-section {
            gap: 30px;
            padding-left: 10px;
        }
        
        .enap-h2-title {
            font-size: 32px;
        }
        
        .enap-sub-title {
            font-size: 20px;
            text-align: left;
        }

        .enap-wrapper-texts {
            margin-top: 0px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 81vw;
        }
    }
    
    @media (max-width: 1142px) {
        .enap-wrapper {
            width: 100%;
            padding: 0 20px;
        }
    }
    
    @media (max-width: 768px) {
        .enap-events-carousel-control {
            display: none !important;
        }

        
        .enap-h2-title {
            font-size: 32px;
            text-align: left;
        }
    
        .enap-wrapper-texts{
            width: 100%;
        }
        
        .enap-sub-title {
            font-size: 20px;
            text-align: left;
        }
        
        /* CRUCIAL: Ajustar container para mobile - IGUAL AO SUAP */
        .enap-wrapper{
            width: 100vw;
            margin-left: calc(-50vw + 50%);
            padding: 0 16px;
        }
    
        .enap-events-carousel-container {
            width: 100%;
            margin: 0;
        }
    
        .enap-events-carousel-items {
            width: auto;
            margin-right: 0;
            align-items: stretch;
        }
        
        .enap-events-carousel-item {
            width: 70vw;
            max-width: 367px;
            height: 60vh;
        }
    }
    
    @media (max-width: 576px) {
        .enap-events-carousel-item-content {
            flex-direction: column;
            height: 100%;
        }
        
        .enap-events-carousel-datetime {
            width: 100%;
            height: 40%;
            border-radius: 8px 8px 0 0;
            padding: 15px;
        }
        
        .enap-events-carousel-content {
            width: 100%;
            height: 60%;
            padding: 15px;
            gap: 10px;
        }
        
        .enap-event-day {
            font-size: 36px;
        }
        
        .enap-events-title {
            font-size: 18px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const carousel = document.getElementById('enap-events-carousel-items');
        const prevButton = document.querySelector('.enap-events-carousel-control-prev');
        const nextButton = document.querySelector('.enap-events-carousel-control-next');
        const items = carousel.querySelectorAll('.enap-events-carousel-item');
        
        let currentIndex = 0;
        let startX, moveX, initialPosition;
        let isDragging = false;
        let itemWidth, itemsGap, containerWidth, visibleItems, maxIndex;
        
        // Variáveis para scroll fluido
        let scrollAccumulator = 0;
        let isScrolling = false;
        let scrollTimeout;
        let scrollAnimationFrame;
        
        // Função para calcular dimensões de forma responsiva
        function calculateDimensions() {
            if (items.length === 0) return;
            
            itemWidth = items[0].offsetWidth;
            itemsGap = 25;
            
            // Obter a largura real do container pai
            const containerElement = carousel.parentElement;
            containerWidth = containerElement.offsetWidth;
            
            // No mobile, consideramos que só cabe 1 item por vez devido ao padding e margens
            if (window.innerWidth <= 768) {
                // No mobile, normalmente só conseguimos ver 1 item completo
                const availableWidth = containerWidth - 32; // padding
                visibleItems = Math.floor(availableWidth / (itemWidth + itemsGap));
                if (visibleItems < 1) visibleItems = 1;
            } else {
                // Desktop - calcular baseado no tamanho fixo original
                visibleItems = Math.floor(containerWidth / (itemWidth + itemsGap));
                if (visibleItems === 0) visibleItems = 3; // fallback desktop
            }
            
            const totalItems = items.length;
            maxIndex = Math.max(0, totalItems - visibleItems);
        }
        
        // Função para posicionar o carousel com índice fracionário (scroll fluido)
        function setCarouselPosition(index) {
            calculateDimensions();
            // Permitir valores fracionários para movimento fluido
            const clampedIndex = Math.max(0, Math.min(index, maxIndex));
            const offset = clampedIndex * (itemWidth + itemsGap);
            carousel.style.transform = `translateX(-${offset}px)`;
            return clampedIndex;
        }
        
        // Função para exibir o slide (com snap para índice inteiro)
        function showSlide(index) {
            currentIndex = Math.max(0, Math.min(Math.round(index), maxIndex));
            setCarouselPosition(currentIndex);
            updateNavigationButtons();
        }
        
        // Função para atualizar a visibilidade dos botões de navegação
        function updateNavigationButtons() {
            // No mobile, os botões já estão escondidos via CSS
            if (window.innerWidth <= 768) {
                return;
            }
            
            // Desktop - lógica original
            if (currentIndex === 0) {
                prevButton.style.display = 'none';
                nextButton.style.display = maxIndex > 0 ? 'block' : 'none';
            } else if (currentIndex >= maxIndex) {
                prevButton.style.display = 'block';
                nextButton.style.display = 'none';
            } else {
                prevButton.style.display = 'block';
                nextButton.style.display = 'block';
            }
        }
        
        // Inicializar após o DOM estar pronto
        setTimeout(() => {
            calculateDimensions();
            updateNavigationButtons();
        }, 100);
        
        // Controles de seta
        prevButton.addEventListener('click', () => {
            const moveBy = window.innerWidth <= 768 ? 1 : 3;
            showSlide(currentIndex - moveBy);
        });
        
        nextButton.addEventListener('click', () => {
            const moveBy = window.innerWidth <= 768 ? 1 : 3;
            showSlide(currentIndex + moveBy);
        });
        
        // SCROLL FLUIDO dinâmico com trackpad
        carousel.addEventListener('wheel', function(e) {
            if (Math.abs(e.deltaX) > 0) {
                e.preventDefault();
                
                // Obter posição atual
                const currentTransform = carousel.style.transform;
                const match = currentTransform.match(/translateX\((-?\d*\.?\d*)px\)/);
                let currentOffset = match ? parseFloat(match[1]) : 0;
                
                // Movimento proporcional ao deltaX
                const scrollMultiplier = 1.5;
                const newOffset = currentOffset - (e.deltaX * scrollMultiplier);
                
                // Limites
                const maxOffset = 0;
                const minOffset = -(maxIndex * (itemWidth + itemsGap));
                
                // Resistência nas bordas
                let finalOffset = newOffset;
                if (newOffset > maxOffset) {
                    finalOffset = maxOffset + ((newOffset - maxOffset) * 0.3);
                } else if (newOffset < minOffset) {
                    finalOffset = minOffset + ((newOffset - minOffset) * 0.3);
                }
                
                // Aplicar posição
                carousel.style.transition = 'none';
                carousel.style.transform = `translateX(${finalOffset}px)`;
                
                // Atualizar currentIndex
                const newIndex = Math.round(Math.abs(finalOffset) / (itemWidth + itemsGap));
                currentIndex = Math.max(0, Math.min(newIndex, maxIndex));
                updateNavigationButtons();
                
                // Snap quando parar
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    carousel.style.transition = 'transform 0.3s ease-out';
                    showSlide(currentIndex);
                }, 150);
            }
        }, { passive: false });
        
        // Touch e arraste para mobile
        carousel.addEventListener('touchstart', handleStart, { passive: true });
        carousel.addEventListener('touchmove', handleMove, { passive: true });
        carousel.addEventListener('touchend', handleEnd, { passive: true });
        
        // Mouse para desktop (como fallback)
        carousel.addEventListener('mousedown', handleStart);
        carousel.addEventListener('mousemove', handleMove);
        carousel.addEventListener('mouseup', handleEnd);
        carousel.addEventListener('mouseleave', handleEnd);
        
        function handleStart(e) {
            calculateDimensions(); // Garantir que as dimensões estão atualizadas
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            initialPosition = currentIndex * (itemWidth + itemsGap);
            
            // Desativar transição durante o arrasto para melhor responsividade
            carousel.style.transition = 'none';
        }
        
        function handleMove(e) {
            if (!isDragging) return;
            
            moveX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const diff = moveX - startX;
            
            // Limitar o arrasto
            if (currentIndex === 0 && diff > 50) {
                carousel.style.transform = `translateX(${diff / 3 - initialPosition}px)`;
            } else if (currentIndex === maxIndex && diff < -50) {
                carousel.style.transform = `translateX(${diff / 3 - initialPosition}px)`;
            } else {
                carousel.style.transform = `translateX(${diff - initialPosition}px)`;
            }
        }
        
        function handleEnd() {
            if (!isDragging) return;
            isDragging = false;
            
            // Restaurar transição
            carousel.style.transition = 'transform 0.3s ease-in-out';
            
            if (!moveX || !startX) {
                showSlide(currentIndex);
                return;
            }
            
            const diff = moveX - startX;
            if (diff > 50) {
                showSlide(currentIndex - 1);
            } else if (diff < -50) {
                showSlide(currentIndex + 1);
            } else {
                showSlide(currentIndex);
            }
        }
        
        // Previne cliques em links durante arrasto
        const links = carousel.querySelectorAll('a');
        links.forEach(link => {
            link.addEventListener('click', function(e) {
                if (isDragging || (moveX && Math.abs(moveX - startX) > 10)) {
                    e.preventDefault();
                }
            });
        });
        
        // Ajustar o carrossel quando a janela é redimensionada
        window.addEventListener('resize', function() {
            setTimeout(() => {
                calculateDimensions();
                // Ajustar currentIndex se necessário
                if (currentIndex > maxIndex) {
                    currentIndex = maxIndex;
                }
                showSlide(currentIndex);
            }, 150);
        });
        
        // Aguardar que todas as imagens carreguem para inicializar corretamente
        window.addEventListener('load', function() {
            setTimeout(function() {
                carousel.style.transition = 'transform 0.3s ease-in-out';
                showSlide(0);
            }, 100);
        });
        
        // Inicializa o carousel
        showSlide(0);
    });
</script>
{% endblock %}