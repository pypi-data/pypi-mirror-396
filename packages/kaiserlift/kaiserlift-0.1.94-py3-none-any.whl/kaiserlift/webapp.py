"""Simple FastAPI application for KaiserLift.

This module exposes two endpoints:

* ``GET /`` – serves a small HTML form for uploading a FitNotes CSV file.
* ``POST /upload`` – accepts the uploaded CSV, processes it with the core
  KaiserLift utilities and returns the full HTML page generated by
  :func:`gen_html_viewer`.

The application can be started with ``python -m kaiserlift.webapp`` which will
launch a Uvicorn development server.
"""

from __future__ import annotations

import os

from fastapi import FastAPI, File, UploadFile
from fastapi.responses import HTMLResponse

from .pipeline import pipeline
from .running_pipeline import running_pipeline


app = FastAPI()


@app.get("/", response_class=HTMLResponse)
async def index() -> HTMLResponse:
    """Return a simple upload form."""

    return HTMLResponse(
        """
        <!DOCTYPE html>
        <html>
            <head>
                <title>KaiserLift - Data-Driven Workout Optimization</title>
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
                <style>
                    :root {
                        --primary-green: #4a7c59;
                        --primary-green-hover: #3d6a4a;
                        --bg: #f9f9f9;
                        --fg: #444444;
                        --fg-light: #666666;
                        --bg-alt: #ffffff;
                        --border: #e0e0e0;
                        --shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    body {
                        font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        background-color: var(--bg);
                        color: var(--fg);
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        min-height: 100vh;
                        padding: 40px 20px;
                        text-align: center;
                        line-height: 1.6;
                    }
                    .hero {
                        margin-bottom: 50px;
                    }
                    .hero h1 {
                        font-family: 'Oswald', sans-serif;
                        font-size: 3.5em;
                        font-weight: 400;
                        letter-spacing: 2px;
                        margin-bottom: 15px;
                        text-transform: uppercase;
                    }
                    .hero h1 .brand-name {
                        color: var(--fg);
                    }
                    .hero h1 .brand-accent {
                        color: var(--primary-green);
                    }
                    .tagline {
                        font-size: 1.1em;
                        font-style: italic;
                        font-weight: 300;
                        color: var(--fg-light);
                        margin-bottom: 30px;
                    }
                    .demo-button {
                        background-color: var(--primary-green);
                        color: white;
                        padding: 14px 32px;
                        border: none;
                        border-radius: 4px;
                        font-family: 'Lato', sans-serif;
                        font-size: 1em;
                        font-weight: 700;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .demo-button:hover {
                        background-color: var(--primary-green-hover);
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                    }
                    .upload-section {
                        margin-top: 30px;
                        width: 100%;
                        max-width: 500px;
                    }
                    .upload-section h2 {
                        font-family: 'Oswald', sans-serif;
                        font-size: 1.3em;
                        font-weight: 400;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        color: var(--fg);
                        margin-bottom: 25px;
                    }
                    .upload-section h3 {
                        font-family: 'Lato', sans-serif;
                        font-size: 1em;
                        font-weight: 700;
                        color: var(--fg);
                        margin-top: 20px;
                        margin-bottom: 10px;
                    }
                    form {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        padding: 20px;
                        background-color: var(--bg-alt);
                        border: 1px solid var(--border);
                        border-radius: 4px;
                        margin: 10px 0;
                    }
                    input[type="file"] {
                        color: var(--fg);
                        padding: 10px;
                        font-family: 'Lato', sans-serif;
                    }
                    input[type="submit"] {
                        padding: 12px 24px;
                        background-color: var(--primary-green);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-family: 'Lato', sans-serif;
                        font-weight: 700;
                        font-size: 0.9em;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        transition: all 0.2s ease;
                    }
                    input[type="submit"]:hover {
                        background-color: var(--primary-green-hover);
                    }
                    .loading {
                        display: none;
                        margin: 30px;
                    }
                    .spinner {
                        border: 3px solid var(--border);
                        border-top: 3px solid var(--primary-green);
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 15px;
                    }
                    .loading p {
                        font-style: italic;
                        color: var(--fg-light);
                    }
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .social-links {
                        margin-top: 40px;
                        display: flex;
                        gap: 15px;
                        justify-content: center;
                    }
                    .social-link {
                        width: 45px;
                        height: 45px;
                        border-radius: 50%;
                        background-color: #555;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        text-decoration: none;
                        font-size: 1.2em;
                        transition: background-color 0.2s ease;
                    }
                    .social-link:hover {
                        background-color: var(--primary-green);
                    }
                    footer {
                        margin-top: 50px;
                        font-size: 0.85em;
                        color: var(--fg-light);
                    }
                    footer a {
                        color: var(--primary-green);
                        text-decoration: none;
                    }
                    footer a:hover {
                        text-decoration: underline;
                    }
                    @media (max-width: 600px) {
                        .hero h1 {
                            font-size: 2.5em;
                        }
                        .upload-section {
                            padding: 0 10px;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="hero">
                    <h1><span class="brand-name">KAISER</span><span class="brand-accent">LIFT</span></h1>
                    <p class="tagline">Data-driven workout optimization. Never guess your next workout again.</p>
                    <button class="demo-button" onclick="loadDemo()">
                        Try Demo with Sample Data
                    </button>
                </div>

                <div class="upload-section">
                    <h2>Or Upload Your Own Data</h2>

                    <h3>Lifting Data</h3>
                    <form action="/upload" method="post" enctype="multipart/form-data">
                        <input type="file" name="file" accept=".csv" />
                        <input type="submit" value="Upload Lifting Data" />
                    </form>

                    <h3>Running Data</h3>
                    <form action="/upload-running" method="post" enctype="multipart/form-data">
                        <input type="file" name="file" accept=".csv" />
                        <input type="submit" value="Upload Running Data" />
                    </form>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Loading demo data...</p>
                </div>

                <div class="social-links">
                    <a href="https://github.com/douglastkaiser/kaiserlift" class="social-link" target="_blank" title="GitHub">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                    </a>
                </div>

                <footer>
                    <a href="https://douglastkaiser.github.io" target="_blank">douglastkaiser.github.io</a>
                </footer>

                <div id="result"></div>

                <script>
                async function loadDemo() {
                    const loading = document.getElementById('loading');
                    loading.style.display = 'block';

                    try {
                        const response = await fetch('/demo-data');
                        const html = await response.text();
                        document.body.innerHTML = html;
                    } catch (error) {
                        alert('Failed to load demo data: ' + error.message);
                    } finally {
                        loading.style.display = 'none';
                    }
                }
                </script>
            </body>
        </html>
        """,
    )


@app.post("/upload", response_class=HTMLResponse)
async def upload(file: UploadFile = File(...)) -> str:
    """Process the uploaded CSV via the core pipeline and return HTML.

    All numerical computations occur within :func:`pipeline`. Any JavaScript
    embedded in the resulting HTML is dedicated solely to updating the user
    interface and performs no calculations.
    """

    # ``pipeline`` no longer embeds required JavaScript and CSS assets by
    # default.  Explicitly enable ``embed_assets`` so the returned HTML is a
    # standalone page suitable for direct rendering by the browser.
    return pipeline([file.file], embed_assets=True)


@app.post("/upload-running", response_class=HTMLResponse)
async def upload_running(file: UploadFile = File(...)) -> str:
    """Process the uploaded running CSV via the running pipeline and return HTML.

    Processes running/cardio data with distance and pace metrics.
    Returns interactive HTML with Pareto front analysis and target recommendations.
    """

    return running_pipeline([file.file], embed_assets=True)


@app.get("/demo-data", response_class=HTMLResponse)
async def demo_data() -> str:
    """Serve pre-generated demo HTML with sample lifting data.

    This endpoint loads the example FitNotes CSV file from the test fixtures
    and processes it through the lifting pipeline to generate an interactive
    HTML demo that users can explore without uploading their own data.
    """

    import io
    from pathlib import Path

    # Load example CSV from test fixtures
    example_csv = (
        Path(__file__).parent.parent
        / "tests/example_use/FitNotes_Export_2025_05_21_08_39_11.csv"
    )

    if not example_csv.exists():
        return HTMLResponse(
            "<html><body><h1>Demo data not found</h1>"
            "<p>The example CSV file is not available in this deployment.</p></body></html>",
            status_code=404,
        )

    with open(example_csv, encoding="utf-8") as f:
        csv_content = f.read()

    return pipeline([io.StringIO(csv_content)], embed_assets=True)


def main() -> None:
    """Start a Uvicorn development server."""

    import uvicorn

    port = int(os.getenv("PORT", 8000))
    uvicorn.run("kaiserlift.webapp:app", host="0.0.0.0", port=port, reload=False)


if __name__ == "__main__":  # pragma: no cover - manual server start
    main()
