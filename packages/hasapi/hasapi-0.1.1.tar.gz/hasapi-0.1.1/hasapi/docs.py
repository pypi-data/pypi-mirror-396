"""
HasAPI OpenAPI Documentation Generator

Generates OpenAPI/Swagger specifications for HasAPI applications.
"""

import json
from typing import Dict, Any, List

from .utils import get_logger

logger = get_logger(__name__)


class OpenAPIGenerator:
    """Generates OpenAPI 3.0 specifications"""
    
    def __init__(self, app):
        """
        Initialize OpenAPI generator.
        
        Args:
            app: HasAPI application instance
        """
        self.app = app
    
    def generate(self) -> Dict[str, Any]:
        """
        Generate OpenAPI specification.
        
        Returns:
            OpenAPI 3.0 specification
        """
        spec = {
            "openapi": "3.0.0",
            "info": self._generate_info(),
            "servers": self._generate_servers(),
            "paths": self._generate_paths(),
            "components": self._generate_components()
        }
        
        return spec
    
    def _generate_info(self) -> Dict[str, Any]:
        """Generate info section"""
        return {
            "title": self.app.title,
            "version": self.app.version,
            "description": f"API generated by HasAPI",
            "contact": {
                "name": "HasAPI Team",
                "url": "https://github.com/hasapi/hasapi"
            },
            "license": {
                "name": "MIT",
                "url": "https://opensource.org/licenses/MIT"
            }
        }
    
    def _generate_servers(self) -> List[Dict[str, Any]]:
        """Generate servers section"""
        return [
            {
                "url": "http://localhost:8000",
                "description": "Development server"
            }
        ]
    
    def _generate_paths(self) -> Dict[str, Any]:
        """Generate paths section"""
        return self.app.router.generate_openapi_paths()
    
    def _generate_components(self) -> Dict[str, Any]:
        """Generate components section"""
        return {
            "securitySchemes": {
                "bearerAuth": {
                    "type": "http",
                    "scheme": "bearer",
                    "bearerFormat": "JWT",
                    "description": "JWT Bearer token authentication"
                }
            },
            "schemas": {
                "HTTPError": {
                    "type": "object",
                    "properties": {
                        "error": {
                            "type": "string",
                            "description": "Error description"
                        }
                    },
                    "required": ["error"]
                },
                "Message": {
                    "type": "object",
                    "properties": {
                        "message": {
                            "type": "string",
                            "description": "Response message"
                        }
                    },
                    "required": ["message"]
                }
            }
        }


class SwaggerUI:
    """Generates Swagger UI HTML for API documentation"""
    
    def __init__(self, openapi_spec: Dict[str, Any]):
        """
        Initialize Swagger UI generator.
        
        Args:
            openapi_spec: OpenAPI specification
        """
        self.spec = openapi_spec
    
    def generate_html(self) -> str:
        """
        Generate Swagger UI HTML.
        
        Returns:
            HTML content for Swagger UI
        """
        spec_json = json.dumps(self.spec, indent=2)
        
        return f"""
<!DOCTYPE html>
<html>
<head>
    <title>HasAPI - Swagger UI</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {{
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f7f7;
        }}
        .swagger-ui {{
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }}
        .header {{
            background-color: #4caf50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }}
        .header h1 {{
            margin: 0;
            font-size: 24px;
        }}
        .header .version {{
            background-color: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }}
        .api-info {{
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .api-info h2 {{
            margin-top: 0;
            color: #333;
        }}
        .api-info p {{
            color: #666;
            line-height: 1.5;
        }}
        .endpoint-list {{
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }}
        .endpoint {{
            border-bottom: 1px solid #eee;
            padding: 20px;
        }}
        .endpoint:last-child {{
            border-bottom: none;
        }}
        .method {{
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            margin-right: 10px;
        }}
        .get {{ background-color: #61affe; }}
        .post {{ background-color: #49cc90; }}
        .put {{ background-color: #fca130; }}
        .delete {{ background-color: #f93e3a; }}
        .patch {{ background-color: #5e72e4; }}
        .path {{
            font-family: monospace;
            font-weight: bold;
            color: #333;
        }}
        .description {{
            color: #666;
            margin-top: 5px;
        }}
        .try-it-out {{
            margin-top: 15px;
        }}
        .try-it-button {{
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }}
        .try-it-button:hover {{
            background-color: #45a049;
        }}
        .response-example {{
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }}
        .response-example h4 {{
            margin-top: 0;
            color: #333;
        }}
        .code {{
            background-color: #f1f3f4;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 12px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 14px;
            color: #333;
        }}
    </style>
</head>
<body>
    <div class="swagger-ui">
        <div class="header">
            <h1>HasAPI Documentation</h1>
            <div class="version">v{self.spec.get("info", {}).get("version", "1.0.0")}</div>
        </div>
        
        <div class="api-info">
            <h2>{self.spec.get("info", {}).get("title", "API")}</h2>
            <p>{self.spec.get("info", {}).get("description", "")}</p>
            <p><strong>Version:</strong> {self.spec.get("info", {}).get("version", "1.0.0")}</p>
            <p><strong>License:</strong> {self.spec.get("info", {}).get("license", {}).get("name", "MIT")}</p>
        </div>
        
        <div class="endpoint-list">
            {self._generate_endpoints()}
        </div>
    </div>
    
    <script>
        // OpenAPI spec
        const spec = {spec_json};
        
        // Try it out functionality
        function tryEndpoint(method, path, operation) {{
            const form = document.createElement('div');
            form.className = 'try-it-out';
            form.innerHTML = `
                <h4>Try it out</h4>
                <div>
                    <button class="try-it-button" onclick="executeRequest('${{method}}', '${{path}}')">
                        Execute Request
                    </button>
                </div>
                <div class="response-example" id="response-${{path.replace(/[^a-zA-Z0-9]/g, '_')}}" style="display: none;">
                    <h4>Response</h4>
                    <pre class="code" id="response-code-${{path.replace(/[^a-zA-Z0-9]/g, '_')}}"></pre>
                </div>
            `;
            return form;
        }}
        
        function executeRequest(method, path) {{
            const url = `http://localhost:8000${{path}}`;
            const responseDiv = document.getElementById(`response-${{path.replace(/[^a-zA-Z0-9]/g, '_')}}`);
            const codeDiv = document.getElementById(`response-code-${{path.replace(/[^a-zA-Z0-9]/g, '_')}}`);
            
            responseDiv.style.display = 'block';
            codeDiv.textContent = 'Loading...';
            
            fetch(url, {{
                method: method,
                headers: {{
                    'Content-Type': 'application/json'
                }}
            }})
            .then(response => response.json())
            .then(data => {{
                codeDiv.textContent = JSON.stringify(data, null, 2);
            }})
            .catch(error => {{
                codeDiv.textContent = `Error: ${{error.message}}`;
            }});
        }}
        
        // Generate endpoints
        {self._generate_endpoint_js()}
    </script>
</body>
</html>
        """
    
    def _generate_endpoints(self) -> str:
        """Generate endpoint HTML"""
        paths = self.spec.get("paths", {})
        endpoints_html = []
        
        for path, path_item in paths.items():
            for method, operation in path_item.items():
                endpoints_html.append(self._generate_endpoint_html(method, path, operation))
        
        return "\n".join(endpoints_html)
    
    def _generate_endpoint_html(self, method: str, path: str, operation: Dict[str, Any]) -> str:
        """Generate HTML for a single endpoint"""
        method_class = method.lower()
        summary = operation.get("summary", f"{method.upper()} {path}")
        description = operation.get("description", "")
        
        return f"""
        <div class="endpoint">
            <span class="method {method_class}">{method.upper()}</span>
            <span class="path">{path}</span>
            <div class="description">{summary}</div>
            {self._generate_try_it_html(method, path, operation) if method.upper() in ['GET', 'POST', 'PUT', 'DELETE'] else ''}
        </div>
        """
    
    def _generate_try_it_html(self, method: str, path: str, operation: Dict[str, Any]) -> str:
        """Generate try it out HTML for an endpoint"""
        # Generate a safe ID from the path
        import re
        safe_id = re.sub(r'[^a-zA-Z0-9]', '_', path)
        
        return f"""
        <div class="try-it-out">
            <h4>Try it out</h4>
            <div>
                <button class="try-it-button" onclick="executeRequest('{method}', '{path}')">
                    Execute Request
                </button>
            </div>
            <div class="response-example" id="response-{safe_id}" style="display: none;">
                <h4>Response</h4>
                <pre class="code" id="response-code-{safe_id}"></pre>
            </div>
        </div>
        """
    
    def _generate_endpoint_js(self) -> str:
        """Generate JavaScript for endpoints"""
        paths = self.spec.get("paths", {})
        js_code = []
        
        for path, path_item in paths.items():
            for method, operation in path_item.items():
                if method.upper() in ['GET', 'POST', 'PUT', 'DELETE']:
                    js_code.append(self._generate_endpoint_js(method, path, operation))
        
        return "\n".join(js_code)
    
    def _generate_endpoint_js(self, method: str, path: str, operation: Dict[str, Any]) -> str:
        """Generate JavaScript for a single endpoint"""
        # Generate a safe ID from the path
        import re
        safe_id = re.sub(r'[^a-zA-Z0-9]', '_', path)
        
        return f"""
        function executeRequest_{safe_id}() {{
            const url = `http://localhost:8000{path}`;
            const responseDiv = document.getElementById('response-{safe_id}');
            const codeDiv = document.getElementById('response-code-{safe_id}');
            
            responseDiv.style.display = 'block';
            codeDiv.textContent = 'Loading...';
            
            fetch(url, {{
                method: '{method}',
                headers: {{
                    'Content-Type': 'application/json'
                }}
            }})
            .then(response => response.json())
            .then(data => {{
                codeDiv.textContent = JSON.stringify(data, null, 2);
            }})
            .catch(error => {{
                codeDiv.textContent = `Error: ${{error.message}}`;
            }});
        }}
        """


def generate_openapi_spec(app) -> Dict[str, Any]:
    """
    Generate OpenAPI specification for a HasAPI app.
    
    Args:
        app: HasAPI application instance
        
    Returns:
        OpenAPI specification
    """
    generator = OpenAPIGenerator(app)
    return generator.generate()


def generate_swagger_ui(openapi_spec: Dict[str, Any]) -> str:
    """
    Generate Swagger UI HTML for OpenAPI specification.
    
    Args:
        openapi_spec: OpenAPI specification
        
    Returns:
        HTML content for Swagger UI
    """
    ui = SwaggerUI(openapi_spec)
    return ui.generate_html()