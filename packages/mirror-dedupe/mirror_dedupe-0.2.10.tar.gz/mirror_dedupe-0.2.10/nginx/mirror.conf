#
# mirror.conf : Ubuntu mirror synchronisation with global deduplication
#
# Copyright (c) 2025 Tim Hosking
# Email: tim@mungerware.com
# Website: https://github.com/munger
# Licence: MIT
#

server {
    listen 80;
    server_name mirror.private;

    charset utf-8;

    # All mirrors live flat under this root:
    #   /srv/mirror/repos/<name>/...
    # and are exposed as:
    #   http://mirror.private/<name>/...
    root /srv/mirror/repos;

    # Generic mapping: any first path segment becomes the repo name and
    # directories are listed using the built-in autoindex, wrapped with the
    # existing HTML header/footer from /assets/.
    #
    # Example mappings:
    #   /ubuntu-ports/... -> /srv/mirror/repos/ubuntu-ports/...
    #   /grafana/...      -> /srv/mirror/repos/grafana/...
    location / {
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;

        add_before_body /assets/mirror-header.html;
        add_after_body  /assets/mirror-footer.html;
    }
    
    # Assets remain separate from the mirror tree.
    location /assets/ {
        alias /etc/nginx/assets/;
    }
    
    access_log /var/log/nginx/mirror-access.log;
    error_log /var/log/nginx/mirror-error.log;
}
