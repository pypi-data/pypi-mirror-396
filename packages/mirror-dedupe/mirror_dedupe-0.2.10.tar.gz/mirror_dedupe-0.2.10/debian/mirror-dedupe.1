.TH MIRROR-DEDUPE 1 "December 2025" "mirror-dedupe 0.2.10" "User Commands"
.SH NAME
mirror-dedupe \- Ubuntu mirror synchronisation with global deduplication
.SH SYNOPSIS
.B mirror-dedupe
.RB [ \-\-config
.IR DIR ]
.RB [ \-h ]
.RB [ \-\-dry\-run ]
.RB [ \-\-mirror
.IR MIRROR ]
.RB [ \-\-dedupe\-only ]
.RB [ \-\-list ]
.RB [ \-\-activate
.IR MIRROR ]
.RB [ \-\-deactivate
.IR MIRROR ]
.RB [ \-\-test
.IR MIRROR ]
.RB [ \-\-delete
.IR MIRROR ]
\fR]
.SH DESCRIPTION
.B mirror-dedupe
synchronises Ubuntu package repositories and performs global deduplication
across multiple mirrors using hardlinks. This significantly reduces disk space
usage when hosting multiple Ubuntu mirrors or architectures.
.PP
The tool operates in three modes:
.IP "1." 4
.B Orchestrator mode
(default): Spawns subprocesses for each configured mirror, then performs
global deduplication across all mirrors.
.IP "2." 4
.B Single mirror mode
(\fB\-\-mirror\fR): Processes only the specified mirror.
.IP "3." 4
.B Dedupe-only mode
(\fB\-\-dedupe\-only\fR): Skips mirror synchronisation and only performs
deduplication.
.SH OPTIONS
.TP
.BR \-h ", " \-\-help
Show help message and exit.
.TP
.BR \-\-dry\-run
Show what would be done without actually making any changes.
.TP
.BR \-\-mirror " " \fIMIRROR\fR
Process only the specified mirror by name. Used internally by the orchestrator
to spawn subprocesses for each mirror.
.TP
.BR \-\-dedupe\-only
Only run the deduplication phase, skipping mirror synchronisation.
.TP
.BR \-\-config " " \fIDIR\fR
Path to configuration directory. Default: \fI/etc/mirror-dedupe\fR.
.TP
.BR \-\-list
List available mirrors, showing which are active (enabled) and which are inactive.
.TP
.BR \-\-activate " " \fIMIRROR\fR
Activate a mirror by creating a symlink in \fIrepos-enabled/\fR.
.TP
.BR \-\-deactivate " " \fIMIRROR\fR
Deactivate a mirror by removing its symlink from \fIrepos-enabled/\fR.
.TP
.BR \-\-test " " \fIMIRROR\fR
Test a mirror configuration. This performs basic connectivity checks against the
upstream URL (and configured GPG key URL, if present) and prints a summary of
what the mirror is configured to fetch, without making any changes.
.TP
.BR \-\-delete " " \fIMIRROR\fR
Deactivate a mirror and delete its data directory. This is a destructive
operation and requires an interactive PIN confirmation before proceeding.
.SH CONFIGURATION
Configuration files are located in \fI/etc/mirror-dedupe/\fR:
.TP
.I mirror-dedupe.conf
Main configuration file containing global settings such as buffer size,
parallel downloads, and curl timeout. It also supports a global
.B architectures
mask to restrict which architectures are mirrored, and a boolean
.B no_hardlinks
option which, when set to true, disables deduplication and causes
.B mirror-dedupe
to behave as a plain mirror.
.TP
.I repos-available/*.conf
Available mirror configuration files. Each file defines a repository mirror
with settings including:
.RS
.TP
.B name
Mirror identifier
.TP
.B upstream
Source repository URL
.TP
.B dest
Local destination path (relative to repo_root)
.TP
.B sync_method
Synchronisation method (rsync or https)
.TP
.B architectures
List of architectures to mirror (e.g., amd64, arm64)
.TP
.B components
Repository components (e.g., main, universe, multiverse)
.TP
.B distributions
Ubuntu releases to mirror (e.g., noble, jammy)
.TP
.B gpg_key_url
URL to repository GPG key (optional)
.TP
.B storage_filters
Optional per-mirror storage filters that control which files are
downloaded and kept on disk without modifying upstream indices.
This is a mapping that may contain:
.RS
.TP
.B exclude_packages
List of shell-style patterns matched against the package name (the
\fBPackage:\fR field in \fBPackages\fR/\fBSources\fR). Any entry
whose package name matches one of these patterns is skipped during
planning: it will not be downloaded and will be removed by the
cleanup phase if it already exists in the pool.
.TP
.B exclude_paths
List of shell-style patterns matched against the relative pool path
(for example, \fIp\%ool/main/g/grafana/grafana-enterprise-nightly_*\fR).
Entries whose paths match one of these patterns are also skipped.
.PP
   These filters only affect what is stored locally. The upstream
   \fBRelease\fR/\fBInRelease\fR and index files are always mirrored
   unchanged and retain their original signatures. Mirrors that use
   \fBstorage_filters\fR may advertise packages that are not present on disk.
.RE
.RE
.TP
.I repos-enabled/*.conf
Symlinks to configuration files in \fIrepos-available/\fR for mirrors that are
currently enabled.
.SH EXAMPLES
.TP
Run full synchronisation and deduplication:
.B mirror-dedupe
.TP
Dry run to see what would be changed:
.B mirror-dedupe \-\-dry\-run
.TP
Process only the 'ubuntu' mirror:
.B mirror-dedupe \-\-mirror ubuntu
.TP
Only perform deduplication (skip sync):
.B mirror-dedupe \-\-dedupe\-only
.TP
Use custom configuration directory:
.B mirror-dedupe \-\-config /path/to/config
.SH SYSTEMD INTEGRATION
The package includes systemd timer and service units:
.TP
.B mirror-dedupe.timer
Scheduled timer that runs the sync daily at a randomised time between
00:00-06:00 UTC.
.TP
.B mirror-dedupe.service
Service unit that executes the mirror synchronisation and deduplication.
.PP
To check timer status:
.RS
.B systemctl status mirror-dedupe.timer
.RE
.PP
To manually trigger a sync:
.RS
.B systemctl start mirror-dedupe.service
.RE
.PP
To view logs:
.RS
.B journalctl -u mirror-dedupe.service
.RE
.SH FILES
.TP
.I /etc/mirror-dedupe/mirror-dedupe.conf
Main configuration file
.TP
.I /etc/mirror-dedupe/repos-available/
Directory containing available mirror configurations
.TP
.I /etc/mirror-dedupe/repos-enabled/
Directory containing symlinks to enabled mirror configurations
.TP
.I /srv/mirror/repos/
Default base directory for mirrored repositories
.TP
.I /var/run/mirror_dedupe.*.pid
Lock files to prevent concurrent processing of the same mirror
.TP
.I /usr/lib/systemd/system/mirror-dedupe.service
Systemd service unit
.TP
.I /usr/lib/systemd/system/mirror-dedupe.timer
Systemd timer unit
.SH DEDUPLICATION
The tool performs global deduplication by:
.IP 1. 3
Collecting all package files across all configured mirrors
.IP 2. 3
Grouping files by SHA256 hash
.IP 3. 3
Downloading the first occurrence of each unique file
.IP 4. 3
Creating hardlinks for duplicate files (same hash, different paths)
.PP
This approach significantly reduces disk usage when hosting multiple mirrors
or architectures, as identical packages are stored only once.
.SH EXIT STATUS
.TP
.B 0
Success
.TP
.B 1
Error occurred during synchronisation or deduplication
.SH AUTHOR
Written by Tim Hosking.
.SH COPYRIGHT
Copyright 2025 Tim Hosking.
.br
Licence: MIT
.SH SEE ALSO
.BR curl (1),
.BR rsync (1),
.BR systemctl (1),
.BR journalctl (1)
