.TH MIRROR-DEDUPE-SCAN 1 "December 2025" "mirror-dedupe 0.2.10" "User Commands"
.SH NAME
mirror-dedupe-scan \- scan and generate repository configuration for mirror-dedupe
.SH SYNOPSIS
.B mirror-dedupe-scan
.RB [ \-\-name
.IR NAME ]
.RB [ \-\-dest
.IR DEST ]
.RB [ \-\-config-dir
.IR DIR ]
.RB [ \-r
.IR DIST ]
.RB [ \-R
.IR DISTS ]
.RB [ \-a
.IR ARCH ]
.RB [ \-A
.IR ARCHES ]
.RB [ \-c
.IR COMPONENT ]
.RB [ \-C
.IR COMPONENTS ]
.RB [ \-G
.IR URL ]
.RB [ \-g
.IR PATH ]
.RB [ \-\-method
.IR METHOD ]
.IR UPSTREAM-URL
.SH DESCRIPTION
.B mirror-dedupe-scan
automatically scans a Debian/Ubuntu repository and generates a configuration file for use with mirror-dedupe.
It detects the sync method (rsync or HTTPS), available architectures, components, distributions, and GPG key locations.
.PP
The generated configuration is saved to
.I /etc/mirror-dedupe/repos-available/
and can be enabled by creating a symlink in
.IR /etc/mirror-dedupe/repos-enabled/ .
.SH OPTIONS
.TP
.BR \-\-name " " \fINAME\fR
Repository name (required). Used for the configuration filename and as the default
destination path when \fB\-\-dest\fR is omitted.
.TP
.BR \-\-dest " " \fIDEST\fR
Destination path relative to repo_root. Defaults to the value of \fB\-\-name\fR if
not specified.
.TP
.BR \-\-config-dir " " \fIDIR\fR
Configuration directory (default: /etc/mirror-dedupe).
.TP
.BR \-r ", " \-\-dist ", " \-\-release " " " \fIDIST\fR
Add a distribution/suite. May be specified multiple times. When any
\fB\-r\fR/\fB\-\-dist\fR/\fB\-\-release\fR/\fB\-R\fR/\fB\-\-releases\fR
option is supplied, the scanner uses exactly the suites given (with special
handling for the value \(lqall\(rq; see below).
.TP
.BR \-R ", " \-\-releases " " " \fIDISTS\fR
Comma-separated list of distributions/suites. This is equivalent to specifying
multiple \fB\-r\fR options. If any item is the literal \(lqall\(rq, the
scanner writes every discovered suite into the generated configuration and
disables automatic distribution expansion.
.TP
.BR \-a ", " \-\-arch " " \fIARCH\fR
Architecture to include. May be specified multiple times.
.TP
.BR \-A ", " \-\-architectures " " \fIARCHES\fR
Comma-separated list of architectures to include. When present, these values
override any architectures parsed from Release files.
.TP
.BR \-c ", " \-\-component " " \fICOMPONENT\fR
Component to include (for example, \fBmain\fR or \fBuniverse\fR).
May be specified multiple times.
.TP
.BR \-C ", " \-\-components " " \fICOMPONENTS\fR
Comma-separated list of components to include. When present, these values
override any components parsed from Release files.
.TP
.BR \-G ", " \-\-gpg-key-url " " \fIURL\fR
Explicit GPG key URL for this repository. Must be used together with
\fB\-g\fR/\fB\-\-gpg-key-path\fR. If given, the scanner validates that the URL
is reachable before writing the configuration.
.TP
.BR \-g ", " \-\-gpg-key-path " " \fIPATH\fR
Relative GPG key path under repo_root (for example, \fBkeys/vendor.asc\fR).
Must be used together with \fB\-G\fR/\fB\-\-gpg-key-url\fR.
.TP
.BR \-\-method " " \fIMETHOD\fR
Force the sync method to use either \fBrsync\fR or \fBhttps\fR. When omitted,
the sync method is auto-detected.
.TP
.IR UPSTREAM-URL
URL of the upstream repository to scan.
.SH EXAMPLES
Scan the Ubuntu archive (noble):
.PP
.nf
.RS
mirror-dedupe-scan --name ubuntu --dest ubuntu \\
    --release noble \\
    http://archive.ubuntu.com/ubuntu
.RE
.fi
.PP
Scan the Grafana repository:
.PP
.nf
.RS
mirror-dedupe-scan --name grafana --dest grafana \\
    --gpg-key-url https://apt.grafana.com/gpg.key \\
    --gpg-key-path gpg.key \\
    https://apt.grafana.com
.RE
.fi
.PP
Scan the Docker repository (Ubuntu, noble):
.PP
.nf
.RS
mirror-dedupe-scan --name docker --dest docker \\
    --release noble \\
    --gpg-key-url https://download.docker.com/linux/ubuntu/gpg \\
    --gpg-key-path gpg \\
    https://download.docker.com/linux/ubuntu
.RE
.fi
.SH AUTO-DETECTION
The scanner automatically detects:
.TP
.B Sync method
Attempts to discover a suitable rsync daemon/module for the upstream host
using IPv4-only probes, selecting rsync only when a working \fBdists/\fR
tree is found; otherwise falls back to HTTPS. If
.B \-\-method
is supplied, its value is used instead of auto-detection.
.TP
.B Architectures
Parsed from the Release file
.TP
.B Components
Parsed from the Release file
.TP
.B Distributions
Discovered by listing the dists/ directory. When explicit distributions are
provided via \fB\-r\fR/\fB\-R\fR, those values are used directly (with the
special value \(lqall\(rq causing all discovered suites to be written to the
configuration with distribution expansion disabled). When no distribution
options are supplied at all, the scanner behaves as if \fB\-R all\fR had been
specified: every discovered suite is written to \fBdistributions:\fR and
distribution expansion is disabled.
.TP
.B GPG keys
Checks common GPG key locations and per-suite Release.gpg locations. Explicit
GPG key overrides provided via \fB\-G\fR/\fB\-g\fR are honoured directly after a
reachability check.
.SH ENABLING A REPOSITORY
After scanning, enable the repository:
.PP
.nf
.RS
cd /etc/mirror-dedupe/repos-enabled
ln -s ../repos-available/NAME.conf .
.RE
.fi
.SH FILES
.TP
.I /etc/mirror-dedupe/repos-available/
Directory containing available repository configurations
.TP
.I /etc/mirror-dedupe/repos-enabled/
Directory containing enabled repository configurations (symlinks)
.SH SEE ALSO
.BR mirror-dedupe (1)
.SH AUTHOR
Copyright (c) 2025 Tim Hosking
.br
Email: tim@mungerware.com
.br
Website: https://github.com/munger
.br
Licence: MIT
