# GitLab CI/CD Pipeline for Spacing
# Runs tests, quality checks, creates tags, and publishes to PyPI

stages:
  - lint
  - test
  - coverage
  - tag
  - publish

# Default configuration for all jobs
default:
  image: python:3.11
  before_script:
    - pip install -e .
    - pip install pytest pytest-cov ruff

# Lint stage: Code quality checks
lint:ruff:
  stage: lint
  script:
    - ruff check src/spacing/ test/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'

lint:format:
  stage: lint
  script:
    - ruff format --check src/spacing/ test/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'

lint:spacing:
  stage: lint
  script:
    - PYTHONPATH=src python -m spacing.cli --check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'

# Test stage: Run tests on multiple Python versions
.test_template: &test_template
  stage: test
  script:
    - PYTHONPATH=src pytest test/ -v --junitxml=report.xml --cov=spacing --cov-report=term --cov-report=xml
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG'

test:python3.11:
  <<: *test_template
  image: python:3.11

test:python3.12:
  <<: *test_template
  image: python:3.12

test:python3.13:
  <<: *test_template
  image: python:3.13

test:python3.14:
  <<: *test_template
  image: python:3.14

# Coverage stage: Generate coverage report
coverage:report:
  stage: coverage
  script:
    - pip install coverage
    - PYTHONPATH=src pytest test/ --cov=spacing --cov-report=term-missing --cov-report=html
    - echo "Coverage report generated in htmlcov/"
  artifacts:
    paths:
      - htmlcov/
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  needs:
    - test:python3.11

# Tag stage: Automatically create version tags when pyproject.toml version changes on main
auto-tag:
  stage: tag
  image: python:3.11
  before_script:
    # Configure git for automated commits/tags
    - git config user.email "ci@gitlab.com"
    - git config user.name "GitLab CI"
    # Fetch full history for tag checking
    - git fetch --tags
  script:
    # Extract version from pyproject.toml
    - |
      VERSION=$(python3 -c "
      import tomllib
      with open('pyproject.toml', 'rb') as f:
          data = tomllib.load(f)
      print(data['project']['version'])
      ")
      echo "Version in pyproject.toml: $VERSION"
    # Check if tag already exists
    - |
      TAG_NAME="v${VERSION}"
      if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
        echo "Tag $TAG_NAME already exists, skipping tag creation"
        exit 0
      fi
      echo "Creating new tag: $TAG_NAME"
    # Create and push tag (only if it doesn't exist)
    - |
      if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
        git tag -a "$TAG_NAME" -m "Release version $VERSION"
        # Use PROJECT_ACCESS_TOKEN for pushing (must be configured in CI/CD variables)
        git push https://oauth2:${PROJECT_ACCESS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git "$TAG_NAME"
        echo "Successfully created and pushed tag $TAG_NAME"
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
        - pyproject.toml
  needs:
    - test:python3.11
    - test:python3.12
    - test:python3.13
    - test:python3.14

# Publish stage: Deploy to PyPI on tags (triggered by auto-tag or manual tags)
publish:pypi:
  stage: publish
  image: python:3.11
  before_script:
    - pip install build twine
  script:
    - echo "Building package for PyPI release..."
    - python -m build
    - echo "Uploading to PyPI..."
    - twine upload -u $PYPI_USERNAME -p $PYPI_PASSWORD dist/*
    - echo "Successfully published to PyPI!"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
  needs:
    - test:python3.11
    - test:python3.12
    - test:python3.13
    - test:python3.14
  environment:
    name: production
    url: https://pypi.org/project/spacing/
