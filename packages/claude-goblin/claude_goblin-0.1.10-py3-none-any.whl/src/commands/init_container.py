"""
Initialize devcontainer for safe Claude Code execution.

Creates .devcontainer/ with Dockerfile, devcontainer.json, and firewall script
for running Claude Code with --dangerously-skip-permissions in an isolated container.
"""
import shutil
import subprocess
from pathlib import Path
from rich.console import Console


# region Templates

DOCKERFILE_TEMPLATE = r'''# Dockerfile for Claude Code sandboxed development environment
# Generated by claude-goblin init-container

ARG PYTHON_VERSION=3.12
FROM python:${PYTHON_VERSION}-slim-bookworm

ARG TZ=UTC
ARG CLAUDE_VERSION=latest
ARG USERNAME=dev
ARG USER_UID=1000
ARG USER_GID=${USER_UID}

ENV DEVCONTAINER=true
ENV TZ=${TZ}
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends \
        git \
        procps \
        sudo \
        fzf \
        zsh \
        man-db \
        unzip \
        gnupg2 \
        curl \
        wget \
        iptables \
        ipset \
        iproute2 \
        dnsutils \
        aggregate \
        jq \
        nano \
        vim \
        ca-certificates \
        nodejs \
        npm \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd --gid ${USER_GID} ${USERNAME} \
    && useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} -s /bin/zsh \
    && echo ${USERNAME} ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/${USERNAME} \
    && chmod 0440 /etc/sudoers.d/${USERNAME}

# Set up bash history persistence
RUN SNIPPET="export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    && mkdir /commandhistory \
    && touch /commandhistory/.bash_history \
    && chown -R ${USERNAME}:${USERNAME} /commandhistory \
    && echo "$SNIPPET" >> /home/${USERNAME}/.bashrc \
    && echo "$SNIPPET" >> /home/${USERNAME}/.zshrc

# Install uv (Python package manager)
ENV UV_LINK_MODE=copy
RUN curl -LsSf https://astral.sh/uv/install.sh | sh \
    && mv /root/.local/bin/uv /usr/local/bin/ \
    && mv /root/.local/bin/uvx /usr/local/bin/ \
    && chmod +x /usr/local/bin/uv /usr/local/bin/uvx

# Install zsh with theme
RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v1.2.1/zsh-in-docker.sh)" -- \
    -t robbyrussell \
    -p git \
    -p fzf

# Create workspace directory
RUN mkdir -p /workspace && chown -R ${USERNAME}:${USERNAME} /workspace

# Install Claude Code globally
RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_VERSION}

# Create Claude config directory
RUN mkdir -p /home/${USERNAME}/.claude && chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.claude

# Copy firewall initialization script
COPY init-firewall.sh /usr/local/bin/init-firewall.sh
RUN chmod +x /usr/local/bin/init-firewall.sh \
    && echo "${USERNAME} ALL=(ALL) NOPASSWD: /usr/local/bin/init-firewall.sh" >> /etc/sudoers.d/${USERNAME}

# Set default editor and shell
ENV EDITOR=nano
ENV SHELL=/bin/zsh

# Switch to non-root user
USER ${USERNAME}

WORKDIR /workspace
'''


DEVCONTAINER_TEMPLATE = '''{{
  "name": "{project_name} Dev",
  "build": {{
    "dockerfile": "Dockerfile",
    "args": {{
      "TZ": "${{localEnv:TZ:UTC}}",
      "CLAUDE_VERSION": "latest",
      "PYTHON_VERSION": "3.12"
    }}
  }},
  "runArgs": [
    "--cap-add=NET_ADMIN",
    "--cap-add=NET_RAW"
  ],
  "remoteUser": "dev",
  "customizations": {{
    "vscode": {{
      "extensions": [
        "anthropic.claude-code",
        "ms-python.python",
        "ms-python.vscode-pylance",
        "charliermarsh.ruff",
        "eamodio.gitlens"
      ],
      "settings": {{
        "terminal.integrated.defaultProfile.linux": "zsh",
        "editor.formatOnSave": true,
        "python.defaultInterpreterPath": "/workspace/.venv/bin/python",
        "[python]": {{
          "editor.defaultFormatter": "charliermarsh.ruff"
        }}
      }}
    }}
  }},
  "containerEnv": {{
    "CLAUDE_CONFIG_DIR": "/home/dev/.claude",
    "ANTHROPIC_API_KEY": "${{localEnv:ANTHROPIC_API_KEY}}",
    "POWERLEVEL9K_DISABLE_GITSTATUS": "true"
  }},
  "mounts": [
    "source={volume_prefix}-bashhistory-${{devcontainerId}},target=/commandhistory,type=volume",
    "source={volume_prefix}-claudeconfig-${{devcontainerId}},target=/home/dev/.claude,type=volume"
  ],
  "workspaceMount": "source=${{localWorkspaceFolder}},target=/workspace,type=bind,consistency=delegated",
  "workspaceFolder": "/workspace",
  "postCreateCommand": "uv sync 2>/dev/null || true",
  "postStartCommand": "sudo /usr/local/bin/init-firewall.sh",
  "waitFor": "postStartCommand"
}}
'''


FIREWALL_TEMPLATE = '''#!/bin/bash
set -euo pipefail
IFS=$'\\n\\t'

# Extract Docker DNS info BEFORE any flushing
DOCKER_DNS_RULES=$(iptables-save -t nat | grep "127\\.0\\.0\\.11" || true)

# Flush existing rules and delete existing ipsets
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
ipset destroy allowed-domains 2>/dev/null || true

# Restore Docker DNS rules
if [ -n "$DOCKER_DNS_RULES" ]; then
    echo "Restoring Docker DNS rules..."
    iptables -t nat -N DOCKER_OUTPUT 2>/dev/null || true
    iptables -t nat -N DOCKER_POSTROUTING 2>/dev/null || true
    echo "$DOCKER_DNS_RULES" | xargs -L 1 iptables -t nat
else
    echo "No Docker DNS rules to restore"
fi

# Allow DNS and localhost before restrictions
iptables -A OUTPUT -p udp --dport 53 -j ACCEPT
iptables -A INPUT -p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Create ipset with CIDR support
ipset create allowed-domains hash:net

# Fetch GitHub IP ranges
echo "Fetching GitHub IP ranges..."
gh_ranges=$(curl -s https://api.github.com/meta)
if [ -z "$gh_ranges" ]; then
    echo "ERROR: Failed to fetch GitHub IP ranges"
    exit 1
fi

if ! echo "$gh_ranges" | jq -e '.web and .api and .git' >/dev/null; then
    echo "ERROR: GitHub API response missing required fields"
    exit 1
fi

echo "Processing GitHub IPs..."
while read -r cidr; do
    if [[ ! "$cidr" =~ ^[0-9]{{1,3}}\\.[0-9]{{1,3}}\\.[0-9]{{1,3}}\\.[0-9]{{1,3}}/[0-9]{{1,2}}$ ]]; then
        echo "ERROR: Invalid CIDR range from GitHub meta: $cidr"
        exit 1
    fi
    echo "Adding GitHub range $cidr"
    ipset add allowed-domains "$cidr"
done < <(echo "$gh_ranges" | jq -r '(.web + .api + .git)[]' | aggregate -q)

# Resolve and add allowed domains
for domain in \\
{domains}; do
    echo "Resolving $domain..."
    ips=$(dig +noall +answer A "$domain" | awk '$4 == "A" {{print $5}}')
    if [ -z "$ips" ]; then
        echo "WARNING: Failed to resolve $domain"
        continue
    fi

    while read -r ip; do
        if [[ ! "$ip" =~ ^[0-9]{{1,3}}\\.[0-9]{{1,3}}\\.[0-9]{{1,3}}\\.[0-9]{{1,3}}$ ]]; then
            echo "ERROR: Invalid IP from DNS for $domain: $ip"
            exit 1
        fi
        echo "Adding $ip for $domain"
        ipset add allowed-domains "$ip" 2>/dev/null || true
    done < <(echo "$ips")
done

# Get host IP from default route
HOST_IP=$(ip route | grep default | cut -d" " -f3)
if [ -z "$HOST_IP" ]; then
    echo "ERROR: Failed to detect host IP"
    exit 1
fi

HOST_NETWORK=$(echo "$HOST_IP" | sed "s/\\.[0-9]*$/.0\\/24/")
echo "Host network detected as: $HOST_NETWORK"

# Set up remaining iptables rules
iptables -A INPUT -s "$HOST_NETWORK" -j ACCEPT
iptables -A OUTPUT -d "$HOST_NETWORK" -j ACCEPT

# Set default policies to DROP
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP

# Allow established connections
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allow outbound to approved IPs
iptables -A OUTPUT -m set --match-set allowed-domains dst -j ACCEPT

# Reject other outbound
iptables -A OUTPUT -j REJECT --reject-with icmp-admin-prohibited

echo "Firewall configuration complete"
echo "Verifying firewall rules..."
if curl --connect-timeout 5 https://example.com >/dev/null 2>&1; then
    echo "ERROR: Firewall verification failed - was able to reach https://example.com"
    exit 1
else
    echo "Firewall verification passed - unable to reach https://example.com as expected"
fi

if ! curl --connect-timeout 5 https://api.github.com/zen >/dev/null 2>&1; then
    echo "ERROR: Firewall verification failed - unable to reach https://api.github.com"
    exit 1
else
    echo "Firewall verification passed - able to reach https://api.github.com as expected"
fi
'''


VSCODE_SETTINGS_TEMPLATE = '''{
  "dev.containers.reopenInContainer": "prompt"
}
'''

# endregion


# region Default Domains

DEFAULT_DOMAINS = [
    "registry.npmjs.org",
    "api.anthropic.com",
    "console.anthropic.com",
    "docs.anthropic.com",
    "sentry.io",
    "statsig.anthropic.com",
    "statsig.com",
    "marketplace.visualstudio.com",
    "vscode.blob.core.windows.net",
    "update.code.visualstudio.com",
    "pypi.org",
    "files.pythonhosted.org",
    "learn.microsoft.com",
    "docs.microsoft.com",
    "developer.mozilla.org",
]

# endregion


# region Functions

def check_prerequisites(console: Console) -> bool:
    """
    Check if Docker and devcontainer CLI are available.

    Returns True if all prerequisites are met, False otherwise.
    """
    all_ok = True

    # Check Docker
    docker_path = shutil.which("docker")
    if docker_path:
        try:
            result = subprocess.run(
                ["docker", "info"],
                capture_output=True,
                timeout=10,
            )
            if result.returncode == 0:
                console.print("[green]Docker:[/green] Available and running")
            else:
                console.print("[yellow]Docker:[/yellow] Installed but not running")
                console.print("  Start Docker Desktop or run: [cyan]open -a Docker[/cyan]")
                all_ok = False
        except subprocess.TimeoutExpired:
            console.print("[yellow]Docker:[/yellow] Timeout checking status")
            all_ok = False
    else:
        console.print("[red]Docker:[/red] Not installed")
        console.print("  Install from: [cyan]https://www.docker.com/products/docker-desktop[/cyan]")
        all_ok = False

    # Check devcontainer CLI
    devcontainer_path = shutil.which("devcontainer")
    if devcontainer_path:
        console.print("[green]devcontainer CLI:[/green] Available")
    else:
        console.print("[yellow]devcontainer CLI:[/yellow] Not installed")
        console.print("  Install with: [cyan]npm install -g @devcontainers/cli[/cyan]")
        # Not a hard requirement - can use VS Code instead

    console.print()
    return all_ok


def run(
    console: Console,
    target_dir: str = ".",
    project_name: str | None = None,
    extra_domains: list[str] | None = None,
    vscode_settings: bool = True,
) -> None:
    """
    Initialize devcontainer setup in target directory.

    Creates .devcontainer/ with:
    - Dockerfile
    - devcontainer.json
    - init-firewall.sh

    Optionally creates .vscode/settings.json for auto-reopen prompt.

    Args:
        console: Rich console for output
        target_dir: Directory to create .devcontainer in (default: current dir)
        project_name: Name for the container (default: directory name)
        extra_domains: Additional domains to whitelist
        vscode_settings: Whether to create .vscode/settings.json
    """
    # Check prerequisites
    if not check_prerequisites(console):
        console.print("[yellow]Warning: Docker is not running. Files will be created but container won't work until Docker is started.[/yellow]")
        console.print()

    target_path = Path(target_dir).resolve()

    if not target_path.exists():
        console.print(f"[red]Error: Target directory does not exist: {target_path}[/red]")
        return

    # Determine project name from directory if not provided
    if project_name is None:
        project_name = target_path.name

    # Sanitize for volume naming (lowercase, alphanumeric + hyphens)
    volume_prefix = "".join(c if c.isalnum() else "-" for c in project_name.lower())
    volume_prefix = "-".join(filter(None, volume_prefix.split("-")))

    # Create .devcontainer directory
    devcontainer_dir = target_path / ".devcontainer"
    devcontainer_dir.mkdir(exist_ok=True)

    # Combine domains
    all_domains = DEFAULT_DOMAINS.copy()
    if extra_domains:
        all_domains.extend(extra_domains)

    # Format domains for shell script
    domains_formatted = " \\\n".join(f'    "{d}"' for d in all_domains)

    # Write Dockerfile
    dockerfile_path = devcontainer_dir / "Dockerfile"
    dockerfile_path.write_text(DOCKERFILE_TEMPLATE)
    console.print(f"[green]Created:[/green] {dockerfile_path}")

    # Write devcontainer.json
    devcontainer_json_path = devcontainer_dir / "devcontainer.json"
    devcontainer_content = DEVCONTAINER_TEMPLATE.format(
        project_name=project_name,
        volume_prefix=volume_prefix,
    )
    devcontainer_json_path.write_text(devcontainer_content)
    console.print(f"[green]Created:[/green] {devcontainer_json_path}")

    # Write init-firewall.sh
    firewall_path = devcontainer_dir / "init-firewall.sh"
    firewall_content = FIREWALL_TEMPLATE.format(domains=domains_formatted)
    firewall_path.write_text(firewall_content)
    firewall_path.chmod(0o755)
    console.print(f"[green]Created:[/green] {firewall_path}")

    # Optionally create .vscode/settings.json
    if vscode_settings:
        vscode_dir = target_path / ".vscode"
        vscode_dir.mkdir(exist_ok=True)
        settings_path = vscode_dir / "settings.json"

        if settings_path.exists():
            console.print(f"[yellow]Skipped:[/yellow] {settings_path} (already exists)")
        else:
            settings_path.write_text(VSCODE_SETTINGS_TEMPLATE)
            console.print(f"[green]Created:[/green] {settings_path}")

    # Print summary
    console.print()
    console.print("[bold green]Devcontainer initialized![/bold green]")
    console.print()
    console.print("Usage:")
    console.print("  [cyan]devcontainer up --workspace-folder .[/cyan]")
    console.print("  [cyan]devcontainer exec --workspace-folder . claude --dangerously-skip-permissions[/cyan]")
    console.print()
    console.print("Or open in VS Code and click 'Reopen in Container'")

# endregion
