import{r as a,j as e,n as p,ae as F,af as O,a5 as P,v as V,B,S as _,aw as K,k as N}from"./material-react-table-CoLKVKmx.js";import{a as I,u as y,bU as $,I as E,bV as q,bd as z,a4 as G,bW as M,V as g,T as v,C as J,aq as W,aA as X,bX as H,as as L,aD as Q,P as Y}from"./index-Bzcp6Isa.js";import{u as w}from"./groupTypes-cgeA4QqK.js";import"./rehype-prism-plus-Ct2a49xA.js";import"./msw-DptHyBtO.js";import"./plotly.js-dist-min-Bl-VrBG9.js";function Z({groupData:s}){const r=I(),{navigate:u}=y(),[d,m]=a.useState(!1),[b,f]=a.useState(""),c=()=>{f(""),m(!0)},l=()=>m(!1),i=async n=>{if(!r){f("API is not available.");return}if(!s?.group_id||n!==s.group_name){f("Group name does not match.");return}try{await r.delete(`groups/${s.group_id}`)&&u({path:"/groups"})}catch{f("An error occurred while deleting the group.")}};return e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"contained",color:"warning",onClick:c,children:"Delete Group"}),e.jsx($,{open:d,content:`To delete the group, write its name (${s?.group_name}) in the text field below.`,onClose:l,onSubmit:i,expectedName:s?.group_name,title:"Delete Group",placeholder:"Group name",error:b})]})}function ee(s){if(s.some(r=>r.user?.name==null))throw new Error("Element without user.name in members_info."+JSON.stringify(s));if(s.some(r=>r.role==null))throw new Error("Element without user.role in members_info.");return s.map(r=>({userId:r.user_id??crypto.randomUUID(),name:r.user.name,affiliation:r.user?.affiliation??"",role:r.role}))??[]}function re({groupData:s,setMembersInfo:r,editable:u=!1}){if(s.members_info==null)throw new Error("members_info in groupData not defined.");const d=a.useMemo(()=>ee(s.members_info),[s]),m=a.useCallback((c,l)=>{r(s.members_info?.map(i=>i.user_id===c?{...i,role:l}:i)??[])},[s,r]);function b(c){const l=()=>{const i=c.getSelectedRowModel().rows.filter(t=>t.getValue("role")!=="owner").map(t=>t.getValue("userId")),n=s.members_info?.filter(t=>!i.includes(t.user_id));r(n??[]),c.resetRowSelection()};return e.jsx(e.Fragment,{children:e.jsx(P,{arrow:!0,title:"Remove selected members",children:e.jsx(V,{onClick:l,color:"inherit",children:e.jsx(z,{})})})})}const f=a.useMemo(()=>[{accessorKey:"name",header:"Name",grow:1},{accessorKey:"userId",header:"User ID",Cell:({cell:c})=>e.jsx(E,{value:c.getValue(),abbreviated:!0}),grow:1},{accessorKey:"affiliation",header:"Affiliation",grow:1},{accessorKey:"role",header:"Role",Cell:({cell:c,row:l})=>{const i=c.getValue(),n=l.original.userId;return i=="owner"?"Owner":u?e.jsx(F,{value:i,onChange:t=>m(n,t.target.value),size:"small",variant:"outlined",children:Object.values(w).filter(t=>!t.disabled).map(t=>e.jsx(O,{value:t.value,children:t.label},t.value))}):w[i]?.label}}],[u,m]);return e.jsx(e.Fragment,{children:e.jsx(q,{columns:f,data:d,toolbarSelectActions:u?b:void 0})})}function se(s,r){return r.members_info?.some(u=>u.user_id==s)}function ne(s){if(s.members_info?.some(r=>!r.user_id))throw new Error("Member without user_id in members_info.");return{group_name:s.group_name,members_info:s.members_info?.map(r=>({user_id:r.user_id,role:r.role}))}}function oe({editable:s=!1}){const{reload:r}=y(),u=I(),d=G(M),[m,b]=a.useState(""),[f,c]=a.useState(!1),[l,i]=a.useState(!1),[n,t]=a.useState(d),[A,j]=a.useState(!1),[C,h]=a.useState(""),R=a.useCallback(()=>{h(""),t(d),j(!1),i(!1),r()},[r,d]),T=a.useCallback(async()=>{if(!u){h("API is not available");return}try{const o=ne(n);await u.post(`groups/${n.group_id}/edit`,o,void 0)&&(h(""),j(!1),i(!1),r())}catch(o){h("An error occurred while saving the group."+(o instanceof Error?o.message:""))}},[u,r,n]),x=a.useCallback((o,S)=>{t(U=>({...U,[o]:S})),j(!0)},[]),k=a.useCallback(o=>{o.info.user_id&&(se(o.info.user_id,n)||x("members_info",[...n.members_info||[],{role:o.role,user:o.info,user_id:o.info.user_id}]))},[n,x]),D=a.useMemo(()=>n.members_info?.map(o=>o.user)??[],[n.members_info]);return e.jsxs(B,{children:[s&&e.jsx(_,{direction:"row",justifyContent:"flex-end",spacing:1,sx:{mb:1},children:l?e.jsxs(e.Fragment,{children:[e.jsx(p,{onClick:R,variant:"contained",children:"Cancel"}),e.jsx(p,{onClick:T,variant:"contained",disabled:!A,children:"Save"})]}):e.jsx(p,{onClick:()=>{i(!0)},variant:"contained",children:"Edit"})}),C&&e.jsx(K,{severity:"error",onClose:()=>{h("")},children:C}),e.jsx(N,{sx:{padding:1,mb:2},children:e.jsxs(_,{direction:"row",justifyContent:"space-between",alignItems:"center",sx:{flexGrow:1},children:[e.jsx(g,{label:"group name",editable:l,onChange:o=>x("group_name",o),value:n.group_name,children:e.jsx(v,{})}),e.jsx(g,{label:"owner",editable:!1,value:n?.owner?.name,children:e.jsx(v,{})}),e.jsx(g,{label:"members",editable:!1,value:n?.members_info?.length||"0",children:e.jsx(v,{})}),e.jsxs(g,{label:"group id",editable:!1,value:n.group_id,children:[e.jsx(E,{abbreviated:!0}),e.jsx(J,{})]})]})}),e.jsx(W,{title:e.jsx(L,{title:"Group members",variant:"h2",sx:{mb:0,mt:0}}),primaryActions:l&&e.jsxs(e.Fragment,{children:[e.jsx(p,{variant:"contained",onClick:()=>c(!0),disabled:!l,children:"Add user"}),e.jsx(H,{open:f,onClose:()=>c(!1),onUserSelected:k,existingUsers:D,roleOptions:w,defaultRole:"member"})]}),search:e.jsx(X,{placeholder:"Search members",value:m,onChange:o=>b(o.target.value),onClear:()=>b("")})}),e.jsx(re,{groupData:n,setMembersInfo:o=>{x("members_info",o)},editable:l}),l&&e.jsx(_,{direction:"row",justifyContent:"flex-end",sx:{mt:1},children:e.jsx(Z,{groupData:n})})]})}function de(){const s=G(M),{user:r}=Q(),u=s?.members_info?.find(m=>m.user_id==r?.profile.sub),d=["owner","maintainer"].includes(u?.role??"");return e.jsx(Y,{children:e.jsx(oe,{editable:d})})}export{de as default};
