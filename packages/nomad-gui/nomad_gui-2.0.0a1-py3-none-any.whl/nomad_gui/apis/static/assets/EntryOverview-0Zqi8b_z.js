import{j as t,ab as E,r as m,B as v,ao as C}from"./material-react-table-B5vcPysv.js";import{d as S,b as _,c as y,j as x,v as R,q as g,w as q,x as f,f as w,y as T,L as k,a as A,o as D,z as j,A as L}from"./index-Ch6wx3XL.js";import{u as P,a as F,L as I,b as B}from"./Layout-BXOkDqUB.js";import{u as M}from"./useDataForRoute-CHohu-wJ.js";import{U as O}from"./UploadMetadataEditor-DaI2cEoK.js";import{E as V}from"./EntryDataEditor-BUx_eUm7.js";import{P as z}from"./ProcessStatus-Bdvktp4U.js";import{L as U}from"./PropertyEditor-CLt9e0xI.js";import{T as W}from"./Id-DVcvTkpi.js";import{E as $}from"./EntrySubSectionTable-Darh7_Dh.js";import"./@mapbox/rehype-prism-vXukC30A.js";import"./msw-CLcXU_4U.js";import"./useLocalState-DdvWN1Wu.js";import"./Visibility-D5hmS0H8.js";import"./CopyToClipboard-pq4dp3BD.js";import"./react-pdf-CcAKyqe7.js";import"./Datetime-C5IF8FhX.js";import"./Select-jE9XnvPH.js";import"./PlainDataTable-Cc0J0n3z.js";import"./ControlledDataTable-DvZXjuQB.js";function G(){const{user:e}=S(),{reload:r}=_(),{entry_id:o}=y(g),{changeStack:a,clearChangeStack:n}=P(),[c,l]=F(async()=>{const i=a.map(u=>{const s={...u},p=u.new_value;return p?.m_def&&(s.new_value={...p},delete s.new_value.m_def),s});x(e,"User must be defined at this point"),await R(o,i,e),n(),r()},[a,n,r]);return t.jsx(E,{onClick:l,variant:"contained",disabled:a.length===0||c.loading,children:c.loading?"saving ...":a.length===0?"no changes to save":"save changes"})}const h={m_request:{directive:"plain",include_definition:"both",exclude:["*"]},m_def:q};function N(e,r){const o=(a,n,c=[])=>{for(const[l,i]of Object.entries(n)){const u=[...c,l];if(f.has(a,l)){const s=a[l];if(f.isObject(s)&&f.isObject(i))o(s,i,u);else if(!f.isEqual(s,i))throw new Error(`Conflicting layout data requests for the same property. Conflict detected at path: ${u.join(".")}`)}}};o(e,r),f.merge(e,r)}function b(e,r){Object.assign(r,h);function o(a,n,c){const l={};let i=l;x(n!==void 0,'Property layout without "property" key.'),n.split(".").forEach((u,s,p)=>{s===p.length-1?i[u]=a:(i[u]===void 0&&(i[u]={...h}),i=i[u])}),N(c,l)}if("children"in e)for(const a of e.children)b(a,r);if((e.type==="quantity"||e.type==="richText"||e.type==="imagePreview"||e.type==="plot")&&(x(!!e.property,"Property layout items must define a property"),o("*",e.property,r)),e.type==="subSection"){const a={...h};b(e.layout,a),o(a,e.property,r)}if(e.type==="table"){const a={...h};o(a,e.property,r),e.columns.forEach(n=>{o("*",n.property,a)})}}function X({data:e}){const r=e.metadata?.datasets||[];x(r!==void 0,"datasets are required");const o=r.map(a=>a.dataset_name);return t.jsx(U,{fullWidth:!0,label:"datasets",placeholder:"no datasets",value:o,renderValue:()=>t.jsx(W,{})})}function Y({editable:e=!1,expandedByDefault:r=!1}){const o=y(g),a=m.useMemo(()=>({type:"card",variant:"highlighted",expandedByDefault:r,collapsedChildren:[{type:"container",variant:"flex",sx:{flexWrap:"wrap",alignItems:"center"},children:[{type:"value",label:"mainfile",grow:!0,value:o.mainfile_path,component:{Text:{actions:"CopyToClipboard"}}},{type:"value",component:{Id:{abbreviated:!0,labelActions:"CopyToClipboard"}},label:"entry id",value:o.entry_id}]}],children:[{type:"container",variant:"flex",sx:{flexWrap:"wrap",alignItems:"center"},children:[{type:"quantity",editable:e,grow:!0,label:"entry name",property:"metadata/entry_name",component:{Text:{variant:"h1",labelActions:t.jsx(z,{entity:o},"status")}}},{type:"value",label:"created at",value:o.entry_create_time,component:{Datetime:{variant:"datetime"}}},{type:"value",label:"last change",value:o.complete_time,component:{Datetime:{variant:"datetime"}}}]},{md:6,editable:!0,type:"quantity",label:"references",placeholder:"no references",property:"metadata/references",component:{List:{valueComponent:{Link:{actions:"CopyToClipboard"}},emptyValue:""}}},{md:6,type:"element",element:t.jsx(X,{data:o})}]}),[e,r,o]);return t.jsx(I,{layout:a})}function H(){const{archive:e}=y(g),[r,o]=m.useState(),a=e?.data?.m_def,{isPage:n}=w(),c=m.useMemo(()=>{let p;const d=a?.m_annotations?.layout;if(Array.isArray(d))p=d[0];else if(d!==void 0)p=d;else return;return{type:"subSection",property:"data",layout:p}},[a]),l=m.useMemo(()=>{const p={archive:{...D,metadata:{entry_name:"*",references:"*"}}};return c&&b(c,p.archive),p},[c]),i=B(),u=m.useCallback((p,d)=>{i.updateArchive(l.archive,p?.archive,d)},[i,l]);M({request:l,onFetch:u,onError:o});let s="";return r?s=t.jsx(j,{error:r}):n&&(c?s=t.jsx(V,{layout:c}):s=t.jsx(j,{error:new Error("No layout defined")})),t.jsxs(t.Fragment,{children:[t.jsx(v,{sx:{marginBottom:2},children:t.jsx(O,{})}),t.jsx(v,{sx:{marginBottom:4},children:t.jsx(Y,{editable:n,expandedByDefault:n})}),s]})}function he(){const{url:e}=_(),{upload_id:r,mainfile_path:o}=y(g),{isPage:a,isSelect:n}=w(),c=y(L),{isScrolled:l}=T(),i=t.jsxs(v,{display:"flex",alignItems:"center",flexDirection:"row",gap:1,children:[t.jsx(G,{}),t.jsx(E,{variant:"contained",component:k,to:e({path:`/uploads/${r}/files/${o}`}),endIcon:t.jsx(C,{}),children:"Go to File"})]}),u=m.useMemo(()=>t.jsxs(t.Fragment,{children:[t.jsx(v,{sx:{marginTop:-1},children:t.jsx(H,{})}),n&&t.jsx($,{data:c})]}),[n,c]);return t.jsxs(t.Fragment,{children:[a&&t.jsx(A,{sx:{position:"sticky",top:0,marginTop:-1,marginX:-2,paddingX:2,paddingY:1,background:s=>s.palette.background.default,zIndex:s=>s.zIndex.appBar,...l?{borderBottom:"1px solid",borderColor:s=>s.palette.divider}:{}},actions:i}),u]})}export{he as default};
