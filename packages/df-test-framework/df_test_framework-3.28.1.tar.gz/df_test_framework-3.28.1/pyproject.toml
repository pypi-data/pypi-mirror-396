[project]
name = "df-test-framework"
version = "3.28.1"
description = "基于交互模式的现代化测试自动化框架，支持多种测试场景"
authors = [{name = "DF QA Team", email = "qa@example.com"}]
readme = "README_PYPI.md"
requires-python = ">=3.12"
license = {text = "MIT"}
keywords = ["testing", "automation", "api", "ui", "pytest", "framework"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Software Development :: Testing",
    "Topic :: Software Development :: Quality Assurance",
    "Framework :: Pytest",
]

dependencies = [
    # 核心测试依赖
    "pytest>=9.0.1",
    "pytest-timeout>=2.2.0",
    "pytest-asyncio>=1.3.0",  # 异步测试支持
    "allure-pytest>=2.13.0",
    "assertpy>=1.1",

    # HTTP 客户端
    "httpx>=0.27.0",
    "h2>=4.3.0",           # HTTP/2 协议支持 (AsyncHttpClient)
    "hpack>=4.1.0",        # HTTP/2 头部压缩
    "hyperframe>=6.1.0",   # HTTP/2 帧解析

    # 配置与验证
    "pydantic>=2.0.0",
    "pydantic-settings>=2.0.0",
    "python-dotenv>=1.0.0",
    "jsonschema>=4.25.1",
    "jsonschema-spec>=0.2.4",

    # 数据库
    "sqlalchemy>=2.0.0",
    "pymysql>=1.1.0",
    "redis>=5.0.0",

    # 工具库
    "loguru>=0.7.0",
    "openpyxl>=3.1.0",
    "faker>=38.2.0",
    "pluggy>=1.5.0",
    "questionary>=2.0.0",  # 交互式命令行工具
    "prance[osv]>=23.6.0", # OpenAPI/Swagger 解析器
    "pyyaml>=6.0.0",       # YAML 支持（OpenAPI 规范）
]

[project.urls]
Homepage = "https://github.com/yourorg/df-test-framework"
Repository = "https://github.com/yourorg/df-test-framework"
Documentation = "https://github.com/yourorg/df-test-framework#readme"
"Bug Tracker" = "https://github.com/yourorg/df-test-framework/issues"

[project.optional-dependencies]
ui = [
    "playwright>=1.40.0",
    "selenium>=4.0.0",
]
kafka = [
    "confluent-kafka>=2.12.0",  # Kafka客户端 - 最新版本，提供 Windows 预编译 wheel
]
rabbitmq = [
    "pika>=1.3.0",  # RabbitMQ客户端
]
rocketmq = [
    "rocketmq-python-client>=5.0.0",  # RocketMQ客户端
]
mq = [
    "confluent-kafka>=2.12.0",
    "pika>=1.3.0",
    "rocketmq-python-client>=5.0.0",
]
# v3.10.0 新增依赖组
opentelemetry = [
    "opentelemetry-api>=1.20.0",  # OpenTelemetry API
    "opentelemetry-sdk>=1.20.0",  # OpenTelemetry SDK
    "opentelemetry-instrumentation-httpx>=0.41b0",  # HTTPX 自动埋点
]
prometheus = [
    "prometheus-client>=0.19.0",  # Prometheus 指标客户端
]
storage = [
    "boto3>=1.34.0",  # AWS S3 客户端（也支持 MinIO）
    "oss2>=2.18.0",  # 阿里云 OSS 客户端
]
observability = [
    "opentelemetry-api>=1.20.0",
    "opentelemetry-sdk>=1.20.0",
    "opentelemetry-instrumentation-httpx>=0.41b0",
    "prometheus-client>=0.19.0",
]
all = [
    # UI 测试
    "playwright>=1.40.0",
    "selenium>=4.0.0",
    # 消息队列
    "confluent-kafka>=2.12.0",
    "pika>=1.3.0",
    "rocketmq-python-client>=5.0.0",
    # 可观测性
    "opentelemetry-api>=1.20.0",
    "opentelemetry-sdk>=1.20.0",
    "opentelemetry-instrumentation-httpx>=0.41b0",
    "prometheus-client>=0.19.0",
    # 存储客户端
    "boto3>=1.34.0",
    "oss2>=2.18.0",
]

# uv dependency groups (用于 uv sync)
[dependency-groups]
dev = [
    "ruff>=0.1.0",
    "mypy>=1.7.0",
    "pytest-cov>=4.1.0",
    "pytest-xdist>=3.5.0",
    "pytest-mock>=3.12.0",
    "pre-commit>=3.6.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["src/df_test_framework"]

[tool.ruff]
line-length = 100
target-version = "py312"
exclude = [
    ".git",
    ".venv",
    "__pycache__",
    "*.pyc",
]

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W", "UP"]
ignore = [
    "E501",  # 行长度限制
    "N818",  # 异常命名规范 - MockResponse 是携带数据的异常，不需要 Error 后缀
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
addopts = [
    "-v",
    "--strict-markers",
    "--tb=short",
]
markers = [
    "unit: 单元测试 - 独立模块功能测试",
    "smoke: 冒烟测试 - 核心功能快速验证",
    "regression: 回归测试 - 完整功能验证",
    "integration: 集成测试 - 多模块协作测试",
    "e2e: 端到端测试 - 完整业务流程测试",
    "slow: 慢速测试 - 执行时间较长的测试",
    "performance: 性能测试 - 性能指标验证",
    "asyncio: 异步测试 - 使用 async/await 的测试",
    "keep_data: 保留此测试的所有数据（调试用）。UoW 数据不回滚，API 数据不清理。",
    "debug: 调试模式 - 强制启用控制台调试输出（HTTP/DB 详情）。",
]
timeout = 30
timeout_method = "thread"
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
# 限制conftest.py查找到当前目录，防止加载父目录的conftest.py
norecursedirs = [".git", ".tox", "dist", "build", "*.egg"]
# 过滤掉已知的无害警告
filterwarnings = [
    # 忽略allure fixture的断言重写警告（通过pytest_plugins加载导致的技术性警告）
    "ignore:Module already imported so cannot be rewritten.*allure:pytest.PytestAssertRewriteWarning",
    # 忽略第三方库 oss2 的无效转义序列警告（库本身的问题，不影响功能）
    "ignore:invalid escape sequence.*:SyntaxWarning",
]

[tool.coverage.run]
source = ["src/df_test_framework"]
omit = [
    "*/tests/*",
    "*/__init__.py",
    "*/conftest.py",
]
branch = true

[tool.coverage.report]
fail_under = 80
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
]

[tool.coverage.html]
directory = "reports/coverage"

[tool.mypy]
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false

# Bandit 安全扫描配置
[tool.bandit]
exclude_dirs = ["tests", "docs", "examples"]
skips = [
    "B101",  # assert_used - 测试框架需要使用 assert
    "B311",  # random - 测试数据生成使用伪随机是可接受的
]

# Commitizen 提交信息规范
[tool.commitizen]
name = "cz_conventional_commits"
version = "3.10.0"
version_files = [
    "src/df_test_framework/__init__.py:__version__",
    "pyproject.toml:version",
]
tag_format = "v$version"
update_changelog_on_bump = false

[project.scripts]
df-test = "df_test_framework.cli:main"
