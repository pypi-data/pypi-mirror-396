import os
import re
import json
import httpx

def get_pr_number():
    """Extract PR number from GITHUB_REF (refs/pull/123/merge)."""
    ref = os.getenv("GITHUB_REF", "")
    match = re.search(r"refs/pull/(\d+)/", ref)
    return match.group(1) if match else None

def post_github_comment(issues, ai_fixes, report_path):
    """
    Posts a summary comment to the Pull Request.
    """
    token = os.getenv("GITHUB_TOKEN")
    repo = os.getenv("GITHUB_REPOSITORY")  # "owner/repo"
    pr_num = get_pr_number()

    if not token or not repo or not pr_num:
        print("[WARN] Cannot post PR comment: Missing GITHUB_TOKEN or not a PR.")
        return

    # 1. Construct Markdown Body
    critical_count = sum(1 for i in issues if i.get('severity') == 'critical')
    
    body = f"## ðŸ›¡ï¸ Refactoring Agent Report\n\n"
    body += f"Found **{len(issues)}** issues (**{critical_count}** Critical).\n\n"
    
    if issues:
        body += "| Severity | File | Message |\n"
        body += "| :--- | :--- | :--- |\n"
        for i in issues[:10]: # Limit to 10 to avoid spam
            emoji = "ðŸ”´" if i.get('severity') == 'critical' else "ðŸ”¸"
            body += f"| {emoji} {i.get('severity', 'minor')} | `{i['file']}:{i['line']}` | {i['message']} |\n"
        
        if len(issues) > 10:
            body += f"| ... | ... | *...and {len(issues)-10} more* |\n"

    # 2. Add AI Fixes (if any were generated during scan)
    # For now, we assume ai_fixes is a dict: {filepath: fixed_code}
    if ai_fixes:
        body += "\n### ðŸ¤– AI Suggested Fixes\n"
        body += "I have analyzing the blocking issues and proposed the following changes:\n\n"
        for fpath, code in list(ai_fixes.items())[:3]: # Limit huge comments
            body += f"<details><summary><b>Fix for {fpath}</b></summary>\n\n"
            body += f"```python\n{code}\n```\n"
            body += "</details>\n"

    body += "\n---\n*Generated by [Refactoring Agent](https://github.com/StasLee1982/refactoring-agent)*"

    # 3. Send Request
    url = f"https://api.github.com/repos/{repo}/issues/{pr_num}/comments"
    headers = {
        "Authorization": f"Bearer {token}",
        "Accept": "application/vnd.github.v3+json"
    }
    
    try:
        resp = httpx.post(url, json={"body": body}, headers=headers)
        if resp.status_code == 201:
            print("[SUCCESS] Posted PR comment.")
        else:
            print(f"[ERROR] Failed to post comment: {resp.text}")
    except Exception as e:
        print(f"[ERROR] GitHub API error: {e}")

def print_github_annotation(issue):
    """
    Prints GitHub Actions workflow command to create inline annotation.
    Format: ::error file={name},line={line}::{message}
    """
    severity_map = {"critical": "error", "major": "warning", "minor": "notice"}
    level = severity_map.get(issue.get('severity'), "warning")
    
    # Clean message for single line
    msg = issue['message'].replace("\n", " ")
    print(f"::{level} file={issue['file']},line={issue['line']}::{msg}")
