services:
    redis:
        image: redis:8
        restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
        volumes:
            - redis_data:/data
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli ping | grep PONG']
            interval: 5s
            timeout: 5s
            retries: 5
        networks:
            - hermesnet

    prefect-postgres:
        image: postgres:18.0
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=${PREFECT_PASSWORD:-prefect}
            - POSTGRES_DB=prefect
        restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
        ports:
            - ${PREFECT_PORT:-5433}:5432
        volumes:
            - prefectdb:/var/lib/postgresql
            - ./hermes/datamodel/alembic/init-prefect-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 5s
            timeout: 5s
            retries: 5
        networks:
            - hermesnet

    prefect-server:
        image: prefecthq/prefect:3.5-python3.14
        environment:
            - PREFECT_SERVER_API_HOST=0.0.0.0
            - PREFECT_UI_API_URL=${PREFECT_API_URL:-http://localhost:4200/api}
            - PREFECT_API_DATABASE_CONNECTION_URL=postgresql+asyncpg://postgres:${PREFECT_PASSWORD:-prefect}@prefect-postgres:5432/prefect
            - PREFECT_MESSAGING_BROKER=prefect_redis.messaging
            - PREFECT_MESSAGING_CACHE=prefect_redis.messaging
            - PREFECT_REDIS_MESSAGING_HOST=redis
            - PREFECT_REDIS_MESSAGING_PORT=6379
            - PREFECT_REDIS_MESSAGING_DB=0
        restart: ${DOCKER_RESTART_POLICY:-unless-stopped}
        ports:
            - 4200:4200
        depends_on:
            prefect-postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        command: prefect server start
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'python -c "import urllib.request; urllib.request.urlopen(\"http://localhost:4200/api/health\", timeout=5)"',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        networks:
            - hermesnet

volumes:
    prefectdb: {}
    redis_data: {}
networks:
    hermesnet: {}
