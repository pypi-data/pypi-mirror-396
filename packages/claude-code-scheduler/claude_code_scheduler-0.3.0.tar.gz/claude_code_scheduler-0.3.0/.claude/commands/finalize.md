---
description: Move winning candidate to final location and cleanup
arguments:
  - name: winner_path
    description: Path to winning candidate directory
  - name: destination
    description: Final destination path
  - name: commit
    description: Auto-commit changes (default: false)
    default: "false"
---

# Finalize

Move the selected winner to its final location and clean up temporary files.

## Input

- Winner path: $ARGUMENTS.winner_path
- Destination: $ARGUMENTS.destination
- Auto-commit: $ARGUMENTS.commit

## Process

### Step 1: Validate Winner

```bash
# Check winner exists
if [ ! -d "$ARGUMENTS.winner_path" ]; then
    echo "ERROR: Winner path does not exist: $ARGUMENTS.winner_path"
    exit 1
fi

# Check for Python files
PY_FILES=$(find $ARGUMENTS.winner_path -name "*.py" 2>/dev/null)
if [ -z "$PY_FILES" ]; then
    echo "ERROR: No Python files found in winner"
    exit 1
fi

echo "Winner: $ARGUMENTS.winner_path"
echo "Files:"
ls -la $ARGUMENTS.winner_path
```

### Step 2: Final QC Check

```bash
echo ""
echo "Running final QC..."

cd $ARGUMENTS.winner_path

LINT_PASS=false
if make lint 2>&1; then
    LINT_PASS=true
    echo "âœ“ Lint: PASS"
else
    echo "âœ— Lint: FAIL"
fi

TYPE_PASS=false
if make typecheck 2>&1; then
    TYPE_PASS=true
    echo "âœ“ Typecheck: PASS"
else
    echo "âœ— Typecheck: FAIL"
fi

cd - > /dev/null

if [ "$LINT_PASS" = "false" ] || [ "$TYPE_PASS" = "false" ]; then
    echo ""
    echo "WARNING: Winner does not pass QC!"
    echo "Proceed anyway? [y/N]"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
        echo "Aborted."
        exit 1
    fi
fi
```

### Step 3: Copy to Destination

```bash
echo ""
echo "Copying to destination..."

# Create destination directory if needed
mkdir -p $(dirname $ARGUMENTS.destination)

# Determine copy strategy
if [ -f "$ARGUMENTS.winner_path" ]; then
    # Single file
    cp "$ARGUMENTS.winner_path" "$ARGUMENTS.destination"
    echo "Copied file: $ARGUMENTS.destination"
else
    # Directory - copy contents
    if [ -f "$ARGUMENTS.destination" ]; then
        # Destination is a file, copy matching file
        WINNER_FILE=$(find $ARGUMENTS.winner_path -name "*.py" | head -1)
        cp "$WINNER_FILE" "$ARGUMENTS.destination"
        echo "Copied: $WINNER_FILE â†’ $ARGUMENTS.destination"
    else
        # Destination is directory
        cp -r $ARGUMENTS.winner_path/* $(dirname $ARGUMENTS.destination)/
        echo "Copied directory contents to: $(dirname $ARGUMENTS.destination)/"
    fi
fi
```

### Step 4: Cleanup Candidates

```bash
echo ""
echo "Cleaning up..."

# Find candidates root (parent of task_* directories)
CANDIDATES_ROOT=$(dirname $(dirname $ARGUMENTS.winner_path))

if [ -d "$CANDIDATES_ROOT/task_" ] || [ "$(basename $CANDIDATES_ROOT)" = "candidates" ]; then
    CANDIDATES_ROOT=$(dirname $ARGUMENTS.winner_path)
    CANDIDATES_ROOT=$(dirname $CANDIDATES_ROOT)
fi

# Safety check
if [[ "$CANDIDATES_ROOT" == *"candidates"* ]]; then
    rm -rf "$CANDIDATES_ROOT"
    echo "Removed: $CANDIDATES_ROOT"
else
    echo "WARNING: Not removing $CANDIDATES_ROOT (doesn't look like candidates dir)"
fi

# Cleanup QC results
rm -f ./candidates/qc_results.json 2>/dev/null
```

### Step 5: Cleanup Scheduler Tasks

```bash
echo ""
echo "Cleaning up scheduler tasks..."

# Get all temporary worker tasks
TEMP_TASKS=$(curl -s http://127.0.0.1:5679/api/tasks | \
    jq -r '.tasks[] | select(.name | test("^worker-|^retry-attempt-")) | .id')

for TASK_ID in $TEMP_TASKS; do
    curl -s -X DELETE http://127.0.0.1:5679/api/tasks/$TASK_ID > /dev/null
    echo "  Deleted task: $TASK_ID"
done

DELETED_COUNT=$(echo "$TEMP_TASKS" | wc -l | tr -d ' ')
echo "Deleted $DELETED_COUNT temporary tasks"
```

### Step 6: Update Job Status (if job.json exists)

```bash
if [ -f "./job.json" ]; then
    echo ""
    echo "Updating job status..."

    jq '.status = "completed" | .completed_at = "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"' \
        job.json > job.json.tmp && mv job.json.tmp job.json

    echo "Job marked as completed"
fi
```

### Step 7: Optional Git Commit

```bash
if [ "$ARGUMENTS.commit" = "true" ]; then
    echo ""
    echo "Committing changes..."

    git add $ARGUMENTS.destination
    git add job.json 2>/dev/null || true

    COMMIT_MSG="Add $(basename $ARGUMENTS.destination) via redundant workers

Generated by claude-code-scheduler orchestration.
Winner selected from $(ls -d $CANDIDATES_ROOT/*/worker_*/ 2>/dev/null | wc -l | tr -d ' ') candidates.

ğŸ¤– Generated with Claude Code"

    git commit -m "$COMMIT_MSG"
    echo "Committed: $(git log -1 --oneline)"
fi
```

### Step 8: Summary

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  FINALIZATION COMPLETE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Winner: $ARGUMENTS.winner_path
  Destination: $ARGUMENTS.destination

  Actions completed:
    âœ“ Final QC check
    âœ“ Copied to destination
    âœ“ Cleaned up candidates/
    âœ“ Removed temporary scheduler tasks
    âœ“ Updated job.json status
    $( [ "$ARGUMENTS.commit" = "true" ] && echo "âœ“ Committed to git" || echo "â—‹ Git commit skipped" )

  Next steps:
    1. Run full test suite: make test
    2. Review the generated code
    3. $( [ "$ARGUMENTS.commit" != "true" ] && echo "Commit changes: git add . && git commit" || echo "Push changes: git push" )
```

## Example Usage

```bash
# Basic finalize
/finalize candidates/task_1/worker_3 claude_code_scheduler/cli_jobs.py

# With auto-commit
/finalize candidates/task_1/worker_3 claude_code_scheduler/cli_jobs.py --commit true

# Finalize directory
/finalize candidates/task_2/worker_1 claude_code_scheduler/ui/panels/
```
