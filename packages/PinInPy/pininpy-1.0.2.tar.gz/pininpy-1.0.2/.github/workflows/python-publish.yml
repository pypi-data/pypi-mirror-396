# This workflow will upload a Python Package to PyPI when a release is created
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python#publishing-to-package-registries

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Upload Python Package

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  release-build:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # scikit-build-core 完美支持这三大平台
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive 

      - uses: actions/setup-python@v6
        with:
          python-version: "3.x"
          
      - name: Install generic dependencies
        run: pip install cmake ninja

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_BUILD_VERBOSITY: "TRUE"
          -DBUILD_SHARED_LIBS=ON: "ON"

      - uses: actions/upload-artifact@v6
        with:
          name: cibw-wheels-${{ matrix.os }}-${{ strategy.job-index }}
          path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Install build dependencies
        run: python -m pip install build

      - name: Build sdist
        run: python -m build --sdist

      # 【关键步骤 1B】: 上传源码包
      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: dist/*.tar.gz

  publish_to_pypi:
    name: Publish package to PyPI
    # 必须等待所有构建任务成功完成
    needs: [release-build, build_sdist]
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # 这是必须的，允许 workflow 向 PyPI 进行身份验证
      contents: read

    steps:
      # 【关键步骤 2】: 下载所有之前上传的工件
      # 首先下载所有 wheel 文件到一个临时目录
      - name: Download all wheels
        uses: actions/download-artifact@v6
        with:
          # 使用通配符匹配所有以 cibw-wheels- 开头的工件
          pattern: cibw-wheels-*
          # 将它们合并到同一个目录下
          merge-multiple: true
          # 指定下载到 dist 目录
          path: dist/
      
      # 接着下载源码包
      - name: Download sdist
        uses: actions/download-artifact@v6
        with:
          name: sdist
          path: dist/

      # 现在，dist/ 目录里已经包含了所有的 .whl 和 .tar.gz 文件
      # 最后执行发布
      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
